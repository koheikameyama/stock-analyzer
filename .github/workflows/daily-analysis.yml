name: Daily Stock Analysis

on:
  # 毎日UTC 9:00（日本時間 18:00）に自動実行
  schedule:
    - cron: '0 9 * * *'

  # プッシュ時のテスト実行（mainブランチのみ）
  push:
    branches:
      - main
    paths:
      - '.github/workflows/daily-analysis.yml'

  # 手動実行も可能
  workflow_dispatch:
    inputs:
      force:
        description: '強制再実行（既存データを無視）'
        required: false
        type: boolean
        default: false

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          cd batch
          pip install -r requirements.txt

      - name: Run stock analysis
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          cd batch
          if [ "${{ github.event.inputs.force }}" = "true" ]; then
            python batch_analysis.py --force
          else
            python batch_analysis.py
          fi

      - name: Send push notification
        if: success()
        continue-on-error: true
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL }}
        run: |
          cd batch
          python send_daily_notification.py

      - name: Upload logs (if failed)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: analysis-logs
          path: |
            *.log
          retention-days: 7

      - name: Notify success to Slack
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_DAILY_ANALYSIS_WEBHOOK_URL }}
        run: |
          TIMESTAMP=$(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          MESSAGE="{
            \"text\": \"✅ Daily Stock Analysis 成功\",
            \"blocks\": [
              {
                \"type\": \"header\",
                \"text\": {
                  \"type\": \"plain_text\",
                  \"text\": \"✅ Daily Stock Analysis 成功\"
                }
              },
              {
                \"type\": \"section\",
                \"fields\": [
                  {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*実行時刻:*\n${TIMESTAMP}\"
                  },
                  {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*ブランチ:*\n\`${{ github.ref_name }}\`\"
                  }
                ]
              },
              {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"<${WORKFLOW_URL}|ワークフロー実行ログを見る>\"
                }
              }
            ]
          }"

          curl -X POST -H 'Content-type: application/json' \
            --data "$MESSAGE" \
            "$SLACK_WEBHOOK_URL"

      - name: Notify failure to Slack
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_DAILY_ANALYSIS_WEBHOOK_URL }}
        run: |
          TIMESTAMP=$(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          MESSAGE="{
            \"text\": \"❌ Daily Stock Analysis 失敗\",
            \"blocks\": [
              {
                \"type\": \"header\",
                \"text\": {
                  \"type\": \"plain_text\",
                  \"text\": \"❌ Daily Stock Analysis 失敗\"
                }
              },
              {
                \"type\": \"section\",
                \"fields\": [
                  {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*実行時刻:*\n${TIMESTAMP}\"
                  },
                  {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*ブランチ:*\n\`${{ github.ref_name }}\`\"
                  }
                ]
              },
              {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"<!channel> エラーが発生しました。<${WORKFLOW_URL}|ワークフロー実行ログ>を確認してください。\"
                }
              }
            ]
          }"

          curl -X POST -H 'Content-type: application/json' \
            --data "$MESSAGE" \
            "$SLACK_WEBHOOK_URL"
