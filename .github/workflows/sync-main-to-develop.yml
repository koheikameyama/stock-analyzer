name: Sync main to develop

on:
  push:
    branches:
      - main

jobs:
  sync:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Check if develop needs sync
        id: check_sync
        run: |
          # developã¨mainã®å·®åˆ†ã‚’ç¢ºèª
          git fetch origin develop
          DIFF_COUNT=$(git rev-list --count develop..main)

          if [ "$DIFF_COUNT" -eq 0 ]; then
            echo "No changes to sync"
            echo "needs_sync=false" >> $GITHUB_OUTPUT
          else
            echo "Found $DIFF_COUNT commits to sync"
            echo "needs_sync=true" >> $GITHUB_OUTPUT
          fi

      - name: Create sync PR
        if: steps.check_sync.outputs.needs_sync == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # æ—¢å­˜ã®åŒæœŸPRãŒãªã„ã‹ç¢ºèª
          EXISTING_PR=$(gh pr list --base develop --head main --state open --json number --jq '.[0].number' || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "Sync PR already exists: #$EXISTING_PR"
            exit 0
          fi

          # PRã‚’ä½œæˆ
          gh pr create \
            --base develop \
            --head main \
            --title "chore: Sync main to develop" \
            --body "## main â†’ develop åŒæœŸPR

          ã“ã®PRã¯mainã¸ã®pushæ™‚ã«è‡ªå‹•ä½œæˆã•ã‚Œã¾ã™ã€‚

          mainã®å¤‰æ›´ã‚’developã«åŒæœŸã—ã¾ã™ã€‚

          ðŸ¤– This PR is automatically generated by GitHub Actions"

          echo "Created sync PR"

      - name: Summary
        if: always()
        run: |
          echo "### ðŸ”„ Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_sync.outputs.needs_sync }}" == "false" ]; then
            echo "â„¹ï¸ **No Sync Needed**: develop is already up to date with main" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Sync PR Created**: main â†’ develop" >> $GITHUB_STEP_SUMMARY
          fi
