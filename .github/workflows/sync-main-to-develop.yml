name: Sync main to develop

on:
  push:
    branches:
      - main

jobs:
  sync:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—

      - name: Check for differences
        id: check_diff
        run: |
          # main ã¨ develop ã®å·®åˆ†ã‚’ç¢ºèª
          git fetch origin develop

          # ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ã®å·®åˆ†ã‚’ãƒã‚§ãƒƒã‚¯
          COMMIT_DIFF=$(git log --oneline origin/develop..origin/main | wc -l)

          if [ "$COMMIT_DIFF" -eq 0 ]; then
            echo "has_diff=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No differences between main and develop"
          else
            echo "has_diff=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ ${COMMIT_DIFF} commits found in main that are not in develop:"
            git log --oneline origin/develop..origin/main
          fi

      - name: Create or update sync PR
        if: steps.check_diff.outputs.has_diff == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # æ—¢å­˜ã®mainâ†’develop PRã‚’ç¢ºèª
          EXISTING_PR=$(gh pr list --head main --base develop --state open --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -n "$EXISTING_PR" ] && [ "$EXISTING_PR" != "null" ]; then
            echo "ðŸ“‹ Sync PR #$EXISTING_PR already exists"
            echo "Merging existing PR..."
            gh pr merge $EXISTING_PR --merge --auto
            echo "âœ… Merged PR #$EXISTING_PR"
          else
            echo "ðŸ“ Creating new sync PR: main â†’ develop"

            # æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
            LATEST_COMMIT_MSG=$(git log -1 --pretty=format:"%s")

            # PRæœ¬æ–‡ã‚’ä½œæˆ
            PR_BODY="## ðŸ”„ è‡ªå‹•åŒæœŸ

mainãƒ–ãƒ©ãƒ³ãƒã®å¤‰æ›´ã‚’developãƒ–ãƒ©ãƒ³ãƒã«åŒæœŸã—ã¾ã™ã€‚

### æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆ
${LATEST_COMMIT_MSG}

---
*ã“ã®PRã¯è‡ªå‹•çš„ã«ä½œæˆã•ã‚Œã¾ã—ãŸ*"

            # PRã‚’ä½œæˆ
            gh pr create \
              --base develop \
              --head main \
              --title "chore: Sync main to develop" \
              --body "$PR_BODY" || {
              echo "âš ï¸ PRä½œæˆã«å¤±æ•—ï¼ˆæ—¢ã«å­˜åœ¨ã™ã‚‹å¯èƒ½æ€§ï¼‰"
              exit 0
            }

            # ä½œæˆã•ã‚ŒãŸPRã‚’å–å¾—ã—ã¦ãƒžãƒ¼ã‚¸
            SYNC_PR=$(gh pr list --head main --base develop --state open --json number --jq '.[0].number' 2>/dev/null || echo "")
            if [ -n "$SYNC_PR" ] && [ "$SYNC_PR" != "null" ]; then
              echo "âœ… Created PR #$SYNC_PR"
              gh pr merge $SYNC_PR --merge --auto
              echo "âœ… Auto-merge enabled for PR #$SYNC_PR"
            else
              echo "âš ï¸ Could not find created PR"
            fi
          fi

      - name: Summary
        if: always()
        run: |
          echo "### ðŸ”„ Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_diff.outputs.has_diff }}" == "true" ]; then
            echo "âœ… **Synced**: main â†’ develop" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **No changes**: main and develop are already in sync" >> $GITHUB_STEP_SUMMARY
          fi
