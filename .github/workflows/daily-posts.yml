name: Daily X Posts

on:
  # æ¯æ—¥3å›å®Ÿè¡Œï¼ˆãŸã ã—æœˆæ›œã®æ˜¼ã¯weekly-summaryãŒå®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚é™¤å¤–ï¼‰
  schedule:
    # æœ 7:00 JST (UTC 22:00å‰æ—¥) - æ¯æ—¥
    - cron: '0 22 * * *'
    # æ˜¼ 12:00 JST (UTC 3:00) - ç«ã€œæ—¥ã®ã¿ï¼ˆæœˆæ›œã¯weekly-summaryï¼‰
    - cron: '0 3 * * 2-7'
    # å¤œ 18:00 JST (UTC 9:00) - æ¯æ—¥
    - cron: '0 9 * * *'

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      post_type:
        description: 'æŠ•ç¨¿ã‚¿ã‚¤ãƒ— (morning/noon/evening)'
        required: true
        default: 'noon'
        type: choice
        options:
          - morning
          - noon
          - evening

jobs:
  generate-post:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          cd batch
          pip install psycopg2-binary requests python-dotenv

      - name: Determine post type
        id: post_type
        run: |
          # æ‰‹å‹•å®Ÿè¡Œã®å ´åˆã¯å…¥åŠ›å€¤ã‚’ä½¿ç”¨
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "type=${{ github.event.inputs.post_type }}" >> $GITHUB_OUTPUT
          else
            # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œã®å ´åˆã¯æ™‚åˆ»ã‹ã‚‰åˆ¤å®š
            hour=$(date -u +%H)
            if [ "$hour" = "22" ]; then
              echo "type=morning" >> $GITHUB_OUTPUT
            elif [ "$hour" = "03" ]; then
              echo "type=noon" >> $GITHUB_OUTPUT
            elif [ "$hour" = "09" ]; then
              echo "type=evening" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Generate morning post (å¸‚æ³ã‚µãƒãƒªãƒ¼)
        if: steps.post_type.outputs.type == 'morning'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          cd batch
          python -c "
          import os
          import requests
          import json
          from datetime import datetime

          message = '''ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™â˜€ï¸

ã€ä»Šæœã®æ—¥æœ¬æ ªã€‘
æ—¥çµŒå¹³å‡: (æ‰‹å‹•æ›´æ–°)
TOPIX: (æ‰‹å‹•æ›´æ–°)

ç±³å›½å¸‚å ´ã®å½±éŸ¿ã§(æ‰‹å‹•æ›´æ–°)ã®è¦‹è¾¼ã¿ã€‚
ä»Šæ—¥ã¯(æ‰‹å‹•æ›´æ–°)ã‚»ã‚¯ã‚¿ãƒ¼ã«æ³¨ç›®ğŸ“Š

#æ—¥æœ¬æ ª #æ ªå¼æŠ•è³‡ #æœã®å¸‚æ³'''

          payload = {
              'text': 'ğŸ“¢ *æœã®æŠ•ç¨¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ*\n\nä»¥ä¸‹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦Xã«æŠ•ç¨¿ã—ã¦ãã ã•ã„ğŸ‘‡\n\n\`\`\`\n' + message + '\n\`\`\`',
              'username': 'Stock Analyzer Bot',
              'icon_emoji': ':chart_with_upwards_trend:'
          }

          response = requests.post(
              os.getenv('SLACK_WEBHOOK_URL'),
              data=json.dumps(payload),
              headers={'Content-Type': 'application/json'}
          )

          print('âœ… Slackã¸ã®é€ä¿¡æˆåŠŸ' if response.status_code == 200 else f'âŒ å¤±æ•—: {response.status_code}')
          "

      - name: Generate noon post (ãŠã™ã™ã‚éŠ˜æŸ„)
        if: steps.post_type.outputs.type == 'noon'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          cd batch
          python daily_top_picks.py

      - name: Generate evening post (å¸‚æ³æŒ¯ã‚Šè¿”ã‚Š)
        if: steps.post_type.outputs.type == 'evening'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          cd batch
          python -c "
          import os
          import requests
          import json
          from datetime import datetime

          message = '''æœ¬æ—¥ã®ç›¸å ´ã¾ã¨ã‚ğŸ“

æ—¥çµŒå¹³å‡: (æ‰‹å‹•æ›´æ–°)
å€¤ä¸ŠãŒã‚Š: (æ‰‹å‹•æ›´æ–°)éŠ˜æŸ„
å€¤ä¸‹ãŒã‚Š: (æ‰‹å‹•æ›´æ–°)éŠ˜æŸ„

âœ… (æ‰‹å‹•æ›´æ–°)ã‚»ã‚¯ã‚¿ãƒ¼ãŒå …èª¿
âš ï¸ (æ‰‹å‹•æ›´æ–°)ã¯è»Ÿèª¿

æ˜æ—¥ã‚‚å¼•ãç¶šãæ³¨ç›®ã§ã™ğŸ’¹

#æ—¥æœ¬æ ª #ç›¸å ´æŒ¯ã‚Šè¿”ã‚Š #æ ªå¼æŠ•è³‡'''

          payload = {
              'text': 'ğŸ“¢ *å¤œã®æŠ•ç¨¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ*\n\nä»¥ä¸‹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦Xã«æŠ•ç¨¿ã—ã¦ãã ã•ã„ğŸ‘‡\n\n\`\`\`\n' + message + '\n\`\`\`',
              'username': 'Stock Analyzer Bot',
              'icon_emoji': ':chart_with_upwards_trend:'
          }

          response = requests.post(
              os.getenv('SLACK_WEBHOOK_URL'),
              data=json.dumps(payload),
              headers={'Content-Type': 'application/json'}
          )

          print('âœ… Slackã¸ã®é€ä¿¡æˆåŠŸ' if response.status_code == 200 else f'âŒ å¤±æ•—: {response.status_code}')
          "
