name: Daily X Posts

on:
  # ÊØéÊó•3ÂõûÂÆüË°å
  schedule:
    # Êúù 7:00 JST (UTC 22:00ÂâçÊó•)
    - cron: '0 22 * * *'
    # Êòº 12:00 JST (UTC 3:00)
    - cron: '0 3 * * *'
    # Â§ú 18:00 JST (UTC 9:00)
    - cron: '0 9 * * *'

  # ÊâãÂãïÂÆüË°å„ÇÇÂèØËÉΩ
  workflow_dispatch:
    inputs:
      post_type:
        description: 'ÊäïÁ®ø„Çø„Ç§„Éó (morning/noon/evening)'
        required: true
        default: 'noon'
        type: choice
        options:
          - morning
          - noon
          - evening

jobs:
  generate-post:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          cd batch
          pip install psycopg2-binary requests python-dotenv

      - name: Determine post type
        id: post_type
        run: |
          # ÊâãÂãïÂÆüË°å„ÅÆÂ†¥Âêà„ÅØÂÖ•ÂäõÂÄ§„Çí‰ΩøÁî®
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "type=${{ github.event.inputs.post_type }}" >> $GITHUB_OUTPUT
          else
            # „Çπ„Ç±„Ç∏„É•„Éº„É´ÂÆüË°å„ÅÆÂ†¥Âêà„ÅØÊôÇÂàª„Åã„ÇâÂà§ÂÆö
            hour=$(date -u +%H)
            if [ "$hour" = "22" ]; then
              echo "type=morning" >> $GITHUB_OUTPUT
            elif [ "$hour" = "03" ]; then
              echo "type=noon" >> $GITHUB_OUTPUT
            elif [ "$hour" = "09" ]; then
              echo "type=evening" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Generate morning post (Â∏ÇÊ≥Å„Çµ„Éû„É™„Éº)
        if: steps.post_type.outputs.type == 'morning'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          cd batch
          python3 << 'PYTHON_SCRIPT'
          import os
          import requests
          import json

          message = "„Åä„ÅØ„Çà„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô‚òÄÔ∏è\n\n„Äê‰ªäÊúù„ÅÆÊó•Êú¨Ê†™„Äë\nÊó•ÁµåÂπ≥Âùá: (ÊâãÂãïÊõ¥Êñ∞)\nTOPIX: (ÊâãÂãïÊõ¥Êñ∞)\n\nÁ±≥ÂõΩÂ∏ÇÂ†¥„ÅÆÂΩ±Èüø„Åß(ÊâãÂãïÊõ¥Êñ∞)„ÅÆË¶ãËæº„Åø„ÄÇ\n‰ªäÊó•„ÅØ(ÊâãÂãïÊõ¥Êñ∞)„Çª„ÇØ„Çø„Éº„Å´Ê≥®ÁõÆüìä\n\n#Êó•Êú¨Ê†™ #Ê†™ÂºèÊäïË≥á #Êúù„ÅÆÂ∏ÇÊ≥Å"

          payload = {
              'text': 'üì¢ *Êúù„ÅÆÊäïÁ®ø„ÉÜ„É≥„Éó„É¨„Éº„Éà*\n\n‰ª•‰∏ã„Çí„Ç≥„Éî„Éº„Åó„Å¶X„Å´ÊäïÁ®ø„Åó„Å¶„Åè„Å†„Åï„ÅÑüëá\n\n' + message,
              'username': 'Stock Analyzer Bot',
              'icon_emoji': ':chart_with_upwards_trend:'
          }

          response = requests.post(
              os.getenv('SLACK_WEBHOOK_URL'),
              data=json.dumps(payload),
              headers={'Content-Type': 'application/json'}
          )

          print('‚úÖ Slack„Å∏„ÅÆÈÄÅ‰ø°ÊàêÂäü' if response.status_code == 200 else f'‚ùå Â§±Êïó: {response.status_code}')
          PYTHON_SCRIPT

      - name: Generate noon post („Åä„Åô„Åô„ÇÅÈäòÊüÑ)
        if: steps.post_type.outputs.type == 'noon'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          cd batch
          python daily_top_picks.py

      - name: Generate evening post (Â∏ÇÊ≥ÅÊåØ„ÇäËøî„Çä)
        if: steps.post_type.outputs.type == 'evening'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          cd batch
          python3 << 'PYTHON_SCRIPT'
          import os
          import requests
          import json

          message = "Êú¨Êó•„ÅÆÁõ∏Â†¥„Åæ„Å®„ÇÅüìù\n\nÊó•ÁµåÂπ≥Âùá: (ÊâãÂãïÊõ¥Êñ∞)\nÂÄ§‰∏ä„Åå„Çä: (ÊâãÂãïÊõ¥Êñ∞)ÈäòÊüÑ\nÂÄ§‰∏ã„Åå„Çä: (ÊâãÂãïÊõ¥Êñ∞)ÈäòÊüÑ\n\n‚úÖ (ÊâãÂãïÊõ¥Êñ∞)„Çª„ÇØ„Çø„Éº„ÅåÂ†ÖË™ø\n‚ö†Ô∏è (ÊâãÂãïÊõ¥Êñ∞)„ÅØËªüË™ø\n\nÊòéÊó•„ÇÇÂºï„ÅçÁ∂ö„ÅçÊ≥®ÁõÆ„Åß„Åôüíπ\n\n#Êó•Êú¨Ê†™ #Áõ∏Â†¥ÊåØ„ÇäËøî„Çä #Ê†™ÂºèÊäïË≥á"

          payload = {
              'text': 'üì¢ *Â§ú„ÅÆÊäïÁ®ø„ÉÜ„É≥„Éó„É¨„Éº„Éà*\n\n‰ª•‰∏ã„Çí„Ç≥„Éî„Éº„Åó„Å¶X„Å´ÊäïÁ®ø„Åó„Å¶„Åè„Å†„Åï„ÅÑüëá\n\n' + message,
              'username': 'Stock Analyzer Bot',
              'icon_emoji': ':chart_with_upwards_trend:'
          }

          response = requests.post(
              os.getenv('SLACK_WEBHOOK_URL'),
              data=json.dumps(payload),
              headers={'Content-Type': 'application/json'}
          )

          print('‚úÖ Slack„Å∏„ÅÆÈÄÅ‰ø°ÊàêÂäü' if response.status_code == 200 else f'‚ùå Â§±Êïó: {response.status_code}')
          PYTHON_SCRIPT
