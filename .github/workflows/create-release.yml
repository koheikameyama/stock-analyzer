name: Create Release

on:
  # Railwayãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
  deployment_status:

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:

jobs:
  create-release:
    # ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸæ™‚ã®ã¿å®Ÿè¡Œï¼ˆproductionç’°å¢ƒã€æˆåŠŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‰
    if: |
      (github.event_name == 'deployment_status' &&
       github.event.deployment_status.state == 'success' &&
       contains(github.event.deployment.environment, 'production')) ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    permissions:
      contents: write  # ãƒªãƒªãƒ¼ã‚¹ä½œæˆã€ã‚¿ã‚°ä½œæˆã«å¿…è¦
      pull-requests: write  # PRä½œæˆãƒ»ãƒãƒ¼ã‚¸ã«å¿…è¦

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆã‚¿ã‚°ã¨ã‚³ãƒŸãƒƒãƒˆå±¥æ­´å–å¾—ã®ãŸã‚ï¼‰

      - name: Get merged deploy PR info
        id: version_check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # æœ€è¿‘ãƒãƒ¼ã‚¸ã•ã‚ŒãŸdevelopâ†’mainã®PRã‚’æ¤œç´¢
          PR_NUMBER=$(gh pr list \
            --base main \
            --head develop \
            --state merged \
            --limit 1 \
            --json number \
            --jq '.[0].number')

          if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" = "null" ]; then
            echo "No merged deploy PR found"
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found merged deploy PR #$PR_NUMBER"

          # ãƒãƒ¼ã‚¸ã•ã‚ŒãŸPRã®æƒ…å ±ã‚’å–å¾—
          DEPLOY_PR=$(gh pr view $PR_NUMBER --json body --jq '.')
          DEPLOY_PR_BODY=$(echo "$DEPLOY_PR" | jq -r '.body')

          echo "Found deploy PR #$PR_NUMBER"

          # PRæœ¬æ–‡ã‹ã‚‰ã€Œå«ã¾ã‚Œã‚‹å¤‰æ›´ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŠ½å‡º
          PR_LIST=$(echo "$DEPLOY_PR_BODY" | awk '
            /^### å«ã¾ã‚Œã‚‹å¤‰æ›´/ {flag=1; next}
            /^### / {flag=0}
            flag && /^- / {print}
          ')

          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«ä»˜ãã®PRç•ªå·ã‚’æŠ½å‡º
          HAS_MAJOR=false
          HAS_MINOR=false
          HAS_PATCH=false
          VERSION_PR_NUMBERS=""

          while IFS= read -r line; do
            [ -z "$line" ] && continue

            # PRç•ªå·ã‚’æŠ½å‡ºï¼ˆä¾‹: "- #160: ã‚¿ã‚¤ãƒˆãƒ« [version:minor]" ã‹ã‚‰ "160" ã‚’æŠ½å‡ºï¼‰
            PR_NUM=$(echo "$line" | grep -oP '#\K\d+' | head -1)

            if echo "$line" | grep -q "version:major"; then
              HAS_MAJOR=true
              VERSION_PR_NUMBERS="${VERSION_PR_NUMBERS}${PR_NUM},"
            elif echo "$line" | grep -q "version:minor"; then
              HAS_MINOR=true
              VERSION_PR_NUMBERS="${VERSION_PR_NUMBERS}${PR_NUM},"
            elif echo "$line" | grep -q "version:patch"; then
              HAS_PATCH=true
              VERSION_PR_NUMBERS="${VERSION_PR_NUMBERS}${PR_NUM},"
            fi
          done <<< "$PR_LIST"

          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«ãŒãªã„å ´åˆã¯ãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆã—ãªã„
          if [ "$HAS_MAJOR" = false ] && [ "$HAS_MINOR" = false ] && [ "$HAS_PATCH" = false ]; then
            echo "No version labels found in PR list"
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒ—ã‚’æ±ºå®š
          if [ "$HAS_MAJOR" = true ]; then
            BUMP_TYPE="major"
          elif [ "$HAS_MINOR" = true ]; then
            BUMP_TYPE="minor"
          else
            BUMP_TYPE="patch"
          fi

          # æœ«å°¾ã®ã‚«ãƒ³ãƒã‚’å‰Šé™¤
          VERSION_PR_NUMBERS=$(echo "$VERSION_PR_NUMBERS" | sed 's/,$//')

          echo "should_release=true" >> $GITHUB_OUTPUT
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          echo "version_pr_numbers=$VERSION_PR_NUMBERS" >> $GITHUB_OUTPUT
          echo "Version bump type: $BUMP_TYPE"
          echo "Version PRs: $VERSION_PR_NUMBERS"

      - name: Calculate new version
        if: steps.version_check.outputs.should_release == 'true'
        id: new_version
        run: |
          # æœ€æ–°ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°ã‚’å–å¾—
          LATEST_TAG=$(git describe --tags --abbrev=0 --match "v*.*.*" 2>/dev/null || echo "v0.0.0")
          echo "Latest version tag: $LATEST_TAG"

          # vã‚’é™¤ã„ãŸæ•°å€¤éƒ¨åˆ†ã‚’æŠ½å‡º
          VERSION=${LATEST_TAG#v}
          IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
          MAJOR=${VERSION_PARTS[0]:-0}
          MINOR=${VERSION_PARTS[1]:-0}
          PATCH=${VERSION_PARTS[2]:-0}

          echo "Current version: $MAJOR.$MINOR.$PATCH"

          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
          BUMP_TYPE="${{ steps.version_check.outputs.bump_type }}"
          if [ "$BUMP_TYPE" = "major" ]; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif [ "$BUMP_TYPE" = "minor" ]; then
            MINOR=$((MINOR + 1))
            PATCH=0
          elif [ "$BUMP_TYPE" = "patch" ]; then
            PATCH=$((PATCH + 1))
          fi

          NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
          echo "New version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Get PR details for AI analysis
        if: steps.version_check.outputs.should_release == 'true'
        id: get_pr_details
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBERS="${{ steps.version_check.outputs.version_pr_numbers }}"

          # PRæƒ…å ±ã‚’JSONé…åˆ—ã¨ã—ã¦åé›†
          PR_DETAILS="[]"

          IFS=',' read -ra PR_ARRAY <<< "$PR_NUMBERS"
          for PR_NUM in "${PR_ARRAY[@]}"; do
            if [ -n "$PR_NUM" ]; then
              echo "Fetching PR #$PR_NUM details..."

              # PRã®è©³ç´°æƒ…å ±ã‚’å–å¾—
              PR_INFO=$(gh pr view "$PR_NUM" --json number,title,body 2>/dev/null || echo '{"number":0,"title":"","body":""}')

              # JSONé…åˆ—ã«è¿½åŠ 
              PR_DETAILS=$(echo "$PR_DETAILS" | jq --argjson pr "$PR_INFO" '. += [$pr]')
            fi
          done

          echo "pr_details<<EOF" >> $GITHUB_OUTPUT
          echo "$PR_DETAILS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate release notes with AI
        if: steps.version_check.outputs.should_release == 'true'
        id: release_notes
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          PR_DETAILS='${{ steps.get_pr_details.outputs.pr_details }}'

          # OpenAI APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
          PROMPT="ä»¥ä¸‹ã®PRã®å†…å®¹ã‚’ã‚‚ã¨ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®è¯ã‚„ã‹ã§åˆ†ã‹ã‚Šã‚„ã™ã„ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

è¦ä»¶:
- å„å¤‰æ›´ç‚¹ã‚’ã€Œ## æ›´æ–°å†…å®¹ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³é…ä¸‹ã«ç®‡æ¡æ›¸ãã§è¨˜è¼‰
- æŠ€è¡“ç”¨èªã¯é¿ã‘ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¨ã£ã¦ã®ä¾¡å€¤ã‚’æ˜ç¢ºã«èª¬æ˜
- çµµæ–‡å­—ã‚’é©åº¦ã«ä½¿ç”¨ã—ã¦è¦‹ã‚„ã™ã
- ç°¡æ½”ã§èª­ã¿ã‚„ã™ã„æ–‡ç« 
- ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã§å‡ºåŠ›

PRã®æƒ…å ±:
$PR_DETAILS"

          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "{
              \"model\": \"gpt-4o-mini\",
              \"messages\": [
                {
                  \"role\": \"system\",
                  \"content\": \"ã‚ãªãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹å°‚é–€å®¶ã§ã™ã€‚æŠ€è¡“çš„ãªå¤‰æ›´ã‚’ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¨ã£ã¦ã®ä¾¡å€¤ã«å¤‰æ›ã—ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚\"
                },
                {
                  \"role\": \"user\",
                  \"content\": $(echo "$PROMPT" | jq -Rs .)
                }
              ],
              \"temperature\": 0.7
            }")

          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’æŠ½å‡º
          RELEASE_NOTES=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "## æ›´æ–°å†…å®¹\n\nãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚"')

          echo "Generated release notes:"
          echo "$RELEASE_NOTES"

          # å‡ºåŠ›
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        if: steps.version_check.outputs.should_release == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.new_version }}"
          RELEASE_NOTES="${{ steps.release_notes.outputs.release_notes }}"

          gh release create "$NEW_VERSION" \
            --title "$NEW_VERSION" \
            --notes "$RELEASE_NOTES" \
            --target main

          echo "âœ… GitHub Release created: $NEW_VERSION"

      - name: Summary
        if: always()
        run: |
          echo "### ğŸš€ Deploy Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.version_check.outputs.should_release }}" == "true" ]; then
            echo "âœ… **Deployed**: develop â†’ main" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“¦ **Release Created**: ${{ steps.new_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Type**: ${{ steps.version_check.outputs.bump_type }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Deployed**: develop â†’ main (no release)" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ï¸ version:*ãƒ©ãƒ™ãƒ«ãŒãªã„ãŸã‚ã€ãƒªãƒªãƒ¼ã‚¹ã¯ä½œæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸ main â†’ develop ã®åŒæœŸã¯åˆ¥ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™" >> $GITHUB_STEP_SUMMARY
