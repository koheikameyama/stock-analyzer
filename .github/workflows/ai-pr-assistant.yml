name: AI PR Assistant

on:
  pull_request:
    types: [opened, synchronize, edited]
    branches:
      - develop

jobs:
  auto-label:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR information
        id: pr-info
        run: |
          # PRタイトルと本文を取得
          echo "title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT

          # 本文をエスケープして保存
          body=$(cat <<'EOF'
          ${{ github.event.pull_request.body }}
          EOF
          )
          echo "body<<EOFMARKER" >> $GITHUB_OUTPUT
          echo "$body" >> $GITHUB_OUTPUT
          echo "EOFMARKER" >> $GITHUB_OUTPUT

      - name: Get changed files
        id: files
        run: |
          # 変更ファイルリストを取得
          files=$(git diff --name-only origin/develop...HEAD | head -20)
          echo "files<<EOFMARKER" >> $GITHUB_OUTPUT
          echo "$files" >> $GITHUB_OUTPUT
          echo "EOFMARKER" >> $GITHUB_OUTPUT

      - name: Get diff summary
        id: diff
        run: |
          # diffの要約を取得（最初の100行程度）
          diff=$(git diff origin/develop...HEAD | head -100)
          echo "diff<<EOFMARKER" >> $GITHUB_OUTPUT
          echo "$diff" >> $GITHUB_OUTPUT
          echo "EOFMARKER" >> $GITHUB_OUTPUT

      - name: Analyze with AI
        id: analyze
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PR_TITLE: ${{ steps.pr-info.outputs.title }}
          PR_BODY: ${{ steps.pr-info.outputs.body }}
          PR_FILES: ${{ steps.files.outputs.files }}
          PR_DIFF: ${{ steps.diff.outputs.diff }}
        with:
          script: |
            const https = require('https');

            const title = process.env.PR_TITLE || '';
            const body = process.env.PR_BODY || '';
            const files = process.env.PR_FILES || '';
            const diff = process.env.PR_DIFF || '';

            const prompt = '以下のPRを分析し、適切なバージョンラベルとPR本文を生成してください。\n\n' +
              '## PR情報\n' +
              '**タイトル**: ' + title + '\n\n' +
              '**本文**:\n' + body + '\n\n' +
              '**変更ファイル**:\n' + files + '\n\n' +
              '**Diff要約**:\n```\n' + diff + '\n```\n\n' +
              '## タスク1: バージョンラベル判定\n\n' +
              '### 判定基準\n\n' +
              '### version:major\n' +
              '- 破壊的変更（APIの仕様変更、互換性のない変更）\n' +
              '- データ構造の大幅な変更\n\n' +
              '### version:minor\n' +
              '- **新機能追加**（ユーザーに価値がある）\n' +
              '- **ユーザーに説明して価値が伝わる変更**\n' +
              '- 例: 新しいUI機能、分析機能の追加、データ表示の改善\n\n' +
              '### version:patch\n' +
              '- **batch/のみの変更で、ユーザーに価値がある場合**\n' +
              '- 例: AI分析精度の向上、データ取得の信頼性向上\n' +
              '- 注意: 内部リファクタリングや技術的バグ修正は対象外\n\n' +
              '### none\n' +
              '- 内部リファクタリング\n' +
              '- 技術的バグ修正（ユーザーに見えない）\n' +
              '- ドキュメント修正のみ\n' +
              '- コードクリーンアップ\n\n' +
              '## 重要な判断基準\n' +
              '「ユーザーに説明して価値が伝わるか？」で判断してください。\n' +
              '- ✅ 伝わる → バージョンラベル必要\n' +
              '- ❌ 伝わらない → none\n\n' +
              '## タスク2: PR本文生成\n\n' +
              '以下のテンプレートに従って、PR本文を生成してください。\n\n' +
              '### テンプレート構造\n' +
              '```markdown\n' +
              '## 概要\n' +
              '<!-- このPRで何を変更・追加・修正したか簡潔に説明 -->\n\n' +
              '## 変更内容\n' +
              '<!-- 技術的な変更点を箇条書き -->\n' +
              '-\n\n' +
              '## ユーザー向けの変更\n' +
              '<!-- version:major/minorの場合は必須 -->\n' +
              '<!-- ユーザーにとっての価値を説明 -->\n' +
              '-\n\n' +
              '## テスト\n' +
              '- [ ] ローカル環境で動作確認\n' +
              '- [ ] スマホ表示を確認（モバイルファースト）\n' +
              '- [ ] N+1問題がないことを確認\n\n' +
              '## 関連Issue\n' +
              'Closes #\n' +
              '```\n\n' +
              '### 生成ルール\n' +
              '1. **概要**: PRタイトルを元に、1-2文で簡潔に説明\n' +
              '2. **変更内容**: 変更ファイルとdiffから技術的な変更点を箇条書き（3-5項目）\n' +
              '3. **ユーザー向けの変更**: バージョンラベルがnone以外の場合のみ記載。ユーザーメリットを明確に\n' +
              '4. **テスト**: チェックボックスはそのまま\n' +
              '5. **関連Issue**: 空のまま（ユーザーが後で記入）\n\n' +
              '### 注意点\n' +
              '- PR本文が既に入力されている場合は、生成したPR本文は参考情報として提示するのみ\n' +
              '- PR本文が空の場合のみ、自動更新を提案\n\n' +
              '## 回答形式\n' +
              'JSON形式で回答してください:\n' +
              '{\n' +
              '  "label": "version:minor" | "version:major" | "version:patch" | "none",\n' +
              '  "reason": "判定理由（日本語で簡潔に）",\n' +
              '  "user_value": "ユーザーにとっての価値（labelがnoneの場合は空文字）",\n' +
              '  "pr_body": "生成したPR本文（Markdown形式）"\n' +
              '}';

            // OpenAI APIを呼び出し
            const requestBody = JSON.stringify({
              model: 'gpt-4o-mini',
              messages: [
                {
                  role: 'system',
                  content: 'あなたは GitHub PR のバージョンラベルを判定する専門家です。ユーザー価値を重視して判定してください。'
                },
                {
                  role: 'user',
                  content: prompt
                }
              ],
              response_format: { type: 'json_object' },
              temperature: 0.3
            });

            const response = await new Promise((resolve, reject) => {
              const req = https.request(
                {
                  hostname: 'api.openai.com',
                  port: 443,
                  path: '/v1/chat/completions',
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
                    'Content-Length': Buffer.byteLength(requestBody)
                  }
                },
                (res) => {
                  let data = '';
                  res.on('data', (chunk) => { data += chunk; });
                  res.on('end', () => {
                    try {
                      resolve(JSON.parse(data));
                    } catch (e) {
                      reject(e);
                    }
                  });
                }
              );
              req.on('error', reject);
              req.write(requestBody);
              req.end();
            });

            if (response.error) {
              throw new Error(`OpenAI API Error: ${response.error.message}`);
            }

            const result = JSON.parse(response.choices[0].message.content);

            core.setOutput('label', result.label);
            core.setOutput('reason', result.reason);
            core.setOutput('user_value', result.user_value || '');
            core.setOutput('pr_body', result.pr_body || '');

            // Write to files for later use
            fs.writeFileSync('/tmp/ai_label.txt', result.label);
            fs.writeFileSync('/tmp/ai_reason.txt', result.reason);
            fs.writeFileSync('/tmp/ai_user_value.txt', result.user_value || '');
            fs.writeFileSync('/tmp/ai_pr_body.txt', result.pr_body || '');

            console.log('AI判定結果:', result);

      - name: Add version label
        if: steps.analyze.outputs.label != 'none'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const label = '${{ steps.analyze.outputs.label }}';

            // 既存のバージョンラベルを削除
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number
            });

            const versionLabels = currentLabels.filter(l => l.name.startsWith('version:'));
            for (const vl of versionLabels) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                name: vl.name
              });
            }

            // 新しいラベルを追加
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: [label]
            });

      - name: Update PR body if empty
        run: |
          # 現在のPR本文を取得
          CURRENT_BODY=$(gh pr view ${{ github.event.pull_request.number }} --json body --jq '.body')

          # PR本文が空、またはテンプレートのコメントのみの場合は更新
          if [ -z "$CURRENT_BODY" ] || [ ${#CURRENT_BODY} -lt 50 ] || echo "$CURRENT_BODY" | grep -q "AI PR Assistantが分析中"; then
            echo "PR本文を更新します"
            gh pr edit ${{ github.event.pull_request.number }} --body-file /tmp/ai_pr_body.txt
            echo "✅ PR本文を更新しました"
          else
            echo "ℹ️ PR本文は既に入力されているため、更新しませんでした"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post comment
        run: |
          LABEL=$(cat /tmp/ai_label.txt)
          REASON=$(cat /tmp/ai_reason.txt)
          USER_VALUE=$(cat /tmp/ai_user_value.txt)

          # Emojiを決定
          case "$LABEL" in
            "version:major") EMOJI="🚨" ;;
            "version:minor") EMOJI="✨" ;;
            "version:patch") EMOJI="🔧" ;;
            "none") EMOJI="📝" ;;
            *) EMOJI="🏷️" ;;
          esac

          # コメント本文を作成
          cat > /tmp/comment.txt <<EOF
          ${EMOJI} **AIバージョンラベル判定**

          **判定結果**: \`${LABEL}\`

          **理由**: ${REASON}
          EOF

          # ユーザー価値があれば追加
          if [ -n "$USER_VALUE" ]; then
            echo "" >> /tmp/comment.txt
            echo "**ユーザー価値**: ${USER_VALUE}" >> /tmp/comment.txt
          fi

          # version:major/minor/patchの場合は注意書き追加
          if [ "$LABEL" != "none" ]; then
            cat >> /tmp/comment.txt <<EOF

          ---
          ⚠️ **重要**: このPRには \`${LABEL}\` ラベルが付与されました。

          PR本文に「### ユーザー向けの変更」セクションが含まれていることを確認してください。
          EOF
          fi

          # コメント投稿
          gh pr comment ${{ github.event.pull_request.number }} --body-file /tmp/comment.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
