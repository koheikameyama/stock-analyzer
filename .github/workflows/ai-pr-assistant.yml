name: AI PR Assistant

on:
  pull_request:
    types: [opened, synchronize, edited]
    branches:
      - develop

jobs:
  auto-label:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR information
        id: pr-info
        run: |
          # PRã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã‚’å–å¾—
          echo "title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT

          # æœ¬æ–‡ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦ä¿å­˜
          body=$(cat <<'EOF'
          ${{ github.event.pull_request.body }}
          EOF
          )
          echo "body<<EOFMARKER" >> $GITHUB_OUTPUT
          echo "$body" >> $GITHUB_OUTPUT
          echo "EOFMARKER" >> $GITHUB_OUTPUT

      - name: Get changed files
        id: files
        run: |
          # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’å–å¾—
          files=$(git diff --name-only origin/develop...HEAD | head -20)
          echo "files<<EOFMARKER" >> $GITHUB_OUTPUT
          echo "$files" >> $GITHUB_OUTPUT
          echo "EOFMARKER" >> $GITHUB_OUTPUT

      - name: Get diff summary
        id: diff
        run: |
          # diffã®è¦ç´„ã‚’å–å¾—ï¼ˆæœ€åˆã®100è¡Œç¨‹åº¦ï¼‰
          diff=$(git diff origin/develop...HEAD | head -100)
          echo "diff<<EOFMARKER" >> $GITHUB_OUTPUT
          echo "$diff" >> $GITHUB_OUTPUT
          echo "EOFMARKER" >> $GITHUB_OUTPUT

      - name: Analyze with AI
        id: analyze
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PR_TITLE: ${{ steps.pr-info.outputs.title }}
          PR_BODY: ${{ steps.pr-info.outputs.body }}
          PR_FILES: ${{ steps.files.outputs.files }}
          PR_DIFF: ${{ steps.diff.outputs.diff }}
        with:
          script: |
            const https = require('https');

            const title = process.env.PR_TITLE || '';
            const body = process.env.PR_BODY || '';
            const files = process.env.PR_FILES || '';
            const diff = process.env.PR_DIFF || '';

            const prompt = 'ä»¥ä¸‹ã®PRã‚’åˆ†æã—ã€é©åˆ‡ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«ã¨PRæœ¬æ–‡ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚\n\n' +
              '## PRæƒ…å ±\n' +
              '**ã‚¿ã‚¤ãƒˆãƒ«**: ' + title + '\n\n' +
              '**æœ¬æ–‡**:\n' + body + '\n\n' +
              '**å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«**:\n' + files + '\n\n' +
              '**Diffè¦ç´„**:\n```\n' + diff + '\n```\n\n' +
              '## ã‚¿ã‚¹ã‚¯1: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«åˆ¤å®š\n\n' +
              '### åˆ¤å®šåŸºæº–\n\n' +
              '### version:major\n' +
              '- ç ´å£Šçš„å¤‰æ›´ï¼ˆAPIã®ä»•æ§˜å¤‰æ›´ã€äº’æ›æ€§ã®ãªã„å¤‰æ›´ï¼‰\n' +
              '- ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å¤§å¹…ãªå¤‰æ›´\n\n' +
              '### version:minor\n' +
              '- **æ–°æ©Ÿèƒ½è¿½åŠ **ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¾¡å€¤ãŒã‚ã‚‹ï¼‰\n' +
              '- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«èª¬æ˜ã—ã¦ä¾¡å€¤ãŒä¼ã‚ã‚‹å¤‰æ›´**\n' +
              '- ä¾‹: æ–°ã—ã„UIæ©Ÿèƒ½ã€åˆ†ææ©Ÿèƒ½ã®è¿½åŠ ã€ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã®æ”¹å–„\n\n' +
              '### version:patch\n' +
              '- **batch/ã®ã¿ã®å¤‰æ›´ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¾¡å€¤ãŒã‚ã‚‹å ´åˆ**\n' +
              '- ä¾‹: AIåˆ†æç²¾åº¦ã®å‘ä¸Šã€ãƒ‡ãƒ¼ã‚¿å–å¾—ã®ä¿¡é ¼æ€§å‘ä¸Š\n' +
              '- æ³¨æ„: å†…éƒ¨ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚„æŠ€è¡“çš„ãƒã‚°ä¿®æ­£ã¯å¯¾è±¡å¤–\n\n' +
              '### none\n' +
              '- å†…éƒ¨ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°\n' +
              '- æŠ€è¡“çš„ãƒã‚°ä¿®æ­£ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¦‹ãˆãªã„ï¼‰\n' +
              '- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¿®æ­£ã®ã¿\n' +
              '- ã‚³ãƒ¼ãƒ‰ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n\n' +
              '## é‡è¦ãªåˆ¤æ–­åŸºæº–\n' +
              'ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã«èª¬æ˜ã—ã¦ä¾¡å€¤ãŒä¼ã‚ã‚‹ã‹ï¼Ÿã€ã§åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚\n' +
              '- âœ… ä¼ã‚ã‚‹ â†’ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«å¿…è¦\n' +
              '- âŒ ä¼ã‚ã‚‰ãªã„ â†’ none\n\n' +
              '## ã‚¿ã‚¹ã‚¯2: PRæœ¬æ–‡ç”Ÿæˆ\n\n' +
              'ä»¥ä¸‹ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«å¾“ã£ã¦ã€PRæœ¬æ–‡ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚\n\n' +
              '### ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ§‹é€ \n' +
              '```markdown\n' +
              '## æ¦‚è¦\n' +
              '<!-- ã“ã®PRã§ä½•ã‚’å¤‰æ›´ãƒ»è¿½åŠ ãƒ»ä¿®æ­£ã—ãŸã‹ç°¡æ½”ã«èª¬æ˜ -->\n\n' +
              '## å¤‰æ›´å†…å®¹\n' +
              '<!-- æŠ€è¡“çš„ãªå¤‰æ›´ç‚¹ã‚’ç®‡æ¡æ›¸ã -->\n' +
              '-\n\n' +
              '## ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®å¤‰æ›´\n' +
              '<!-- version:major/minorã®å ´åˆã¯å¿…é ˆ -->\n' +
              '<!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¨ã£ã¦ã®ä¾¡å€¤ã‚’èª¬æ˜ -->\n' +
              '-\n\n' +
              '## ãƒ†ã‚¹ãƒˆ\n' +
              '- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§å‹•ä½œç¢ºèª\n' +
              '- [ ] ã‚¹ãƒãƒ›è¡¨ç¤ºã‚’ç¢ºèªï¼ˆãƒ¢ãƒã‚¤ãƒ«ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆï¼‰\n' +
              '- [ ] N+1å•é¡ŒãŒãªã„ã“ã¨ã‚’ç¢ºèª\n\n' +
              '## é–¢é€£Issue\n' +
              'Closes #\n' +
              '```\n\n' +
              '### ç”Ÿæˆãƒ«ãƒ¼ãƒ«\n' +
              '1. **æ¦‚è¦**: PRã‚¿ã‚¤ãƒˆãƒ«ã‚’å…ƒã«ã€1-2æ–‡ã§ç°¡æ½”ã«èª¬æ˜\n' +
              '2. **å¤‰æ›´å†…å®¹**: å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã¨diffã‹ã‚‰æŠ€è¡“çš„ãªå¤‰æ›´ç‚¹ã‚’ç®‡æ¡æ›¸ãï¼ˆ3-5é …ç›®ï¼‰\n' +
              '3. **ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®å¤‰æ›´**: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«ãŒnoneä»¥å¤–ã®å ´åˆã®ã¿è¨˜è¼‰ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒªãƒƒãƒˆã‚’æ˜ç¢ºã«\n' +
              '4. **ãƒ†ã‚¹ãƒˆ**: ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¯ãã®ã¾ã¾\n' +
              '5. **é–¢é€£Issue**: ç©ºã®ã¾ã¾ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¾Œã§è¨˜å…¥ï¼‰\n\n' +
              '### æ³¨æ„ç‚¹\n' +
              '- PRæœ¬æ–‡ãŒæ—¢ã«å…¥åŠ›ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ç”Ÿæˆã—ãŸPRæœ¬æ–‡ã¯å‚è€ƒæƒ…å ±ã¨ã—ã¦æç¤ºã™ã‚‹ã®ã¿\n' +
              '- PRæœ¬æ–‡ãŒç©ºã®å ´åˆã®ã¿ã€è‡ªå‹•æ›´æ–°ã‚’ææ¡ˆ\n\n' +
              '## å›ç­”å½¢å¼\n' +
              'JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„:\n' +
              '{\n' +
              '  "label": "version:minor" | "version:major" | "version:patch" | "none",\n' +
              '  "reason": "åˆ¤å®šç†ç”±ï¼ˆæ—¥æœ¬èªã§ç°¡æ½”ã«ï¼‰",\n' +
              '  "user_value": "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¨ã£ã¦ã®ä¾¡å€¤ï¼ˆlabelãŒnoneã®å ´åˆã¯ç©ºæ–‡å­—ï¼‰",\n' +
              '  "pr_body": "ç”Ÿæˆã—ãŸPRæœ¬æ–‡ï¼ˆMarkdownå½¢å¼ï¼‰"\n' +
              '}';

            // OpenAI APIã‚’å‘¼ã³å‡ºã—
            const requestBody = JSON.stringify({
              model: 'gpt-4o-mini',
              messages: [
                {
                  role: 'system',
                  content: 'ã‚ãªãŸã¯ GitHub PR ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«ã‚’åˆ¤å®šã™ã‚‹å°‚é–€å®¶ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¾¡å€¤ã‚’é‡è¦–ã—ã¦åˆ¤å®šã—ã¦ãã ã•ã„ã€‚'
                },
                {
                  role: 'user',
                  content: prompt
                }
              ],
              response_format: { type: 'json_object' },
              temperature: 0.3
            });

            const response = await new Promise((resolve, reject) => {
              const req = https.request(
                {
                  hostname: 'api.openai.com',
                  port: 443,
                  path: '/v1/chat/completions',
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
                    'Content-Length': Buffer.byteLength(requestBody)
                  }
                },
                (res) => {
                  let data = '';
                  res.on('data', (chunk) => { data += chunk; });
                  res.on('end', () => {
                    try {
                      resolve(JSON.parse(data));
                    } catch (e) {
                      reject(e);
                    }
                  });
                }
              );
              req.on('error', reject);
              req.write(requestBody);
              req.end();
            });

            if (response.error) {
              throw new Error(`OpenAI API Error: ${response.error.message}`);
            }

            const result = JSON.parse(response.choices[0].message.content);

            core.setOutput('label', result.label);
            core.setOutput('reason', result.reason);
            core.setOutput('user_value', result.user_value || '');
            core.setOutput('pr_body', result.pr_body || '');

            console.log('AIåˆ¤å®šçµæœ:', result);

      - name: Add version label
        if: steps.analyze.outputs.label != 'none'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const label = '${{ steps.analyze.outputs.label }}';

            // æ—¢å­˜ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«ã‚’å‰Šé™¤
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number
            });

            const versionLabels = currentLabels.filter(l => l.name.startsWith('version:'));
            for (const vl of versionLabels) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                name: vl.name
              });
            }

            // æ–°ã—ã„ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: [label]
            });

      - name: Update PR body if empty
        uses: actions/github-script@v7
        env:
          PR_BODY: ${{ steps.analyze.outputs.pr_body }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const currentBody = context.payload.pull_request.body || '';
            const generatedBody = process.env.PR_BODY || '';

            // PRæœ¬æ–‡ãŒç©ºã€ã¾ãŸã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ã‚³ãƒ¡ãƒ³ãƒˆã®ã¿ã®å ´åˆã¯æ›´æ–°
            const isEmptyOrTemplate = !currentBody ||
              currentBody.trim().length < 50 ||
              currentBody.includes('<!-- ã“ã®PRã§ä½•ã‚’å¤‰æ›´');

            if (isEmptyOrTemplate && generatedBody) {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                body: generatedBody
              });
              console.log('PRæœ¬æ–‡ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            } else {
              console.log('PRæœ¬æ–‡ã¯æ—¢ã«å…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€æ›´æ–°ã—ã¾ã›ã‚“ã§ã—ãŸ');
            }

      - name: Post comment
        uses: actions/github-script@v7
        env:
          AI_LABEL: ${{ steps.analyze.outputs.label }}
          AI_REASON: ${{ steps.analyze.outputs.reason }}
          AI_USER_VALUE: ${{ steps.analyze.outputs.user_value }}
          AI_PR_BODY: ${{ steps.analyze.outputs.pr_body }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const label = process.env.AI_LABEL || '';
            const reason = process.env.AI_REASON || '';
            const userValue = process.env.AI_USER_VALUE || '';
            const currentBody = context.payload.pull_request.body || '';
            const generatedBody = process.env.AI_PR_BODY || '';
            const isEmptyOrTemplate = !currentBody ||
              currentBody.trim().length < 50 ||
              currentBody.includes('<!-- ã“ã®PRã§ä½•ã‚’å¤‰æ›´');

            let emoji = 'ğŸ·ï¸';
            if (label === 'version:major') emoji = 'ğŸš¨';
            if (label === 'version:minor') emoji = 'âœ¨';
            if (label === 'version:patch') emoji = 'ğŸ”§';
            if (label === 'none') emoji = 'ğŸ“';

            let message = `${emoji} **AIãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«åˆ¤å®š**\n\n`;
            message += `**åˆ¤å®šçµæœ**: \`${label}\`\n\n`;
            message += `**ç†ç”±**: ${reason}\n`;

            if (userValue) {
              message += `\n**ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¾¡å€¤**: ${userValue}\n`;
            }

            // PRæœ¬æ–‡ãŒæ›´æ–°ã•ã‚Œãªã‹ã£ãŸå ´åˆã¯ã€ç”Ÿæˆã•ã‚ŒãŸæœ¬æ–‡ã‚’æç¤º
            if (!isEmptyOrTemplate && generatedBody) {
              message += `\n---\n\n`;
              message += `ğŸ“ **AIãŒç”Ÿæˆã—ãŸPRæœ¬æ–‡ï¼ˆå‚è€ƒï¼‰**\n\n`;
              message += `<details>\n<summary>ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¡¨ç¤º</summary>\n\n`;
              message += generatedBody;
              message += `\n</details>\n`;
            }

            if (label !== 'none') {
              message += `\n---\n`;
              message += `âš ï¸ **é‡è¦**: ã“ã®PRã«ã¯ \`${label}\` ãƒ©ãƒ™ãƒ«ãŒä»˜ä¸ã•ã‚Œã¾ã—ãŸã€‚\n\n`;
              if (!isEmptyOrTemplate) {
                message += `PRæœ¬æ–‡ã«ã€Œ### ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®å¤‰æ›´ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n`;
              }
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: message
            });
