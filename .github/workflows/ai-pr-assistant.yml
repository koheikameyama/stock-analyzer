name: AI PR Assistant

on:
  pull_request:
    types: [opened, synchronize, edited]
    branches:
      - develop

jobs:
  auto-label:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR information
        id: pr-info
        run: |
          # PRã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã‚’å–å¾—
          echo "title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT

          # æœ¬æ–‡ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦ä¿å­˜
          body=$(cat <<'EOF'
          ${{ github.event.pull_request.body }}
          EOF
          )
          echo "body<<EOFMARKER" >> $GITHUB_OUTPUT
          echo "$body" >> $GITHUB_OUTPUT
          echo "EOFMARKER" >> $GITHUB_OUTPUT

      - name: Get changed files
        id: files
        run: |
          # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’å–å¾—
          files=$(git diff --name-only origin/develop...HEAD | head -20)
          echo "files<<EOFMARKER" >> $GITHUB_OUTPUT
          echo "$files" >> $GITHUB_OUTPUT
          echo "EOFMARKER" >> $GITHUB_OUTPUT

      - name: Get diff summary
        id: diff
        run: |
          # diffã®è¦ç´„ã‚’å–å¾—ï¼ˆæœ€åˆã®100è¡Œç¨‹åº¦ï¼‰
          diff=$(git diff origin/develop...HEAD | head -100)
          echo "diff<<EOFMARKER" >> $GITHUB_OUTPUT
          echo "$diff" >> $GITHUB_OUTPUT
          echo "EOFMARKER" >> $GITHUB_OUTPUT

      - name: Analyze with AI
        id: analyze
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          script: |
            const https = require('https');

            const title = `${{ steps.pr-info.outputs.title }}`;
            const body = `${{ steps.pr-info.outputs.body }}`;
            const files = `${{ steps.files.outputs.files }}`;
            const diff = `${{ steps.diff.outputs.diff }}`;

            const prompt = `ä»¥ä¸‹ã®PRã‚’åˆ†æã—ã€é©åˆ‡ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«ã¨PRæœ¬æ–‡ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

## PRæƒ…å ±
**ã‚¿ã‚¤ãƒˆãƒ«**: ${title}

**æœ¬æ–‡**:
${body}

**å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«**:
${files}

**Diffè¦ç´„**:
\`\`\`
${diff}
\`\`\`

## ã‚¿ã‚¹ã‚¯1: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«åˆ¤å®š

### åˆ¤å®šåŸºæº–

### version:major
- ç ´å£Šçš„å¤‰æ›´ï¼ˆAPIã®ä»•æ§˜å¤‰æ›´ã€äº’æ›æ€§ã®ãªã„å¤‰æ›´ï¼‰
- ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å¤§å¹…ãªå¤‰æ›´

### version:minor
- **æ–°æ©Ÿèƒ½è¿½åŠ **ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¾¡å€¤ãŒã‚ã‚‹ï¼‰
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«èª¬æ˜ã—ã¦ä¾¡å€¤ãŒä¼ã‚ã‚‹å¤‰æ›´**
- ä¾‹: æ–°ã—ã„UIæ©Ÿèƒ½ã€åˆ†ææ©Ÿèƒ½ã®è¿½åŠ ã€ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã®æ”¹å–„

### version:patch
- **batch/ã®ã¿ã®å¤‰æ›´ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¾¡å€¤ãŒã‚ã‚‹å ´åˆ**
- ä¾‹: AIåˆ†æç²¾åº¦ã®å‘ä¸Šã€ãƒ‡ãƒ¼ã‚¿å–å¾—ã®ä¿¡é ¼æ€§å‘ä¸Š
- æ³¨æ„: å†…éƒ¨ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚„æŠ€è¡“çš„ãƒã‚°ä¿®æ­£ã¯å¯¾è±¡å¤–

### none
- å†…éƒ¨ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
- æŠ€è¡“çš„ãƒã‚°ä¿®æ­£ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¦‹ãˆãªã„ï¼‰
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¿®æ­£ã®ã¿
- ã‚³ãƒ¼ãƒ‰ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

## é‡è¦ãªåˆ¤æ–­åŸºæº–
ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã«èª¬æ˜ã—ã¦ä¾¡å€¤ãŒä¼ã‚ã‚‹ã‹ï¼Ÿã€ã§åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚
- âœ… ä¼ã‚ã‚‹ â†’ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«å¿…è¦
- âŒ ä¼ã‚ã‚‰ãªã„ â†’ none

## ã‚¿ã‚¹ã‚¯2: PRæœ¬æ–‡ç”Ÿæˆ

ä»¥ä¸‹ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«å¾“ã£ã¦ã€PRæœ¬æ–‡ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ§‹é€ 
\`\`\`markdown
## æ¦‚è¦
<!-- ã“ã®PRã§ä½•ã‚’å¤‰æ›´ãƒ»è¿½åŠ ãƒ»ä¿®æ­£ã—ãŸã‹ç°¡æ½”ã«èª¬æ˜ -->

## å¤‰æ›´å†…å®¹
<!-- æŠ€è¡“çš„ãªå¤‰æ›´ç‚¹ã‚’ç®‡æ¡æ›¸ã -->
-

## ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®å¤‰æ›´
<!-- version:major/minorã®å ´åˆã¯å¿…é ˆ -->
<!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¨ã£ã¦ã®ä¾¡å€¤ã‚’èª¬æ˜ -->
-

## ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§å‹•ä½œç¢ºèª
- [ ] ã‚¹ãƒãƒ›è¡¨ç¤ºã‚’ç¢ºèªï¼ˆãƒ¢ãƒã‚¤ãƒ«ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆï¼‰
- [ ] N+1å•é¡ŒãŒãªã„ã“ã¨ã‚’ç¢ºèª

## é–¢é€£Issue
Closes #
\`\`\`

### ç”Ÿæˆãƒ«ãƒ¼ãƒ«
1. **æ¦‚è¦**: PRã‚¿ã‚¤ãƒˆãƒ«ã‚’å…ƒã«ã€1-2æ–‡ã§ç°¡æ½”ã«èª¬æ˜
2. **å¤‰æ›´å†…å®¹**: å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã¨diffã‹ã‚‰æŠ€è¡“çš„ãªå¤‰æ›´ç‚¹ã‚’ç®‡æ¡æ›¸ãï¼ˆ3-5é …ç›®ï¼‰
3. **ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®å¤‰æ›´**: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«ãŒnoneä»¥å¤–ã®å ´åˆã®ã¿è¨˜è¼‰ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒªãƒƒãƒˆã‚’æ˜ç¢ºã«
4. **ãƒ†ã‚¹ãƒˆ**: ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¯ãã®ã¾ã¾
5. **é–¢é€£Issue**: ç©ºã®ã¾ã¾ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¾Œã§è¨˜å…¥ï¼‰

### æ³¨æ„ç‚¹
- PRæœ¬æ–‡ãŒæ—¢ã«å…¥åŠ›ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ç”Ÿæˆã—ãŸPRæœ¬æ–‡ã¯å‚è€ƒæƒ…å ±ã¨ã—ã¦æç¤ºã™ã‚‹ã®ã¿
- PRæœ¬æ–‡ãŒç©ºã®å ´åˆã®ã¿ã€è‡ªå‹•æ›´æ–°ã‚’ææ¡ˆ

## å›ç­”å½¢å¼
JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„:
{
  "label": "version:minor" | "version:major" | "version:patch" | "none",
  "reason": "åˆ¤å®šç†ç”±ï¼ˆæ—¥æœ¬èªã§ç°¡æ½”ã«ï¼‰",
  "user_value": "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¨ã£ã¦ã®ä¾¡å€¤ï¼ˆlabelãŒnoneã®å ´åˆã¯ç©ºæ–‡å­—ï¼‰",
  "pr_body": "ç”Ÿæˆã—ãŸPRæœ¬æ–‡ï¼ˆMarkdownå½¢å¼ï¼‰"
}`;

            // OpenAI APIã‚’å‘¼ã³å‡ºã—
            const requestBody = JSON.stringify({
              model: 'gpt-4o-mini',
              messages: [
                {
                  role: 'system',
                  content: 'ã‚ãªãŸã¯ GitHub PR ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«ã‚’åˆ¤å®šã™ã‚‹å°‚é–€å®¶ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¾¡å€¤ã‚’é‡è¦–ã—ã¦åˆ¤å®šã—ã¦ãã ã•ã„ã€‚'
                },
                {
                  role: 'user',
                  content: prompt
                }
              ],
              response_format: { type: 'json_object' },
              temperature: 0.3
            });

            const response = await new Promise((resolve, reject) => {
              const req = https.request(
                {
                  hostname: 'api.openai.com',
                  port: 443,
                  path: '/v1/chat/completions',
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
                    'Content-Length': Buffer.byteLength(requestBody)
                  }
                },
                (res) => {
                  let data = '';
                  res.on('data', (chunk) => { data += chunk; });
                  res.on('end', () => {
                    try {
                      resolve(JSON.parse(data));
                    } catch (e) {
                      reject(e);
                    }
                  });
                }
              );
              req.on('error', reject);
              req.write(requestBody);
              req.end();
            });

            if (response.error) {
              throw new Error(`OpenAI API Error: ${response.error.message}`);
            }

            const result = JSON.parse(response.choices[0].message.content);

            core.setOutput('label', result.label);
            core.setOutput('reason', result.reason);
            core.setOutput('user_value', result.user_value || '');
            core.setOutput('pr_body', result.pr_body || '');

            console.log('AIåˆ¤å®šçµæœ:', result);

      - name: Add version label
        if: steps.analyze.outputs.label != 'none'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const label = '${{ steps.analyze.outputs.label }}';

            // æ—¢å­˜ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«ã‚’å‰Šé™¤
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number
            });

            const versionLabels = currentLabels.filter(l => l.name.startsWith('version:'));
            for (const vl of versionLabels) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                name: vl.name
              });
            }

            // æ–°ã—ã„ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: [label]
            });

      - name: Update PR body if empty
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const currentBody = context.payload.pull_request.body || '';
            const generatedBody = `${{ steps.analyze.outputs.pr_body }}`;

            // PRæœ¬æ–‡ãŒç©ºã€ã¾ãŸã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ã‚³ãƒ¡ãƒ³ãƒˆã®ã¿ã®å ´åˆã¯æ›´æ–°
            const isEmptyOrTemplate = !currentBody ||
              currentBody.trim().length < 50 ||
              currentBody.includes('<!-- ã“ã®PRã§ä½•ã‚’å¤‰æ›´');

            if (isEmptyOrTemplate && generatedBody) {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                body: generatedBody
              });
              console.log('PRæœ¬æ–‡ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            } else {
              console.log('PRæœ¬æ–‡ã¯æ—¢ã«å…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€æ›´æ–°ã—ã¾ã›ã‚“ã§ã—ãŸ');
            }

      - name: Post comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const label = '${{ steps.analyze.outputs.label }}';
            const reason = '${{ steps.analyze.outputs.reason }}';
            const userValue = '${{ steps.analyze.outputs.user_value }}';
            const currentBody = context.payload.pull_request.body || '';
            const generatedBody = `${{ steps.analyze.outputs.pr_body }}`;
            const isEmptyOrTemplate = !currentBody ||
              currentBody.trim().length < 50 ||
              currentBody.includes('<!-- ã“ã®PRã§ä½•ã‚’å¤‰æ›´');

            let emoji = 'ğŸ·ï¸';
            if (label === 'version:major') emoji = 'ğŸš¨';
            if (label === 'version:minor') emoji = 'âœ¨';
            if (label === 'version:patch') emoji = 'ğŸ”§';
            if (label === 'none') emoji = 'ğŸ“';

            let message = `${emoji} **AIãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«åˆ¤å®š**\n\n`;
            message += `**åˆ¤å®šçµæœ**: \`${label}\`\n\n`;
            message += `**ç†ç”±**: ${reason}\n`;

            if (userValue) {
              message += `\n**ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¾¡å€¤**: ${userValue}\n`;
            }

            // PRæœ¬æ–‡ãŒæ›´æ–°ã•ã‚Œãªã‹ã£ãŸå ´åˆã¯ã€ç”Ÿæˆã•ã‚ŒãŸæœ¬æ–‡ã‚’æç¤º
            if (!isEmptyOrTemplate && generatedBody) {
              message += `\n---\n\n`;
              message += `ğŸ“ **AIãŒç”Ÿæˆã—ãŸPRæœ¬æ–‡ï¼ˆå‚è€ƒï¼‰**\n\n`;
              message += `<details>\n<summary>ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¡¨ç¤º</summary>\n\n`;
              message += generatedBody;
              message += `\n</details>\n`;
            }

            if (label !== 'none') {
              message += `\n---\n`;
              message += `âš ï¸ **é‡è¦**: ã“ã®PRã«ã¯ \`${label}\` ãƒ©ãƒ™ãƒ«ãŒä»˜ä¸ã•ã‚Œã¾ã—ãŸã€‚\n\n`;
              if (!isEmptyOrTemplate) {
                message += `PRæœ¬æ–‡ã«ã€Œ### ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®å¤‰æ›´ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n`;
              }
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: message
            });
