name: Auto Create PR

on:
  push:
    branches:
      - 'feature/**'
      - 'fix/**'

jobs:
  create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create PR if not exists
        run: |
          # 既存のPRがあるかチェック
          EXISTING_PR=$(gh pr list --head ${{ github.ref_name }} --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -z "$EXISTING_PR" ] || [ "$EXISTING_PR" = "null" ]; then
            echo "Creating new PR for branch ${{ github.ref_name }}"

            # 最新のコミットメッセージをタイトルに使用
            TITLE=$(git log -1 --pretty=format:"%s")

            # PR作成（本文は空、AIが後で埋める）
            gh pr create \
              --base develop \
              --head ${{ github.ref_name }} \
              --title "$TITLE" \
              --body "<!-- AI PR Assistantが分析中... -->"

            echo "✅ PR created successfully"
          else
            echo "ℹ️ PR #$EXISTING_PR already exists for this branch"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
