name: Auto Create PR

on:
  create:
    branches:
      - 'feature/**'
      - 'hotfix/**'

jobs:
  create-pr:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine target branch
        id: target
        run: |
          BRANCH_NAME="${{ github.ref_name }}"

          if [[ "$BRANCH_NAME" == feature/* ]]; then
            echo "base=develop" >> $GITHUB_OUTPUT
            echo "type=feature" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH_NAME" == hotfix/* ]]; then
            echo "base=main" >> $GITHUB_OUTPUT
            echo "type=hotfix" >> $GITHUB_OUTPUT
          else
            echo "Unknown branch type: $BRANCH_NAME"
            exit 1
          fi

      - name: Check if PR already exists
        id: check_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          EXISTING_PR=$(gh pr list --head ${{ github.ref_name }} --base ${{ steps.target.outputs.base }} --state open --json number --jq '.[0].number' || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
            echo "Existing PR found: #$EXISTING_PR"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No existing PR found"
          fi

      - name: Create PR
        if: steps.check_pr.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          BASE_BRANCH="${{ steps.target.outputs.base }}"
          BRANCH_TYPE="${{ steps.target.outputs.type }}"

          # „Éñ„É©„É≥„ÉÅÂêç„Åã„Çâ„Çø„Ç§„Éà„É´„ÇíÁîüÊàê
          TITLE=$(echo "$BRANCH_NAME" | sed 's|^[^/]*/||' | sed 's|-| |g' | sed 's/\b\(.\)/\u\1/g')

          if [ "$BRANCH_TYPE" = "feature" ]; then
            gh pr create \
              --base "$BASE_BRANCH" \
              --head "$BRANCH_NAME" \
              --title "$TITLE" \
              --body "$(cat <<'EOFBODY'
## Ê¶ÇË¶Å

„Åì„ÅÆPR„ÅØ feature „Éñ„É©„É≥„ÉÅ„Åã„ÇâËá™Âãï‰ΩúÊàê„Åï„Çå„Åæ„Åó„Åü„ÄÇ

## ‰∏ª„Å™Â§âÊõ¥ÂÜÖÂÆπ

- TODO: Â§âÊõ¥ÂÜÖÂÆπ„ÇíË®òËºâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ

## „ÉÜ„Çπ„ÉàË®àÁîª

- [ ] TODO: „ÉÜ„Çπ„ÉàÈ†ÖÁõÆ„ÇíË®òËºâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ

## „Éê„Éº„Ç∏„Éß„É≥„É©„Éô„É´

Â§âÊõ¥ÂÜÖÂÆπ„Å´Âøú„Åò„Å¶ÈÅ©Âàá„Å™„É©„Éô„É´„Çí‰ªò‰∏é„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö
- `version:major` - Á†¥Â£äÁöÑÂ§âÊõ¥
- `version:minor` - Êñ∞Ê©üËÉΩËøΩÂä†
- `version:patch` - „Éê„Ç∞‰øÆÊ≠£Ôºà„É¶„Éº„Ç∂„Éº„Å´ÂΩ±Èüø„ÅÇ„ÇäÔºâ
- „É©„Éô„É´„Å™„Åó - ÂÜÖÈÉ®ÊîπÂñÑÔºà„É¶„Éº„Ç∂„Éº„Å´ÂΩ±Èüø„Å™„ÅóÔºâ
EOFBODY
)"
          else
            gh pr create \
              --base "$BASE_BRANCH" \
              --head "$BRANCH_NAME" \
              --title "$TITLE" \
              --body "$(cat <<'EOFBODY'
## Ê¶ÇË¶Å

„Åì„ÅÆPR„ÅØ hotfix „Éñ„É©„É≥„ÉÅ„Åã„ÇâËá™Âãï‰ΩúÊàê„Åï„Çå„Åæ„Åó„Åü„ÄÇ

## ‰øÆÊ≠£ÂÜÖÂÆπ

- TODO: ‰øÆÊ≠£ÂÜÖÂÆπ„ÇíË®òËºâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ

## ÂΩ±ÈüøÁØÑÂõ≤

- TODO: ÂΩ±ÈüøÁØÑÂõ≤„ÇíË®òËºâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ

## „ÉÜ„Çπ„ÉàË®àÁîª

- [ ] TODO: „ÉÜ„Çπ„ÉàÈ†ÖÁõÆ„ÇíË®òËºâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ

## Ê≥®ÊÑè‰∫ãÈ†Ö

‚ö†Ô∏è „Åì„ÅÆPR„ÅØmain„Éñ„É©„É≥„ÉÅ„Å∏„ÅÆÁõ¥Êé•„Éû„Éº„Ç∏„Åß„Åô„ÄÇÊÖéÈáç„Å´„É¨„Éì„É•„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

## „Éê„Éº„Ç∏„Éß„É≥„É©„Éô„É´

ÈÄöÂ∏∏„ÅØ `version:patch` „Çí‰ªò‰∏é„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
EOFBODY
)"
          fi

          echo "PR created successfully"

      - name: Summary
        if: always()
        run: |
          echo "### üöÄ Auto PR Creation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_pr.outputs.exists }}" == "true" ]; then
            echo "‚ÑπÔ∏è **PR Already Exists**: #${{ steps.check_pr.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **PR Created**: ${{ github.ref_name }} ‚Üí ${{ steps.target.outputs.base }}" >> $GITHUB_STEP_SUMMARY
          fi
