name: Auto Create PR

on:
  create:

jobs:
  create-pr:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine target branch
        id: target
        run: |
          BRANCH_NAME="${{ github.ref_name }}"

          # hotfixã®ã¿mainã¸PRã€ãã‚Œä»¥å¤–ã¯å…¨ã¦developã¸PR
          if [[ "$BRANCH_NAME" == hotfix/* ]]; then
            echo "base=main" >> $GITHUB_OUTPUT
            echo "type=hotfix" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH_NAME" == main || "$BRANCH_NAME" == develop ]]; then
            # main/developãƒ–ãƒ©ãƒ³ãƒè‡ªä½“ã¯ã‚¹ã‚­ãƒƒãƒ—
            echo "Skip PR creation for protected branch"
            exit 0
          else
            echo "base=develop" >> $GITHUB_OUTPUT
            echo "type=feature" >> $GITHUB_OUTPUT
          fi

      - name: Check if PR already exists
        id: check_pr
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          EXISTING_PR=$(gh pr list --head ${{ github.ref_name }} --base ${{ steps.target.outputs.base }} --state open --json number --jq '.[0].number' || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
            echo "Existing PR found: #$EXISTING_PR"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No existing PR found"
          fi

      - name: Create PR
        if: steps.check_pr.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          BASE_BRANCH="${{ steps.target.outputs.base }}"
          BRANCH_TYPE="${{ steps.target.outputs.type }}"

          # ãƒ–ãƒ©ãƒ³ãƒåã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç”Ÿæˆ
          TITLE=$(echo "$BRANCH_NAME" | sed 's|^[^/]*/||' | sed 's|-| |g' | sed 's/\b\(.\)/\u\1/g')

          # PRæœ¬æ–‡ã‚’ç”Ÿæˆã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã—
          if [ "$BRANCH_TYPE" = "feature" ]; then
            {
              echo "## æ¦‚è¦"
              echo ""
              echo "ã“ã®PRã¯ feature ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰è‡ªå‹•ä½œæˆã•ã‚Œã¾ã—ãŸã€‚"
              echo ""
              echo "## ä¸»ãªå¤‰æ›´å†…å®¹"
              echo ""
              echo "- TODO: å¤‰æ›´å†…å®¹ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„"
              echo ""
              echo "## ãƒ†ã‚¹ãƒˆè¨ˆç”»"
              echo ""
              echo "- [ ] TODO: ãƒ†ã‚¹ãƒˆé …ç›®ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„"
              echo ""
              echo "## ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«"
              echo ""
              echo "å¤‰æ›´å†…å®¹ã«å¿œã˜ã¦é©åˆ‡ãªãƒ©ãƒ™ãƒ«ã‚’ä»˜ä¸Žã—ã¦ãã ã•ã„ï¼š"
              echo "- version:major - ç ´å£Šçš„å¤‰æ›´"
              echo "- version:minor - æ–°æ©Ÿèƒ½è¿½åŠ "
              echo "- version:patch - ãƒã‚°ä¿®æ­£ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å½±éŸ¿ã‚ã‚Šï¼‰"
              echo "- ãƒ©ãƒ™ãƒ«ãªã— - å†…éƒ¨æ”¹å–„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å½±éŸ¿ãªã—ï¼‰"
            } > /tmp/pr_body.md
          else
            {
              echo "## æ¦‚è¦"
              echo ""
              echo "ã“ã®PRã¯ hotfix ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰è‡ªå‹•ä½œæˆã•ã‚Œã¾ã—ãŸã€‚"
              echo ""
              echo "## ä¿®æ­£å†…å®¹"
              echo ""
              echo "- TODO: ä¿®æ­£å†…å®¹ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„"
              echo ""
              echo "## å½±éŸ¿ç¯„å›²"
              echo ""
              echo "- TODO: å½±éŸ¿ç¯„å›²ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„"
              echo ""
              echo "## ãƒ†ã‚¹ãƒˆè¨ˆç”»"
              echo ""
              echo "- [ ] TODO: ãƒ†ã‚¹ãƒˆé …ç›®ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„"
              echo ""
              echo "## æ³¨æ„äº‹é …"
              echo ""
              echo "WARNING: ã“ã®PRã¯mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ç›´æŽ¥ãƒžãƒ¼ã‚¸ã§ã™ã€‚æ…Žé‡ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚"
              echo ""
              echo "## ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«"
              echo ""
              echo "é€šå¸¸ã¯ version:patch ã‚’ä»˜ä¸Žã—ã¦ãã ã•ã„ã€‚"
            } > /tmp/pr_body.md
          fi

          # PRã‚’ä½œæˆ
          gh pr create \
            --base "$BASE_BRANCH" \
            --head "$BRANCH_NAME" \
            --title "$TITLE" \
            --body-file /tmp/pr_body.md

          echo "PR created successfully"

      - name: Summary
        if: always()
        run: |
          echo "### ðŸš€ Auto PR Creation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_pr.outputs.exists }}" == "true" ]; then
            echo "â„¹ï¸ **PR Already Exists**: #${{ steps.check_pr.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **PR Created**: ${{ github.ref_name }} â†’ ${{ steps.target.outputs.base }}" >> $GITHUB_STEP_SUMMARY
          fi
