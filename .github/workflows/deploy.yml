name: Daily Deploy to Railway

on:
  # æ¯æ—¥UTC 17:00ï¼ˆæ—¥æœ¬æ™‚é–“ 2:00ï¼‰ã«è‡ªå‹•å®Ÿè¡Œ
  schedule:
    - cron: '0 17 * * *'

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:

jobs:
  merge-and-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # ãƒªãƒªãƒ¼ã‚¹ä½œæˆã€ã‚¿ã‚°ä½œæˆã€PRãƒãƒ¼ã‚¸ã«å¿…è¦
      pull-requests: write  # PRä½œæˆã«å¿…è¦

    steps:
      - name: Checkout develop branch
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆã‚¿ã‚°ã¨ã‚³ãƒŸãƒƒãƒˆå±¥æ­´å–å¾—ã®ãŸã‚ï¼‰

      - name: Get last deployment tag
        id: last_deploy
        run: |
          # æœ€æ–°ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¿ã‚°ã‚’å–å¾—ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯æœ€åˆã®ã‚³ãƒŸãƒƒãƒˆï¼‰
          LAST_DEPLOY_TAG=$(git tag -l "deploy-*" --sort=-version:refname | head -n 1)

          if [ -z "$LAST_DEPLOY_TAG" ]; then
            # åˆå›ãƒ‡ãƒ—ãƒ­ã‚¤ã®å ´åˆã€æœ€åˆã®ã‚³ãƒŸãƒƒãƒˆã‹ã‚‰
            LAST_COMMIT=$(git rev-list --max-parents=0 HEAD)
            echo "last_commit=$LAST_COMMIT" >> $GITHUB_OUTPUT
            echo "is_first_deploy=true" >> $GITHUB_OUTPUT
          else
            LAST_COMMIT=$(git rev-list -n 1 $LAST_DEPLOY_TAG)
            echo "last_commit=$LAST_COMMIT" >> $GITHUB_OUTPUT
            echo "last_deploy_tag=$LAST_DEPLOY_TAG" >> $GITHUB_OUTPUT
            echo "is_first_deploy=false" >> $GITHUB_OUTPUT
          fi

          echo "Last deployment commit: $LAST_COMMIT"

      - name: Check if develop has changes
        id: check_changes
        run: |
          # developã¨mainã®å·®åˆ†ã‚’ç¢ºèª
          git fetch origin main
          DIFF_COUNT=$(git rev-list --count origin/main..develop)

          if [ "$DIFF_COUNT" -eq 0 ]; then
            echo "No changes in develop since last deployment"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Found $DIFF_COUNT commits in develop"
          fi

      - name: Collect merged PRs and determine version bump
        if: steps.check_changes.outputs.has_changes == 'true'
        id: version_check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # mainã¨developã®å·®åˆ†ã‹ã‚‰ãƒãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆã‚’å–å¾—
          MERGE_COMMITS=$(git log origin/main..develop --merges --pretty=format:"%H %s" | grep "Merge pull request" || true)

          if [ -z "$MERGE_COMMITS" ]; then
            echo "No PRs merged since last deployment"
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Merged PRs since last deployment:"
          echo "$MERGE_COMMITS"

          # PRãƒŠãƒ³ãƒãƒ¼ã‚’æŠ½å‡ºã—ã¦ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
          HAS_MAJOR=false
          HAS_MINOR=false
          HAS_PATCH=false
          PR_LIST=""

          while read -r commit_hash commit_msg; do
            PR_NUMBER=$(echo "$commit_msg" | grep -oP '#\K\d+' || true)
            if [ -n "$PR_NUMBER" ]; then
              echo "Checking PR #$PR_NUMBER..."
              LABELS=$(gh pr view $PR_NUMBER --json labels --jq '.labels[].name' || true)

              if echo "$LABELS" | grep -q "version:major"; then
                HAS_MAJOR=true
              elif echo "$LABELS" | grep -q "version:minor"; then
                HAS_MINOR=true
              elif echo "$LABELS" | grep -q "version:patch"; then
                HAS_PATCH=true
              fi

              PR_LIST="$PR_LIST #$PR_NUMBER"
            fi
          done <<< "$MERGE_COMMITS"

          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒ—ã‚’æ±ºå®š
          if [ "$HAS_MAJOR" = true ]; then
            BUMP_TYPE="major"
          elif [ "$HAS_MINOR" = true ]; then
            BUMP_TYPE="minor"
          elif [ "$HAS_PATCH" = true ]; then
            BUMP_TYPE="patch"
          else
            echo "No version labels found in merged PRs"
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "should_release=true" >> $GITHUB_OUTPUT
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          echo "pr_list=$PR_LIST" >> $GITHUB_OUTPUT
          echo "Version bump type: $BUMP_TYPE"
          echo "Related PRs: $PR_LIST"

      - name: Calculate new version
        if: steps.version_check.outputs.should_release == 'true'
        id: new_version
        run: |
          # æœ€æ–°ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°ã‚’å–å¾—
          LATEST_TAG=$(git describe --tags --abbrev=0 --match "v*.*.*" 2>/dev/null || echo "v0.0.0")
          echo "Latest version tag: $LATEST_TAG"

          # vã‚’é™¤ã„ãŸæ•°å€¤éƒ¨åˆ†ã‚’æŠ½å‡º
          VERSION=${LATEST_TAG#v}
          IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
          MAJOR=${VERSION_PARTS[0]:-0}
          MINOR=${VERSION_PARTS[1]:-0}
          PATCH=${VERSION_PARTS[2]:-0}

          echo "Current version: $MAJOR.$MINOR.$PATCH"

          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
          BUMP_TYPE="${{ steps.version_check.outputs.bump_type }}"
          if [ "$BUMP_TYPE" = "major" ]; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif [ "$BUMP_TYPE" = "minor" ]; then
            MINOR=$((MINOR + 1))
            PATCH=0
          elif [ "$BUMP_TYPE" = "patch" ]; then
            PATCH=$((PATCH + 1))
          fi

          NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
          echo "New version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Create release notes
        if: steps.version_check.outputs.should_release == 'true'
        id: release_notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LAST_COMMIT="${{ steps.last_deploy.outputs.last_commit }}"
          PR_LIST="${{ steps.version_check.outputs.pr_list }}"

          # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆä½œæˆ
          RELEASE_NOTES="## æ›´æ–°å†…å®¹\n\n"

          for PR_NUMBER in $PR_LIST; do
            PR_NUMBER=${PR_NUMBER#\#}
            PR_INFO=$(gh pr view $PR_NUMBER --json title,body,labels)
            PR_TITLE=$(echo "$PR_INFO" | jq -r '.title')
            PR_BODY=$(echo "$PR_INFO" | jq -r '.body')

            # PRæœ¬æ–‡ã‹ã‚‰ã€Œãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ï¼‰ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŠ½å‡º
            USER_NOTES=$(echo "$PR_BODY" | awk '
              /^## ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ï¼‰/ {flag=1; next}
              /^## / {flag=0}
              flag && /^[^<]/ {print}
            ' | sed '/^$/d' | sed '/^-$/d')

            if [ -n "$USER_NOTES" ]; then
              RELEASE_NOTES="${RELEASE_NOTES}${USER_NOTES}\n"
            else
              RELEASE_NOTES="${RELEASE_NOTES}- ${PR_TITLE} (#${PR_NUMBER})\n"
            fi
          done

          # è¤‡æ•°è¡Œã®å‡ºåŠ›ã‚’æ­£ã—ãæ‰±ã†
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          echo -e "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create and merge PR from develop to main
        if: steps.check_changes.outputs.has_changes == 'true'
        id: merge_pr
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          PR_LIST: ${{ steps.version_check.outputs.pr_list }}
          SHOULD_RELEASE: ${{ steps.version_check.outputs.should_release }}
          NEW_VERSION: ${{ steps.new_version.outputs.new_version }}
          BUMP_TYPE: ${{ steps.version_check.outputs.bump_type }}
        run: |
          # develop â†’ main ã®PRã‚’ä½œæˆ
          PR_TITLE="chore: Daily deployment $(date -u +%Y-%m-%d)"

          if [ "$SHOULD_RELEASE" = "true" ]; then
            VERSION_INFO="- **Version**: $NEW_VERSION
- **Type**: $BUMP_TYPE"
          else
            VERSION_INFO="- ãƒªãƒªãƒ¼ã‚¹ãªã—ï¼ˆversion:*ãƒ©ãƒ™ãƒ«ãªã—ï¼‰"
          fi

          PR_BODY="## è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤PR

ã“ã®PRã¯æ¯æ—¥æ·±å¤œ2:00ã«è‡ªå‹•ä½œæˆã•ã‚Œã¾ã™ã€‚

### å«ã¾ã‚Œã‚‹å¤‰æ›´
$PR_LIST

### ãƒãƒ¼ã‚¸ãƒ§ãƒ³
$VERSION_INFO

ğŸ¤– This PR is automatically generated by GitHub Actions"

          PR_URL=$(gh pr create \
            --base main \
            --head develop \
            --title "$PR_TITLE" \
            --body "$PR_BODY")

          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "Created PR: $PR_URL"

          # PRã‚’è‡ªå‹•ãƒãƒ¼ã‚¸
          PR_NUMBER=$(echo "$PR_URL" | grep -oP '\d+$')
          gh pr merge $PR_NUMBER --merge --auto

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "Merged PR #$PR_NUMBER"

      - name: Checkout main branch
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Create deployment tag
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          # ç¾åœ¨ã®æ—¥æ™‚ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¿ã‚°ã‚’ä½œæˆ
          DEPLOY_TAG="deploy-$(date -u +%Y%m%d-%H%M%S)"
          git tag $DEPLOY_TAG
          git push origin $DEPLOY_TAG
          echo "Created deployment tag: $DEPLOY_TAG"

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway
        id: railway_deploy
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway up --service edc96582-ae82-460d-babb-086eecd15167
          echo "deploy_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        if: steps.version_check.outputs.should_release == 'true' && steps.railway_deploy.outcome == 'success'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.new_version }}"
          RELEASE_NOTES="${{ steps.release_notes.outputs.release_notes }}"

          gh release create "$NEW_VERSION" \
            --title "$NEW_VERSION" \
            --notes "$RELEASE_NOTES" \
            --target main

          echo "âœ… GitHub Release created: $NEW_VERSION"

      - name: Summary
        if: always()
        run: |
          echo "### ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_changes.outputs.has_changes }}" == "false" ]; then
            echo "â„¹ï¸ **No Changes**: develop has no changes since last deployment" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          if [ -n "${{ steps.merge_pr.outputs.pr_url }}" ]; then
            echo "âœ… **PR Merged**: ${{ steps.merge_pr.outputs.pr_url }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.railway_deploy.outcome }}" == "success" ]; then
            echo "âœ… **Railway Deploy**: Success" >> $GITHUB_STEP_SUMMARY
            echo "- **Time**: ${{ steps.railway_deploy.outputs.deploy_time }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Railway Deploy**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.version_check.outputs.should_release }}" == "true" ]; then
            echo "ğŸ“¦ **Release Created**: ${{ steps.new_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Type**: ${{ steps.version_check.outputs.bump_type }}" >> $GITHUB_STEP_SUMMARY
            echo "- **PRs**: ${{ steps.version_check.outputs.pr_list }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **No Release**: No version labels in merged PRs" >> $GITHUB_STEP_SUMMARY
          fi
