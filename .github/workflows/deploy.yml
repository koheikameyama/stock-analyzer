name: Daily Release

on:
  # æ¯æ—¥UTC 11:00ï¼ˆæ—¥æœ¬æ™‚é–“ 20:00ï¼‰ã«è‡ªå‹•å®Ÿè¡Œ
  schedule:
    - cron: '0 11 * * *'

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:

jobs:
  create-release:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # ãƒªãƒªãƒ¼ã‚¹ä½œæˆã€ã‚¿ã‚°ä½œæˆã«å¿…è¦
      pull-requests: read  # PRæƒ…å ±ã®èª­ã¿å–ã‚Šã«å¿…è¦

    steps:
      - name: Check branch
        run: |
          # æ‰‹å‹•å®Ÿè¡Œã®å ´åˆã€developãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ã®ã¿å®Ÿè¡Œå¯èƒ½
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ github.ref }}" != "refs/heads/develop" ]; then
              echo "âŒ ã‚¨ãƒ©ãƒ¼: ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯developãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ã®ã¿å®Ÿè¡Œã§ãã¾ã™"
              echo "ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref }}"
              exit 1
            fi
          fi

      - name: Checkout develop branch
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆã‚¿ã‚°ã¨ã‚³ãƒŸãƒƒãƒˆå±¥æ­´å–å¾—ã®ãŸã‚ï¼‰

      - name: Get last deployment tag
        id: last_deploy
        run: |
          # æœ€æ–°ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¿ã‚°ã‚’å–å¾—ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯æœ€åˆã®ã‚³ãƒŸãƒƒãƒˆï¼‰
          LAST_DEPLOY_TAG=$(git tag -l "deploy-*" --sort=-version:refname | head -n 1)

          if [ -z "$LAST_DEPLOY_TAG" ]; then
            # åˆå›ãƒ‡ãƒ—ãƒ­ã‚¤ã®å ´åˆã€æœ€åˆã®ã‚³ãƒŸãƒƒãƒˆã‹ã‚‰
            LAST_COMMIT=$(git rev-list --max-parents=0 HEAD)
            echo "last_commit=$LAST_COMMIT" >> $GITHUB_OUTPUT
            echo "is_first_deploy=true" >> $GITHUB_OUTPUT
          else
            LAST_COMMIT=$(git rev-list -n 1 $LAST_DEPLOY_TAG)
            echo "last_commit=$LAST_COMMIT" >> $GITHUB_OUTPUT
            echo "last_deploy_tag=$LAST_DEPLOY_TAG" >> $GITHUB_OUTPUT
            echo "is_first_deploy=false" >> $GITHUB_OUTPUT
          fi

          echo "Last deployment commit: $LAST_COMMIT"

      - name: Check if develop has changes
        id: check_changes
        run: |
          # developã¨mainã®å·®åˆ†ã‚’ç¢ºèª
          git fetch origin main
          DIFF_COUNT=$(git rev-list --count origin/main..develop)

          if [ "$DIFF_COUNT" -eq 0 ]; then
            echo "No changes in develop since last deployment"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Found $DIFF_COUNT commits in develop"
          fi

      - name: Get info from existing deploy PR
        if: steps.check_changes.outputs.has_changes == 'true'
        id: version_check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # create-deploy-pr.ymlãŒä½œæˆã—ãŸdevelopâ†’mainã®PRã‚’å–å¾—
          DEPLOY_PR=$(gh pr list --head develop --base main --state open --json number,body --jq '.[0]')

          if [ -z "$DEPLOY_PR" ] || [ "$DEPLOY_PR" = "null" ]; then
            echo "No deploy PR found"
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          DEPLOY_PR_NUMBER=$(echo "$DEPLOY_PR" | jq -r '.number')
          DEPLOY_PR_BODY=$(echo "$DEPLOY_PR" | jq -r '.body')

          echo "Found deploy PR #$DEPLOY_PR_NUMBER"

          # PRæœ¬æ–‡ã‹ã‚‰ã€Œå«ã¾ã‚Œã‚‹å¤‰æ›´ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŠ½å‡º
          PR_LIST=$(echo "$DEPLOY_PR_BODY" | awk '
            /^### å«ã¾ã‚Œã‚‹å¤‰æ›´/ {flag=1; next}
            /^### / {flag=0}
            flag && /^- / {print}
          ')

          if [ -z "$PR_LIST" ]; then
            echo "No changes found in deploy PR"
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "PR List from deploy PR:"
          echo "$PR_LIST"

          # PRãƒªã‚¹ãƒˆã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«ä»˜ãPRã®ã¿ã‚’æŠ½å‡ºã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘èª¬æ˜ã‚’å–å¾—
          HAS_MAJOR=false
          HAS_MINOR=false
          HAS_PATCH=false
          USER_FACING_CHANGES=""

          while IFS= read -r line; do
            # è¡ŒãŒç©ºã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            [ -z "$line" ] && continue

            # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
            if echo "$line" | grep -q "\[major\]"; then
              HAS_MAJOR=true
              LABEL_TYPE="major"
            elif echo "$line" | grep -q "\[minor\]"; then
              HAS_MINOR=true
              LABEL_TYPE="minor"
            elif echo "$line" | grep -q "\[patch\]"; then
              HAS_PATCH=true
              LABEL_TYPE="patch"
            else
              # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«ãŒãªã„è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
              continue
            fi

            # PRç•ªå·ã‚’æŠ½å‡ºï¼ˆãƒªãƒ³ã‚¯å½¢å¼ã‹ã‚‰ï¼‰
            PR_NUMBER=$(echo "$line" | grep -oP 'pull/\K\d+' | head -1)

            if [ -n "$PR_NUMBER" ]; then
              echo "Fetching user-facing description from PR #$PR_NUMBER"
              # PRã®æœ¬æ–‡ã‹ã‚‰ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘èª¬æ˜ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—
              PR_BODY=$(gh pr view $PR_NUMBER --json body --jq '.body')
              USER_DESC=$(echo "$PR_BODY" | awk '
                /^## ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘èª¬æ˜/ {flag=1; next}
                /^## / {flag=0}
                flag && NF {print; found=1}
                END {if (!found) print ""}
              ' | head -1)

              # ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘èª¬æ˜ãŒã‚ã‚‹å ´åˆã®ã¿è¿½åŠ 
              if [ -n "$USER_DESC" ]; then
                USER_FACING_CHANGES="${USER_FACING_CHANGES}- ${USER_DESC}\n"
              fi
            fi
          done <<< "$PR_LIST"

          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒ—ã‚’æ±ºå®š
          if [ "$HAS_MAJOR" = true ]; then
            BUMP_TYPE="major"
          elif [ "$HAS_MINOR" = true ]; then
            BUMP_TYPE="minor"
          elif [ "$HAS_PATCH" = true ]; then
            BUMP_TYPE="patch"
          else
            echo "No version labels found in PR list"
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘å¤‰æ›´ãŒãªã„å ´åˆã¯ãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆã—ãªã„
          if [ -z "$USER_FACING_CHANGES" ]; then
            echo "No user-facing changes found"
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "should_release=true" >> $GITHUB_OUTPUT
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          echo "user_facing_changes<<EOF" >> $GITHUB_OUTPUT
          echo -e "$USER_FACING_CHANGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Version bump type: $BUMP_TYPE"

      - name: Calculate new version
        if: steps.version_check.outputs.should_release == 'true'
        id: new_version
        run: |
          # æœ€æ–°ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°ã‚’å–å¾—
          LATEST_TAG=$(git describe --tags --abbrev=0 --match "v*.*.*" 2>/dev/null || echo "v0.0.0")
          echo "Latest version tag: $LATEST_TAG"

          # vã‚’é™¤ã„ãŸæ•°å€¤éƒ¨åˆ†ã‚’æŠ½å‡º
          VERSION=${LATEST_TAG#v}
          IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
          MAJOR=${VERSION_PARTS[0]:-0}
          MINOR=${VERSION_PARTS[1]:-0}
          PATCH=${VERSION_PARTS[2]:-0}

          echo "Current version: $MAJOR.$MINOR.$PATCH"

          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
          BUMP_TYPE="${{ steps.version_check.outputs.bump_type }}"
          if [ "$BUMP_TYPE" = "major" ]; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif [ "$BUMP_TYPE" = "minor" ]; then
            MINOR=$((MINOR + 1))
            PATCH=0
          elif [ "$BUMP_TYPE" = "patch" ]; then
            PATCH=$((PATCH + 1))
          fi

          NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
          echo "New version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Create release notes
        if: steps.version_check.outputs.should_release == 'true'
        id: release_notes
        run: |
          USER_FACING_CHANGES="${{ steps.version_check.outputs.user_facing_changes }}"

          # ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘å¤‰æ›´ã®ã¿ã‚’ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã¨ã—ã¦ä½¿ç”¨
          RELEASE_NOTES="## æ›´æ–°å†…å®¹\n\n$USER_FACING_CHANGES"

          # è¤‡æ•°è¡Œã®å‡ºåŠ›ã‚’æ­£ã—ãæ‰±ã†
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          echo -e "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Merge deploy PR
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # ãƒ‡ãƒ—ãƒ­ã‚¤PRï¼ˆdevelopâ†’mainï¼‰ã‚’å–å¾—
          DEPLOY_PR=$(gh pr list --head develop --base main --state open --json number --jq '.[0].number')

          if [ -z "$DEPLOY_PR" ] || [ "$DEPLOY_PR" = "null" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ—ãƒ­ã‚¤PRãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

          echo "ãƒ‡ãƒ—ãƒ­ã‚¤PR #$DEPLOY_PR ã‚’ãƒãƒ¼ã‚¸ã—ã¾ã™"

          # PRã‚’ãƒãƒ¼ã‚¸
          gh pr merge $DEPLOY_PR --merge

          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤PR #$DEPLOY_PR ã‚’ãƒãƒ¼ã‚¸ã—ã¾ã—ãŸ"

      - name: Checkout main branch
        if: steps.check_changes.outputs.has_changes == 'true' && steps.version_check.outputs.should_release == 'true'
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Create GitHub Release
        if: steps.check_changes.outputs.has_changes == 'true' && steps.version_check.outputs.should_release == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.new_version }}"
          RELEASE_NOTES="${{ steps.release_notes.outputs.release_notes }}"

          gh release create "$NEW_VERSION" \
            --title "$NEW_VERSION" \
            --notes "$RELEASE_NOTES" \
            --target main

          echo "âœ… GitHub Release created: $NEW_VERSION"

      - name: Summary
        if: always()
        run: |
          echo "### ğŸš€ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_changes.outputs.has_changes }}" == "false" ]; then
            echo "â„¹ï¸ **No Changes**: develop has no changes since last deployment" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          echo "âœ… **Deploy PR Merged**: develop â†’ main" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.version_check.outputs.should_release }}" == "true" ]; then
            echo "ğŸ“¦ **Release Created**: ${{ steps.new_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Type**: ${{ steps.version_check.outputs.bump_type }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### User-Facing Changes" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.version_check.outputs.user_facing_changes }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **No Release Created**: No version labels found in deploy PR" >> $GITHUB_STEP_SUMMARY
            echo "- ãƒ‡ãƒ—ãƒ­ã‚¤PRã¯ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸãŒã€version:*ãƒ©ãƒ™ãƒ«ãŒä»˜ã„ã¦ã„ãªã„ãŸã‚ã€ãƒªãƒªãƒ¼ã‚¹ã¯ä½œæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_STEP_SUMMARY
            echo "- å†…éƒ¨æ”¹å–„ã‚„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ãªã©ã®å¤‰æ›´ã¯ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™" >> $GITHUB_STEP_SUMMARY
          fi
