name: Deploy and Release

on:
  # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushï¼ˆPRãƒãƒ¼ã‚¸ï¼‰æ™‚ã«å®Ÿè¡Œ
  push:
    branches:
      - main

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:

jobs:
  create-release:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # ãƒªãƒªãƒ¼ã‚¹ä½œæˆã€ã‚¿ã‚°ä½œæˆã«å¿…è¦
      pull-requests: write  # PRä½œæˆãƒ»ãƒãƒ¼ã‚¸ã«å¿…è¦

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆã‚¿ã‚°ã¨ã‚³ãƒŸãƒƒãƒˆå±¥æ­´å–å¾—ã®ãŸã‚ï¼‰

      - name: Get merged deploy PR info
        id: version_check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # æœ€æ–°ã®ãƒãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆã‹ã‚‰PRç•ªå·ã‚’å–å¾—
          MERGE_COMMIT_MSG=$(git log -1 --pretty=%B)
          PR_NUMBER=$(echo "$MERGE_COMMIT_MSG" | grep -oP '#\K\d+' | head -1)

          if [ -z "$PR_NUMBER" ]; then
            echo "No PR number found in merge commit"
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found merged PR #$PR_NUMBER"

          # ãƒãƒ¼ã‚¸ã•ã‚ŒãŸPRã®æƒ…å ±ã‚’å–å¾—
          DEPLOY_PR=$(gh pr view $PR_NUMBER --json body,baseRefName,headRefName --jq '.')
          BASE_BRANCH=$(echo "$DEPLOY_PR" | jq -r '.baseRefName')
          HEAD_BRANCH=$(echo "$DEPLOY_PR" | jq -r '.headRefName')

          # developâ†’mainã®PRã§ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
          if [ "$BASE_BRANCH" != "main" ] || [ "$HEAD_BRANCH" != "develop" ]; then
            echo "Not a deploy PR (developâ†’main)"
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          DEPLOY_PR_BODY=$(echo "$DEPLOY_PR" | jq -r '.body')

          echo "Found deploy PR #$PR_NUMBER"

          # PRæœ¬æ–‡ã‹ã‚‰ã€Œå«ã¾ã‚Œã‚‹å¤‰æ›´ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŠ½å‡º
          PR_LIST=$(echo "$DEPLOY_PR_BODY" | awk '
            /^### å«ã¾ã‚Œã‚‹å¤‰æ›´/ {flag=1; next}
            /^### / {flag=0}
            flag && /^- / {print}
          ')

          if [ -z "$PR_LIST" ]; then
            echo "No changes found in deploy PR"
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "PR List from deploy PR:"
          echo "$PR_LIST"

          # PRãƒªã‚¹ãƒˆã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
          HAS_MAJOR=false
          HAS_MINOR=false
          HAS_PATCH=false
          VERSION_LABELED_PRS=""

          while IFS= read -r line; do
            # è¡ŒãŒç©ºã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            [ -z "$line" ] && continue

            # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
            if echo "$line" | grep -q "\[major\]"; then
              HAS_MAJOR=true
              VERSION_LABELED_PRS="${VERSION_LABELED_PRS}${line}\n"
            elif echo "$line" | grep -q "\[minor\]"; then
              HAS_MINOR=true
              VERSION_LABELED_PRS="${VERSION_LABELED_PRS}${line}\n"
            elif echo "$line" | grep -q "\[patch\]"; then
              HAS_PATCH=true
              VERSION_LABELED_PRS="${VERSION_LABELED_PRS}${line}\n"
            fi
          done <<< "$PR_LIST"

          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒ—ã‚’æ±ºå®š
          if [ "$HAS_MAJOR" = true ]; then
            BUMP_TYPE="major"
          elif [ "$HAS_MINOR" = true ]; then
            BUMP_TYPE="minor"
          elif [ "$HAS_PATCH" = true ]; then
            BUMP_TYPE="patch"
          else
            echo "No version labels found in PR list"
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«ä»˜ãPRãŒãªã„å ´åˆã¯ãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆã—ãªã„
          if [ -z "$VERSION_LABELED_PRS" ]; then
            echo "No version labeled PRs found"
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "should_release=true" >> $GITHUB_OUTPUT
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          echo "version_labeled_prs<<EOF" >> $GITHUB_OUTPUT
          echo -e "$VERSION_LABELED_PRS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Version bump type: $BUMP_TYPE"

      - name: Calculate new version
        if: steps.version_check.outputs.should_release == 'true'
        id: new_version
        run: |
          # æœ€æ–°ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°ã‚’å–å¾—
          LATEST_TAG=$(git describe --tags --abbrev=0 --match "v*.*.*" 2>/dev/null || echo "v0.0.0")
          echo "Latest version tag: $LATEST_TAG"

          # vã‚’é™¤ã„ãŸæ•°å€¤éƒ¨åˆ†ã‚’æŠ½å‡º
          VERSION=${LATEST_TAG#v}
          IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
          MAJOR=${VERSION_PARTS[0]:-0}
          MINOR=${VERSION_PARTS[1]:-0}
          PATCH=${VERSION_PARTS[2]:-0}

          echo "Current version: $MAJOR.$MINOR.$PATCH"

          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
          BUMP_TYPE="${{ steps.version_check.outputs.bump_type }}"
          if [ "$BUMP_TYPE" = "major" ]; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif [ "$BUMP_TYPE" = "minor" ]; then
            MINOR=$((MINOR + 1))
            PATCH=0
          elif [ "$BUMP_TYPE" = "patch" ]; then
            PATCH=$((PATCH + 1))
          fi

          NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
          echo "New version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Generate user-facing descriptions with AI
        if: steps.version_check.outputs.should_release == 'true'
        id: ai_descriptions
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          VERSION_LABELED_PRS="${{ steps.version_check.outputs.version_labeled_prs }}"

          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          {
            echo "ä»¥ä¸‹ã¯ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã®PRã‚¿ã‚¤ãƒˆãƒ«ã®ãƒªã‚¹ãƒˆã§ã™ã€‚ã“ã‚Œã‚‰ã‚’ã‚‚ã¨ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®è¯ã‚„ã‹ã§åˆ†ã‹ã‚Šã‚„ã™ã„èª¬æ˜ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚"
            echo ""
            echo "è¦ä»¶:"
            echo "- å„PRã®å†…å®¹ã‚’ç†è§£ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¨ã£ã¦ã®ãƒ¡ãƒªãƒƒãƒˆã‚’èª¬æ˜"
            echo "- çµµæ–‡å­—ã‚’ç©æ¥µçš„ã«ä½¿ç”¨"
            echo "- å„èª¬æ˜ã¯1è¡Œã§ç°¡æ½”ã«"
            echo "- 3ã‹ã‚‰5å€‹ã®ç®‡æ¡æ›¸ãã«ã¾ã¨ã‚ã‚‹"
            echo "- èªå°¾ã¯ã€Œã—ã¾ã—ãŸã€ã€Œã§ãã¾ã™ã€ãªã©ã‚’ä½¿ç”¨"
            echo "- ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«ã¯å‡ºåŠ›ã«å«ã‚ãªã„"
            echo ""
            echo "å‡ºåŠ›å½¢å¼ï¼ˆãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã€ç®‡æ¡æ›¸ããƒãƒ¼ã‚¯ä¸è¦ï¼‰:"
            echo "æ©Ÿèƒ½Aã‚’è¿½åŠ ã—ã¾ã—ãŸ"
            echo "æ©Ÿèƒ½BãŒä½¿ã„ã‚„ã™ããªã‚Šã¾ã—ãŸ"
            echo "ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒå‘ä¸Šã—ã¾ã—ãŸ"
            echo ""
            echo "PRãƒªã‚¹ãƒˆ:"
            echo "$VERSION_LABELED_PRS"
          } > /tmp/ai_prompt.txt

          # OpenAI APIã§èª¬æ˜ã‚’ç”Ÿæˆ
          PROMPT_CONTENT=$(cat /tmp/ai_prompt.txt | jq -Rs .)

          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "{\"model\":\"gpt-4o-mini\",\"messages\":[{\"role\":\"user\",\"content\":$PROMPT_CONTENT}],\"temperature\":0.7,\"max_tokens\":500}")

          AI_DESCRIPTIONS=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')

          echo "AI Generated Descriptions:"
          echo "$AI_DESCRIPTIONS"

          echo "ai_descriptions<<EOF" >> $GITHUB_OUTPUT
          echo "$AI_DESCRIPTIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create release notes
        if: steps.version_check.outputs.should_release == 'true'
        id: release_notes
        run: |
          AI_DESCRIPTIONS="${{ steps.ai_descriptions.outputs.ai_descriptions }}"

          # AIç”Ÿæˆã®èª¬æ˜ã‚’ç®‡æ¡æ›¸ãã«å¤‰æ›
          USER_FACING_CHANGES=""
          while IFS= read -r line; do
            if [ -n "$line" ]; then
              USER_FACING_CHANGES="${USER_FACING_CHANGES}- ${line}\n"
            fi
          done <<< "$AI_DESCRIPTIONS"

          # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ä½œæˆ
          RELEASE_NOTES="## æ›´æ–°å†…å®¹\n\n$USER_FACING_CHANGES"

          # è¤‡æ•°è¡Œã®å‡ºåŠ›ã‚’æ­£ã—ãæ‰±ã†
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          echo -e "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        if: steps.version_check.outputs.should_release == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.new_version }}"
          RELEASE_NOTES="${{ steps.release_notes.outputs.release_notes }}"

          gh release create "$NEW_VERSION" \
            --title "$NEW_VERSION" \
            --notes "$RELEASE_NOTES" \
            --target main

          echo "âœ… GitHub Release created: $NEW_VERSION"

      - name: Sync main to develop
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # mainâ†’developã®åŒæœŸPRã‚’ä½œæˆ
          SYNC_PR=$(gh pr list --head main --base develop --state open --json number --jq '.[0].number')

          if [ -n "$SYNC_PR" ] && [ "$SYNC_PR" != "null" ]; then
            echo "Sync PR #$SYNC_PR already exists, merging..."
            gh pr merge $SYNC_PR --merge
          else
            echo "Creating sync PR: main â†’ develop"
            gh pr create \
              --base develop \
              --head main \
              --title "chore: Sync main to develop" \
              --body "Automatic sync from main to develop after deployment"

            # ä½œæˆã—ãŸPRã‚’å³åº§ã«ãƒãƒ¼ã‚¸
            NEW_SYNC_PR=$(gh pr list --head main --base develop --state open --json number --jq '.[0].number')
            if [ -n "$NEW_SYNC_PR" ] && [ "$NEW_SYNC_PR" != "null" ]; then
              gh pr merge $NEW_SYNC_PR --merge
              echo "âœ… Synced main to develop via PR #$NEW_SYNC_PR"
            fi
          fi

      - name: Summary
        if: always()
        run: |
          echo "### ğŸš€ Deploy Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.version_check.outputs.should_release }}" == "true" ]; then
            echo "âœ… **Deployed**: develop â†’ main" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“¦ **Release Created**: ${{ steps.new_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Type**: ${{ steps.version_check.outputs.bump_type }}" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ”„ **Synced**: main â†’ develop" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Deployed**: develop â†’ main (no release)" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ï¸ version:*ãƒ©ãƒ™ãƒ«ãŒãªã„ãŸã‚ã€ãƒªãƒªãƒ¼ã‚¹ã¯ä½œæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ”„ **Synced**: main â†’ develop" >> $GITHUB_STEP_SUMMARY
          fi
