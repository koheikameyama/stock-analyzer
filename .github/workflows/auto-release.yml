name: Auto Release

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  create-release:
    # PRがマージされ、かつversion:major/minorラベルが付いている場合のみ実行
    # version:patchの場合はリリースを作成しない（次のリリースにまとめる）
    if: github.event.pull_request.merged == true && (contains(github.event.pull_request.labels.*.name, 'version:major') || contains(github.event.pull_request.labels.*.name, 'version:minor'))
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 全履歴を取得（タグ情報取得のため）

      - name: Get latest version and calculate new version
        id: version
        env:
          PR_LABELS: ${{ toJson(github.event.pull_request.labels.*.name) }}
        run: |
          # 最新のタグを取得（存在しない場合はv0.0.0）
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Latest tag: $LATEST_TAG"

          # vを除いた数値部分を抽出
          VERSION=${LATEST_TAG#v}
          IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
          MAJOR=${VERSION_PARTS[0]:-0}
          MINOR=${VERSION_PARTS[1]:-0}
          PATCH=${VERSION_PARTS[2]:-0}

          echo "Current version: $MAJOR.$MINOR.$PATCH"

          # ラベルに応じてバージョンをインクリメント
          if echo "$PR_LABELS" | grep -q "version:major"; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            BUMP_TYPE="major"
          elif echo "$PR_LABELS" | grep -q "version:minor"; then
            MINOR=$((MINOR + 1))
            PATCH=0
            BUMP_TYPE="minor"
          elif echo "$PR_LABELS" | grep -q "version:patch"; then
            PATCH=$((PATCH + 1))
            BUMP_TYPE="patch"
          fi

          NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
          echo "New version: $NEW_VERSION"

          # 環境変数に保存
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT

      - name: Create release body
        id: release_body
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          # リリースノート作成
          cat >> $GITHUB_OUTPUT <<EOF
          release_body<<RELEASE_EOF
          ## Changes

          $PR_TITLE

          $PR_BODY

          ---
          **Full Changelog**: [#$PR_NUMBER]($PR_URL)
          **Author**: @$AUTHOR
          RELEASE_EOF
          EOF

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "${{ steps.version.outputs.new_version }}" \
            --title "${{ steps.version.outputs.new_version }}" \
            --notes "${{ steps.release_body.outputs.release_body }}" \
            --target main

          echo "✅ GitHub Release created: ${{ steps.version.outputs.new_version }}"

      - name: Summary
        run: |
          echo "### 🚀 Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Type**: ${{ steps.version.outputs.bump_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PR**: #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "📢 Slack notification will be sent automatically" >> $GITHUB_STEP_SUMMARY
