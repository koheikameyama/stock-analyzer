name: Auto Release

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  create-release:
    # PRãŒãƒãƒ¼ã‚¸ã•ã‚Œã€ã‹ã¤version:*ãƒ©ãƒ™ãƒ«ãŒä»˜ã„ã¦ã„ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
    if: github.event.pull_request.merged == true && (contains(github.event.pull_request.labels.*.name, 'version:major') || contains(github.event.pull_request.labels.*.name, 'version:minor') || contains(github.event.pull_request.labels.*.name, 'version:patch'))
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆã‚¿ã‚°æƒ…å ±å–å¾—ã®ãŸã‚ï¼‰

      - name: Get latest version and calculate new version
        id: version
        run: |
          # æœ€æ–°ã®ã‚¿ã‚°ã‚’å–å¾—ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯v0.0.0ï¼‰
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Latest tag: $LATEST_TAG"

          # vã‚’é™¤ã„ãŸæ•°å€¤éƒ¨åˆ†ã‚’æŠ½å‡º
          VERSION=${LATEST_TAG#v}
          IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
          MAJOR=${VERSION_PARTS[0]:-0}
          MINOR=${VERSION_PARTS[1]:-0}
          PATCH=${VERSION_PARTS[2]:-0}

          echo "Current version: $MAJOR.$MINOR.$PATCH"

          # ãƒ©ãƒ™ãƒ«ã«å¿œã˜ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
          LABELS="${{ toJson(github.event.pull_request.labels.*.name) }}"

          if echo "$LABELS" | grep -q "version:major"; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            BUMP_TYPE="major"
          elif echo "$LABELS" | grep -q "version:minor"; then
            MINOR=$((MINOR + 1))
            PATCH=0
            BUMP_TYPE="minor"
          elif echo "$LABELS" | grep -q "version:patch"; then
            PATCH=$((PATCH + 1))
            BUMP_TYPE="patch"
          fi

          NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
          echo "New version: $NEW_VERSION"

          # ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT

      - name: Create release body
        id: release_body
        run: |
          # PRã®ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã‹ã‚‰ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          AUTHOR="${{ github.event.pull_request.user.login }}"

          # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆä½œæˆ
          RELEASE_BODY="## Changes

$PR_TITLE

$PR_BODY

---
**Full Changelog**: [#$PR_NUMBER]($PR_URL)
**Author**: @$AUTHOR"

          # ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜ï¼ˆæ”¹è¡Œå¯¾å¿œï¼‰
          echo "release_body<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "${{ steps.version.outputs.new_version }}" \
            --title "${{ steps.version.outputs.new_version }}" \
            --notes "${{ steps.release_body.outputs.release_body }}" \
            --target main

          echo "âœ… GitHub Release created: ${{ steps.version.outputs.new_version }}"

      - name: Summary
        run: |
          echo "### ğŸš€ Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Type**: ${{ steps.version.outputs.bump_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PR**: #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“¢ Slack notification will be sent automatically" >> $GITHUB_STEP_SUMMARY
