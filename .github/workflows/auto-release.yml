name: Auto Release (Disabled)

# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™
# ãƒªãƒªãƒ¼ã‚¹ä½œæˆã¯ deploy.yml ã§è¡Œã‚ã‚Œã¾ã™

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  create-release:
    # ç„¡åŠ¹åŒ–: ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ãŸã‚ã€ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“
    if: false
    runs-on: ubuntu-latest

    permissions:
      contents: write  # ãƒªãƒªãƒ¼ã‚¹ä½œæˆã¨ã‚¿ã‚°ä½œæˆã«å¿…è¦

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆã‚¿ã‚°æƒ…å ±å–å¾—ã®ãŸã‚ï¼‰

      - name: Get latest version and calculate new version
        id: version
        env:
          PR_LABELS: ${{ toJson(github.event.pull_request.labels.*.name) }}
        run: |
          # æœ€æ–°ã®ã‚¿ã‚°ã‚’å–å¾—ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯v0.0.0ï¼‰
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Latest tag: $LATEST_TAG"

          # vã‚’é™¤ã„ãŸæ•°å€¤éƒ¨åˆ†ã‚’æŠ½å‡º
          VERSION=${LATEST_TAG#v}
          IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
          MAJOR=${VERSION_PARTS[0]:-0}
          MINOR=${VERSION_PARTS[1]:-0}
          PATCH=${VERSION_PARTS[2]:-0}

          echo "Current version: $MAJOR.$MINOR.$PATCH"

          # ãƒ©ãƒ™ãƒ«ã«å¿œã˜ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
          if echo "$PR_LABELS" | grep -q "version:major"; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            BUMP_TYPE="major"
          elif echo "$PR_LABELS" | grep -q "version:minor"; then
            MINOR=$((MINOR + 1))
            PATCH=0
            BUMP_TYPE="minor"
          elif echo "$PR_LABELS" | grep -q "version:patch"; then
            PATCH=$((PATCH + 1))
            BUMP_TYPE="patch"
          fi

          NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
          echo "New version: $NEW_VERSION"

          # ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT

      - name: Create release body
        id: release_body
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          # PRæœ¬æ–‡ã‹ã‚‰ã€Œãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ï¼‰ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŠ½å‡º
          RELEASE_NOTES=$(echo "$PR_BODY" | awk '
            /^## ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ï¼‰/ {flag=1; next}
            /^## / {flag=0}
            flag && /^[^<]/ {print}
          ' | sed '/^$/d' | sed '/^-$/d')

          # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆãŒç©ºã®å ´åˆã¯ã€Œæ¦‚è¦ã€ã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          if [ -z "$RELEASE_NOTES" ]; then
            RELEASE_NOTES=$(echo "$PR_BODY" | awk '
              /^## æ¦‚è¦/ {flag=1; next}
              /^## / {flag=0}
              flag && /^[^<]/ {print}
            ' | sed '/^$/d')
          fi

          # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆãŒã¾ã ç©ºã®å ´åˆã¯PRã‚¿ã‚¤ãƒˆãƒ«ã‚’ä½¿ç”¨
          if [ -z "$RELEASE_NOTES" ]; then
            RELEASE_NOTES="$PR_TITLE"
          fi

          # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆä½œæˆ
          cat >> $GITHUB_OUTPUT <<EOF
          release_body<<RELEASE_EOF
          ## æ›´æ–°å†…å®¹

          $RELEASE_NOTES
          RELEASE_EOF
          EOF

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh release create "${{ steps.version.outputs.new_version }}" \
            --title "${{ steps.version.outputs.new_version }}" \
            --notes "${{ steps.release_body.outputs.release_body }}" \
            --target main

          echo "âœ… GitHub Release created: ${{ steps.version.outputs.new_version }}"

      - name: Summary
        run: |
          echo "### ğŸš€ Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Type**: ${{ steps.version.outputs.bump_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PR**: #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“¢ Slack notification will be sent automatically" >> $GITHUB_STEP_SUMMARY
