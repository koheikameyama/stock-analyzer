name: Create Deploy PR

on:
  push:
    branches:
      - develop

jobs:
  create-pr:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout develop branch
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0

      - name: Check if PR to main is needed
        id: check_pr
        run: |
          # developã¨mainã®å·®åˆ†ã‚’ç¢ºèª
          git fetch origin main
          DIFF_COUNT=$(git rev-list --count origin/main..develop)

          if [ "$DIFF_COUNT" -eq 0 ]; then
            echo "No changes to deploy"
            echo "needs_pr=false" >> $GITHUB_OUTPUT
          else
            echo "Found $DIFF_COUNT commits to deploy"
            echo "needs_pr=true" >> $GITHUB_OUTPUT
          fi

      - name: Check existing PR
        if: steps.check_pr.outputs.needs_pr == 'true'
        id: existing_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # æ—¢å­˜ã®developâ†’mainã®PRãŒã‚ã‚‹ã‹ç¢ºèª
          EXISTING_PR=$(gh pr list --base main --head develop --state open --json number --jq '.[0].number' || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "has_pr=true" >> $GITHUB_OUTPUT
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
            echo "Existing PR found: #$EXISTING_PR"
          else
            echo "has_pr=false" >> $GITHUB_OUTPUT
            echo "No existing PR found"
          fi

      - name: Create PR to main
        if: steps.check_pr.outputs.needs_pr == 'true' && steps.existing_pr.outputs.has_pr == 'false'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # develop â†’ main ã®PRã‚’ä½œæˆ
          PR_TITLE="chore: Ready to deploy $(date -u +%Y-%m-%d)"

          PR_BODY="## ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™å®Œäº†

          developãƒ–ãƒ©ãƒ³ãƒã®å¤‰æ›´ã‚’mainã«ãƒžãƒ¼ã‚¸ã™ã‚‹æº–å‚™ãŒã§ãã¾ã—ãŸã€‚

          ### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
          1. ã“ã®PRã®å†…å®¹ã‚’ç¢ºèª
          2. å•é¡Œãªã‘ã‚Œã°ãƒžãƒ¼ã‚¸
          3. mainã¸ã®ãƒžãƒ¼ã‚¸å¾Œã€RailwayãŒè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤

          âš ï¸ **æ³¨æ„**: ã“ã®PRã¯å‚è€ƒç”¨ã§ã™ã€‚å®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯æ¯Žæ—¥æ·±å¤œ2:00ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã§è¡Œã‚ã‚Œã¾ã™ã€‚"

          PR_URL=$(gh pr create \
            --base main \
            --head develop \
            --title "$PR_TITLE" \
            --body "$PR_BODY")

          echo "Created PR: $PR_URL"

      - name: Summary
        if: always()
        run: |
          echo "### ðŸ“‹ Deploy PR Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_pr.outputs.needs_pr }}" == "false" ]; then
            echo "â„¹ï¸ **No PR Needed**: develop is in sync with main" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.existing_pr.outputs.has_pr }}" == "true" ]; then
            echo "â„¹ï¸ **PR Already Exists**: #${{ steps.existing_pr.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **PR Created**: develop â†’ main" >> $GITHUB_STEP_SUMMARY
          fi
