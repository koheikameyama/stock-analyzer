name: Create Deploy PR

on:
  push:
    branches:
      - develop

jobs:
  create-pr:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout develop branch
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0

      - name: Check if PR to main is needed
        id: check_pr
        run: |
          # develop„Å®main„ÅÆÂ∑ÆÂàÜ„ÇíÁ¢∫Ë™ç
          git fetch origin main
          DIFF_COUNT=$(git rev-list --count origin/main..develop)

          if [ "$DIFF_COUNT" -eq 0 ]; then
            echo "No changes to deploy"
            echo "needs_pr=false" >> $GITHUB_OUTPUT
          else
            echo "Found $DIFF_COUNT commits to deploy"
            echo "needs_pr=true" >> $GITHUB_OUTPUT
          fi

      - name: Check existing PR
        if: steps.check_pr.outputs.needs_pr == 'true'
        id: existing_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Êó¢Â≠ò„ÅÆdevelop‚Üímain„ÅÆPR„Åå„ÅÇ„Çã„ÅãÁ¢∫Ë™ç
          EXISTING_PR=$(gh pr list --base main --head develop --state open --json number --jq '.[0].number' || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "has_pr=true" >> $GITHUB_OUTPUT
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
            echo "Existing PR found: #$EXISTING_PR"
          else
            echo "has_pr=false" >> $GITHUB_OUTPUT
            echo "No existing PR found"
          fi

      - name: Get merged PRs since last deployment
        if: steps.check_pr.outputs.needs_pr == 'true'
        id: get_prs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # main„Å®develop„ÅÆÂ∑ÆÂàÜ„Åã„Çâ„Éû„Éº„Ç∏„Ç≥„Éü„ÉÉ„Éà„ÇíÂèñÂæó
          MERGE_COMMITS=$(git log origin/main..develop --merges --pretty=format:"%H %s" | grep "Merge pull request" || true)

          if [ -z "$MERGE_COMMITS" ]; then
            echo "No merged PRs found"
            echo "pr_list=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # PR„Éä„É≥„Éê„Éº„ÇíÊäΩÂá∫„Åó„Å¶„Çø„Ç§„Éà„É´„ÇíÂèñÂæó
          PR_LIST=""
          while read -r commit_hash commit_msg; do
            PR_NUMBER=$(echo "$commit_msg" | grep -oP '#\K\d+' || true)
            if [ -n "$PR_NUMBER" ]; then
              PR_INFO=$(gh pr view $PR_NUMBER --json title,labels --jq '{title: .title, labels: [.labels[].name]}' || echo '{}')
              PR_TITLE=$(echo "$PR_INFO" | jq -r '.title')
              LABELS=$(echo "$PR_INFO" | jq -r '.labels[]' | tr '\n' ',' | sed 's/,$//')

              if [ -n "$LABELS" ]; then
                PR_LIST="${PR_LIST}- #${PR_NUMBER}: ${PR_TITLE} [${LABELS}]\n"
              else
                PR_LIST="${PR_LIST}- #${PR_NUMBER}: ${PR_TITLE}\n"
              fi
            fi
          done <<< "$MERGE_COMMITS"

          echo "pr_list<<EOF" >> $GITHUB_OUTPUT
          echo -e "$PR_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create or update PR to main
        if: steps.check_pr.outputs.needs_pr == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          PR_NUMBER: ${{ steps.existing_pr.outputs.pr_number }}
          HAS_PR: ${{ steps.existing_pr.outputs.has_pr }}
          PR_LIST: ${{ steps.get_prs.outputs.pr_list }}
        run: |
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M UTC')

          PR_BODY="## „Éá„Éó„É≠„Ç§Ê∫ñÂÇôÂÆå‰∫Ü

          develop„Éñ„É©„É≥„ÉÅ„ÅÆÂ§âÊõ¥„Çímain„Å´„Éû„Éº„Ç∏„Åô„ÇãÊ∫ñÂÇô„Åå„Åß„Åç„Åæ„Åó„Åü„ÄÇ

          ### Âê´„Åæ„Çå„ÇãÂ§âÊõ¥
          $PR_LIST

          ### Ê¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó
          1. „Åì„ÅÆPR„ÅÆÂÜÖÂÆπ„ÇíÁ¢∫Ë™ç
          2. ÂïèÈ°å„Å™„Åë„Çå„Å∞„Éû„Éº„Ç∏
          3. main„Å∏„ÅÆ„Éû„Éº„Ç∏Âæå„ÄÅRailway„ÅåËá™Âãï„Éá„Éó„É≠„Ç§

          ‚ö†Ô∏è **Ê≥®ÊÑè**: „Åì„ÅÆPR„ÅØÂèÇËÄÉÁî®„Åß„Åô„ÄÇÂÆüÈöõ„ÅÆ„Éá„Éó„É≠„Ç§„ÅØÊØéÊó•Ê∑±Â§ú2:00„ÅÆËá™Âãï„Éá„Éó„É≠„Ç§„ÅßË°å„Çè„Çå„Åæ„Åô„ÄÇ

          ---
          _Last updated: $TIMESTAMP_"

          if [ "$HAS_PR" = "true" ]; then
            # Êó¢Â≠òPR„ÇíÊõ¥Êñ∞
            gh pr edit $PR_NUMBER --body "$PR_BODY"
            echo "Updated existing PR #$PR_NUMBER"
          else
            # Êñ∞Ë¶èPR‰ΩúÊàê
            PR_TITLE="chore: Ready to deploy $(date -u +%Y-%m-%d)"
            PR_URL=$(gh pr create \
              --base main \
              --head develop \
              --title "$PR_TITLE" \
              --body "$PR_BODY")
            echo "Created new PR: $PR_URL"
          fi

      - name: Summary
        if: always()
        run: |
          echo "### üìã Deploy PR Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_pr.outputs.needs_pr }}" == "false" ]; then
            echo "‚ÑπÔ∏è **No PR Needed**: develop is in sync with main" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.existing_pr.outputs.has_pr }}" == "true" ]; then
            echo "‚úÖ **PR Updated**: #${{ steps.existing_pr.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **PR Created**: develop ‚Üí main" >> $GITHUB_STEP_SUMMARY
          fi
