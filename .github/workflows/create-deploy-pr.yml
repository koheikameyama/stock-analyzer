name: Create Deploy PR

on:
  push:
    branches:
      - develop

jobs:
  create-pr:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout develop branch
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0

      - name: Check if PR to main is needed
        id: check_pr
        run: |
          # develop„Å®main„ÅÆÂ∑ÆÂàÜ„ÇíÁ¢∫Ë™ç
          git fetch origin main
          DIFF_COUNT=$(git rev-list --count origin/main..develop)

          if [ "$DIFF_COUNT" -eq 0 ]; then
            echo "No changes to deploy"
            echo "needs_pr=false" >> $GITHUB_OUTPUT
          else
            echo "Found $DIFF_COUNT commits to deploy"
            echo "needs_pr=true" >> $GITHUB_OUTPUT
          fi

      - name: Check existing PR
        if: steps.check_pr.outputs.needs_pr == 'true'
        id: existing_pr
        run: |
          # REST API„ÅßÊó¢Â≠ò„ÅÆdevelop‚Üímain„ÅÆPR„ÇíÁ¢∫Ë™çÔºàGraphQL„Ç®„É©„ÉºÂõûÈÅøÔºâ
          RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls?state=open&head=${{ github.repository_owner }}:develop&base=main")

          EXISTING_PR=$(echo "$RESPONSE" | jq -r '.[0].number // ""')

          if [ -n "$EXISTING_PR" ] && [ "$EXISTING_PR" != "null" ]; then
            echo "has_pr=true" >> $GITHUB_OUTPUT
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
            echo "Existing PR found: #$EXISTING_PR"
          else
            echo "has_pr=false" >> $GITHUB_OUTPUT
            echo "No existing PR found"
          fi

      - name: Get merged PRs since last deployment
        if: steps.check_pr.outputs.needs_pr == 'true'
        id: get_prs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # main„Å®develop„ÅÆÂ∑ÆÂàÜ„Åã„ÇâÂÖ®„Å¶„ÅÆ„Ç≥„Éü„ÉÉ„Éà„ÇíÂèñÂæó
          ALL_COMMITS=$(git log origin/main..develop --pretty=format:"%H %s")

          if [ -z "$ALL_COMMITS" ]; then
            echo "No commits found"
            echo "pr_list=" >> $GITHUB_OUTPUT
            echo "highest_version=" >> $GITHUB_OUTPUT
            echo "user_facing_changes=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # PR„Éä„É≥„Éê„Éº„ÇíÊäΩÂá∫„Åó„Å¶„É©„Éô„É´„ÇíÂèñÂæóÔºàÈáçË§áÈô§ÂéªÔºâ
          PR_LIST=""
          PR_NUMBERS_SEEN=""
          HIGHEST_VERSION=""
          VERSION_PRIORITY=0  # 0=none, 1=patch, 2=minor, 3=major
          USER_FACING_CHANGES=""

          while read -r commit_hash commit_msg; do
            # „Ç≥„Éü„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏„Åã„Çâ PRÁï™Âè∑„ÇíÊäΩÂá∫Ôºà(#123) „Åæ„Åü„ÅØ Merge pull request #123 „ÅÆÂΩ¢ÂºèÔºâ
            PR_NUMBER=$(echo "$commit_msg" | grep -oP '(?:\(#|\s#)\K\d+' | head -1 || true)

            if [ -n "$PR_NUMBER" ]; then
              # ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
              if ! echo "$PR_NUMBERS_SEEN" | grep -q "\b$PR_NUMBER\b"; then
                PR_NUMBERS_SEEN="$PR_NUMBERS_SEEN $PR_NUMBER"

                # PRÊÉÖÂ†±„ÇíÂèñÂæó
                PR_INFO=$(gh pr view $PR_NUMBER --json title,labels,body || true)
                PR_TITLE=$(echo "$PR_INFO" | jq -r '.title')
                LABELS=$(echo "$PR_INFO" | jq -r '.labels[].name')
                PR_BODY=$(echo "$PR_INFO" | jq -r '.body')

                # „Éê„Éº„Ç∏„Éß„É≥„É©„Éô„É´„ÇíÂèñÂæó
                VERSION_LABEL=""
                CURRENT_PRIORITY=0
                if echo "$LABELS" | grep -q "version:major"; then
                  VERSION_LABEL="[major]"
                  CURRENT_PRIORITY=3
                elif echo "$LABELS" | grep -q "version:minor"; then
                  VERSION_LABEL="[minor]"
                  CURRENT_PRIORITY=2
                elif echo "$LABELS" | grep -q "version:patch"; then
                  VERSION_LABEL="[patch]"
                  CURRENT_PRIORITY=1
                fi

                # ÊúÄ„ÇÇÈ´ò„ÅÑ„Éê„Éº„Ç∏„Éß„É≥„É©„Éô„É´„ÇíË®òÈå≤
                if [ $CURRENT_PRIORITY -gt $VERSION_PRIORITY ]; then
                  VERSION_PRIORITY=$CURRENT_PRIORITY
                  if [ $CURRENT_PRIORITY -eq 3 ]; then
                    HIGHEST_VERSION="version:major"
                  elif [ $CURRENT_PRIORITY -eq 2 ]; then
                    HIGHEST_VERSION="version:minor"
                  elif [ $CURRENT_PRIORITY -eq 1 ]; then
                    HIGHEST_VERSION="version:patch"
                  fi
                fi

                # „Éê„Éº„Ç∏„Éß„É≥„É©„Éô„É´‰ªò„ÅçPR„ÅÆ„Äå„É¶„Éº„Ç∂„ÉºÂêë„Åë„ÅÆÂ§âÊõ¥„Äç„ÇíÊäΩÂá∫
                if [ -n "$VERSION_LABEL" ] && [ -n "$PR_BODY" ]; then
                  # PRÊú¨Êñá„Åã„Çâ„Äå## „É¶„Éº„Ç∂„ÉºÂêë„Åë„ÅÆÂ§âÊõ¥„Äç„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÊäΩÂá∫
                  CHANGES=$(echo "$PR_BODY" | awk '
                    /^## „É¶„Éº„Ç∂„ÉºÂêë„Åë„ÅÆÂ§âÊõ¥/ {flag=1; next}
                    /^## / {flag=0}
                    flag && /^[^#]/ {print}
                  ' | sed '/^$/d')

                  if [ -n "$CHANGES" ]; then
                    USER_FACING_CHANGES="${USER_FACING_CHANGES}${CHANGES}\n"
                  fi
                fi

                # PR„É™„Çπ„Éà„Å´ËøΩÂä†ÔºàPR„É™„É≥„ÇØ + „Éê„Éº„Ç∏„Éß„É≥„É©„Éô„É´Ôºâ
                PR_URL="https://github.com/${{ github.repository }}/pull/$PR_NUMBER"
                if [ -n "$VERSION_LABEL" ]; then
                  PR_LIST="${PR_LIST}\n- $VERSION_LABEL [$PR_TITLE]($PR_URL)"
                else
                  PR_LIST="${PR_LIST}\n- [$PR_TITLE]($PR_URL)"
                fi
              fi
            fi
          done <<< "$ALL_COMMITS"

          if [ -z "$PR_LIST" ]; then
            echo "No PR numbers found in commits"
            echo "pr_list=" >> $GITHUB_OUTPUT
            echo "highest_version=" >> $GITHUB_OUTPUT
            echo "user_facing_changes=" >> $GITHUB_OUTPUT
          else
            echo "pr_list<<EOF" >> $GITHUB_OUTPUT
            echo -e "$PR_LIST" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "highest_version=$HIGHEST_VERSION" >> $GITHUB_OUTPUT
            echo "Highest version label: $HIGHEST_VERSION"

            if [ -n "$USER_FACING_CHANGES" ]; then
              echo "user_facing_changes<<EOF" >> $GITHUB_OUTPUT
              echo -e "$USER_FACING_CHANGES" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              echo "user_facing_changes=" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Create or update PR to main
        if: steps.check_pr.outputs.needs_pr == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.existing_pr.outputs.pr_number }}
          HAS_PR: ${{ steps.existing_pr.outputs.has_pr }}
          PR_LIST: ${{ steps.get_prs.outputs.pr_list }}
          USER_FACING_CHANGES: ${{ steps.get_prs.outputs.user_facing_changes }}
          HIGHEST_VERSION: ${{ steps.get_prs.outputs.highest_version }}
        run: |
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M UTC')

          # PRÊú¨Êñá„Çí„Éï„Ç°„Ç§„É´„Å´‰øùÂ≠ò
          {
            echo "## „Éá„Éó„É≠„Ç§Ê∫ñÂÇôÂÆå‰∫Ü"
            echo ""
            echo "develop„Éñ„É©„É≥„ÉÅ„ÅÆÂ§âÊõ¥„Çímain„Å´„Éû„Éº„Ç∏„Åô„ÇãÊ∫ñÂÇô„Åå„Åß„Åç„Åæ„Åó„Åü„ÄÇ"
            echo ""

            # „É¶„Éº„Ç∂„ÉºÂêë„Åë„ÅÆÂ§âÊõ¥„Çª„ÇØ„Ç∑„Éß„É≥Ôºà„Éê„Éº„Ç∏„Éß„É≥„É©„Éô„É´‰ªò„ÅçPR„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøÔºâ
            if [ -n "$USER_FACING_CHANGES" ]; then
              echo "### „É¶„Éº„Ç∂„ÉºÂêë„Åë„ÅÆÂ§âÊõ¥"
              echo ""
              echo -e "$USER_FACING_CHANGES"
              echo ""
            fi

            echo "### Âê´„Åæ„Çå„ÇãÂ§âÊõ¥"
            echo -e "$PR_LIST"
            echo ""
            echo "### Ê¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó"
            echo "1. „Åì„ÅÆPR„ÅÆÂÜÖÂÆπ„ÇíÁ¢∫Ë™ç"
            echo "2. ÂïèÈ°å„Å™„Åë„Çå„Å∞„Éû„Éº„Ç∏"
            echo "3. main„Å∏„ÅÆ„Éû„Éº„Ç∏Âæå„ÄÅRailway„ÅåËá™Âãï„Éá„Éó„É≠„Ç§"
            echo ""
            echo "---"
            echo "_Last updated: $TIMESTAMP_"
          } > /tmp/pr_body.txt

          if [ "$HAS_PR" = "true" ]; then
            # Êó¢Â≠òPR„ÇíÊõ¥Êñ∞
            gh pr edit $PR_NUMBER --body-file /tmp/pr_body.txt
            echo "Updated existing PR #$PR_NUMBER"
            DEPLOY_PR_NUMBER=$PR_NUMBER
          else
            # Êñ∞Ë¶èPR‰ΩúÊàê
            PR_TITLE="chore: Ready to deploy $(date -u +%Y-%m-%d)"
            PR_URL=$(gh pr create \
              --base main \
              --head develop \
              --title "$PR_TITLE" \
              --body-file /tmp/pr_body.txt)
            DEPLOY_PR_NUMBER=$(echo "$PR_URL" | grep -oP '\d+$')
            echo "Created new PR: $PR_URL"
          fi

          # „Éê„Éº„Ç∏„Éß„É≥„É©„Éô„É´„Çí‰ªò‰∏é
          if [ -n "$HIGHEST_VERSION" ] && [ -n "$DEPLOY_PR_NUMBER" ]; then
            echo "Adding label $HIGHEST_VERSION to PR #$DEPLOY_PR_NUMBER"

            # Êó¢Â≠ò„ÅÆ„Éê„Éº„Ç∏„Éß„É≥„É©„Éô„É´„ÇíÂâäÈô§
            gh pr edit $DEPLOY_PR_NUMBER --remove-label "version:major" 2>/dev/null || true
            gh pr edit $DEPLOY_PR_NUMBER --remove-label "version:minor" 2>/dev/null || true
            gh pr edit $DEPLOY_PR_NUMBER --remove-label "version:patch" 2>/dev/null || true

            # Êñ∞„Åó„ÅÑ„Éê„Éº„Ç∏„Éß„É≥„É©„Éô„É´„ÇíËøΩÂä†
            gh pr edit $DEPLOY_PR_NUMBER --add-label "$HIGHEST_VERSION"
            echo "Added label: $HIGHEST_VERSION"
          fi

      - name: Summary
        if: always()
        run: |
          echo "### üìã Deploy PR Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_pr.outputs.needs_pr }}" == "false" ]; then
            echo "‚ÑπÔ∏è **No PR Needed**: develop is in sync with main" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.existing_pr.outputs.has_pr }}" == "true" ]; then
            echo "‚úÖ **PR Updated**: #${{ steps.existing_pr.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **PR Created**: develop ‚Üí main" >> $GITHUB_STEP_SUMMARY
          fi
