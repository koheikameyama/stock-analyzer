name: Create Deploy PR

on:
  push:
    branches:
      - develop

jobs:
  create-pr:
    runs-on: ubuntu-latest

    # GH_PATã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€permissionsã¯ç©ºã«è¨­å®šï¼ˆGITHUB_TOKENã‚’ç„¡åŠ¹åŒ–ï¼‰
    permissions: {}

    steps:
      - name: Checkout develop branch
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0

      - name: Check if PR to main is needed
        id: check_pr
        run: |
          # developã¨mainã®å·®åˆ†ã‚’ç¢ºèª
          git fetch origin main
          DIFF_COUNT=$(git rev-list --count origin/main..develop)

          if [ "$DIFF_COUNT" -eq 0 ]; then
            echo "No changes to deploy"
            echo "needs_pr=false" >> $GITHUB_OUTPUT
          else
            echo "Found $DIFF_COUNT commits to deploy"
            echo "needs_pr=true" >> $GITHUB_OUTPUT
          fi

      - name: Check existing PR
        if: steps.check_pr.outputs.needs_pr == 'true'
        id: existing_pr
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # GITHUB_TOKENã‚’unsetã—ã¦GH_PATã‚’å„ªå…ˆ
          unset GITHUB_TOKEN

          # æ—¢å­˜ã®developâ†’mainã®PRãŒã‚ã‚‹ã‹ç¢ºèª
          EXISTING_PR=$(gh pr list --base main --head develop --state open --json number --jq '.[0].number' || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "has_pr=true" >> $GITHUB_OUTPUT
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
            echo "Existing PR found: #$EXISTING_PR"
          else
            echo "has_pr=false" >> $GITHUB_OUTPUT
            echo "No existing PR found"
          fi

      - name: Get merged PRs since last deployment
        if: steps.check_pr.outputs.needs_pr == 'true'
        id: get_prs
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # GITHUB_TOKENã‚’unsetã—ã¦GH_PATã‚’å„ªå…ˆ
          unset GITHUB_TOKEN

          # mainã¨developã®å·®åˆ†ã‹ã‚‰ãƒžãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆã‚’å–å¾—
          MERGE_COMMITS=$(git log origin/main..develop --merges --pretty=format:"%H %s" | grep "Merge pull request" || true)

          if [ -z "$MERGE_COMMITS" ]; then
            echo "No merged PRs found"
            echo "pr_list=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # PRãƒŠãƒ³ãƒãƒ¼ã‚’æŠ½å‡ºã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—
          PR_LIST=""
          while read -r commit_hash commit_msg; do
            PR_NUMBER=$(echo "$commit_msg" | grep -oP '#\K\d+' || true)
            if [ -n "$PR_NUMBER" ]; then
              # ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒ©ãƒ™ãƒ«ã‚’å–å¾—ï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ã¯ç©ºã®JSONã‚’è¿”ã™ï¼‰
              PR_INFO=$(gh pr view $PR_NUMBER --json title,labels 2>/dev/null || echo '{"title":"","labels":[]}')
              PR_TITLE=$(echo "$PR_INFO" | jq -r '.title // ""')

              # ã‚¿ã‚¤ãƒˆãƒ«ãŒç©ºã®å ´åˆã¯ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰æŠ½å‡º
              if [ -z "$PR_TITLE" ]; then
                PR_TITLE=$(echo "$commit_msg" | sed 's/Merge pull request #[0-9]* from [^ ]* //')
              fi

              LABELS=$(echo "$PR_INFO" | jq -r '.labels[]?.name // empty' 2>/dev/null | tr '\n' ',' | sed 's/,$//')

              if [ -n "$LABELS" ]; then
                PR_LIST="${PR_LIST}- #${PR_NUMBER}: ${PR_TITLE} [${LABELS}]\n"
              else
                PR_LIST="${PR_LIST}- #${PR_NUMBER}: ${PR_TITLE}\n"
              fi
            fi
          done <<< "$MERGE_COMMITS"

          echo "pr_list<<EOF" >> $GITHUB_OUTPUT
          echo -e "$PR_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create or update PR to main
        if: steps.check_pr.outputs.needs_pr == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          PR_NUMBER: ${{ steps.existing_pr.outputs.pr_number }}
          HAS_PR: ${{ steps.existing_pr.outputs.has_pr }}
          PR_LIST: ${{ steps.get_prs.outputs.pr_list }}
        run: |
          # GITHUB_TOKENã‚’unsetã—ã¦GH_PATã‚’å„ªå…ˆ
          unset GITHUB_TOKEN

          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M UTC')

          PR_BODY="## ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™å®Œäº†

          developãƒ–ãƒ©ãƒ³ãƒã®å¤‰æ›´ã‚’mainã«ãƒžãƒ¼ã‚¸ã™ã‚‹æº–å‚™ãŒã§ãã¾ã—ãŸã€‚

          ### å«ã¾ã‚Œã‚‹å¤‰æ›´
          $PR_LIST

          ### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
          1. ã“ã®PRã®å†…å®¹ã‚’ç¢ºèª
          2. å•é¡Œãªã‘ã‚Œã°ãƒžãƒ¼ã‚¸
          3. mainã¸ã®ãƒžãƒ¼ã‚¸å¾Œã€RailwayãŒè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤

          âš ï¸ **æ³¨æ„**: ã“ã®PRã¯å‚è€ƒç”¨ã§ã™ã€‚å®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯æ¯Žæ—¥æ·±å¤œ2:00ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã§è¡Œã‚ã‚Œã¾ã™ã€‚

          ---
          _Last updated: $TIMESTAMP_"

          if [ "$HAS_PR" = "true" ]; then
            # æ—¢å­˜PRã‚’æ›´æ–°
            gh pr edit $PR_NUMBER --body "$PR_BODY"
            echo "Updated existing PR #$PR_NUMBER"
          else
            # æ–°è¦PRä½œæˆ
            PR_TITLE="chore: Ready to deploy $(date -u +%Y-%m-%d)"
            PR_URL=$(gh pr create \
              --base main \
              --head develop \
              --title "$PR_TITLE" \
              --body "$PR_BODY")
            echo "Created new PR: $PR_URL"
          fi

      - name: Summary
        if: always()
        run: |
          echo "### ðŸ“‹ Deploy PR Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_pr.outputs.needs_pr }}" == "false" ]; then
            echo "â„¹ï¸ **No PR Needed**: develop is in sync with main" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.existing_pr.outputs.has_pr }}" == "true" ]; then
            echo "âœ… **PR Updated**: #${{ steps.existing_pr.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **PR Created**: develop â†’ main" >> $GITHUB_STEP_SUMMARY
          fi
