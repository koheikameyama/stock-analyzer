name: Create Deploy PR

on:
  pull_request:
    branches:
      - develop
    types:
      - closed

jobs:
  create-pr:
    # PRãŒãƒžãƒ¼ã‚¸ã•ã‚ŒãŸå ´åˆã®ã¿å®Ÿè¡Œï¼ˆmainâ†’developã®åŒæœŸPRã¯é™¤å¤–ï¼‰
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'develop' && github.event.pull_request.head.ref != 'main'
    runs-on: ubuntu-latest

    # GH_PATã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€permissionsã¯ç©ºã«è¨­å®šï¼ˆGITHUB_TOKENã‚’ç„¡åŠ¹åŒ–ï¼‰
    permissions: {}

    steps:
      - name: Checkout develop branch
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0

      - name: Check if PR to main is needed
        id: check_pr
        run: |
          # developã¨mainã®å·®åˆ†ã‚’ç¢ºèª
          git fetch origin main
          DIFF_COUNT=$(git rev-list --count origin/main..develop)

          if [ "$DIFF_COUNT" -eq 0 ]; then
            echo "No changes to deploy"
            echo "needs_pr=false" >> $GITHUB_OUTPUT
          else
            echo "Found $DIFF_COUNT commits to deploy"
            echo "needs_pr=true" >> $GITHUB_OUTPUT
          fi

      - name: Check existing PR
        if: steps.check_pr.outputs.needs_pr == 'true'
        id: existing_pr
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          # æ—¢å­˜ã®developâ†’mainã®PRãŒã‚ã‚‹ã‹ç¢ºèªï¼ˆGitHub REST APIä½¿ç”¨ï¼‰
          RESPONSE=$(curl -s -H "Authorization: token $GH_PAT" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls?state=open&base=main&head=${{ github.repository_owner }}:develop")

          EXISTING_PR=$(echo "$RESPONSE" | jq -r '.[0].number // empty')

          if [ -n "$EXISTING_PR" ]; then
            echo "has_pr=true" >> $GITHUB_OUTPUT
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
            echo "Existing PR found: #$EXISTING_PR"
          else
            echo "has_pr=false" >> $GITHUB_OUTPUT
            echo "No existing PR found"
          fi

      - name: Get merged PRs since last deployment
        if: steps.check_pr.outputs.needs_pr == 'true'
        id: get_prs
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          # mainã¨developã®å·®åˆ†ã‹ã‚‰å…¨ã‚³ãƒŸãƒƒãƒˆï¼ˆãƒžãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆ + Squash Mergeï¼‰ã‚’å–å¾—
          # mainâ†’developã®åŒæœŸã‚³ãƒŸãƒƒãƒˆã¯é™¤å¤–
          ALL_COMMITS=$(git log origin/main..develop --pretty=format:"%H %s" | grep -E '#[0-9]+' | grep -v "chore: Sync main to develop" || true)

          if [ -z "$ALL_COMMITS" ]; then
            echo "No merged PRs found"
            echo "pr_list=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # PRãƒŠãƒ³ãƒãƒ¼ã‚’æŠ½å‡ºã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—ï¼ˆé‡è¤‡æŽ’é™¤ï¼‰
          PR_LIST=""
          declare -A SEEN_PRS
          while read -r commit_hash commit_msg; do
            PR_NUMBER=$(echo "$commit_msg" | grep -oP '#\K\d+' || true)
            if [ -n "$PR_NUMBER" ] && [ -z "${SEEN_PRS[$PR_NUMBER]}" ]; then
              SEEN_PRS[$PR_NUMBER]=1

              # ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒ©ãƒ™ãƒ«ã‚’å–å¾—ï¼ˆGitHub REST APIä½¿ç”¨ï¼‰
              PR_INFO=$(curl -s -H "Authorization: token $GH_PAT" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER" 2>/dev/null || echo '{"title":"","labels":[]}')
              PR_TITLE=$(echo "$PR_INFO" | jq -r '.title // ""')

              # ã‚¿ã‚¤ãƒˆãƒ«ãŒç©ºã®å ´åˆã¯ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰æŠ½å‡º
              if [ -z "$PR_TITLE" ]; then
                PR_TITLE=$(echo "$commit_msg" | sed -E 's/^[a-f0-9]+ //; s/ \(#[0-9]+\)$//')
              fi

              LABELS=$(echo "$PR_INFO" | jq -r '.labels[]?.name // empty' 2>/dev/null | tr '\n' ',' | sed 's/,$//')

              if [ -n "$LABELS" ]; then
                PR_LIST="${PR_LIST}- #${PR_NUMBER}: ${PR_TITLE} [${LABELS}]\n"
              else
                PR_LIST="${PR_LIST}- #${PR_NUMBER}: ${PR_TITLE}\n"
              fi
            fi
          done <<< "$ALL_COMMITS"

          echo "pr_list<<EOF" >> $GITHUB_OUTPUT
          echo -e "$PR_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create or update PR to main
        if: steps.check_pr.outputs.needs_pr == 'true'
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          PR_NUMBER: ${{ steps.existing_pr.outputs.pr_number }}
          HAS_PR: ${{ steps.existing_pr.outputs.has_pr }}
          PR_LIST: ${{ steps.get_prs.outputs.pr_list }}
        run: |
          TIMESTAMP=$(TZ=UTC date '+%Y-%m-%d %H:%M UTC')

          PR_BODY="## ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™å®Œäº†

          developãƒ–ãƒ©ãƒ³ãƒã®å¤‰æ›´ã‚’mainã«ãƒžãƒ¼ã‚¸ã™ã‚‹æº–å‚™ãŒã§ãã¾ã—ãŸã€‚

          ### å«ã¾ã‚Œã‚‹å¤‰æ›´
          $PR_LIST

          ### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
          1. ã“ã®PRã®å†…å®¹ã‚’ç¢ºèª
          2. å•é¡Œãªã‘ã‚Œã°ãƒžãƒ¼ã‚¸
          3. mainã¸ã®ãƒžãƒ¼ã‚¸å¾Œã€RailwayãŒè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤

          ---
          _Last updated: ${TIMESTAMP}_"

          # JSONå½¢å¼ã§ãƒœãƒ‡ã‚£ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
          PR_BODY_JSON=$(echo "$PR_BODY" | jq -Rs .)

          if [ "$HAS_PR" = "true" ]; then
            # æ—¢å­˜PRã‚’æ›´æ–°ï¼ˆGitHub REST APIä½¿ç”¨ï¼‰
            curl -s -X PATCH \
              -H "Authorization: token $GH_PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER" \
              -d "{\"body\": $PR_BODY_JSON}"
            echo "Updated existing PR #$PR_NUMBER"
          else
            # æ–°è¦PRä½œæˆï¼ˆGitHub REST APIä½¿ç”¨ï¼‰
            PR_TITLE="chore: Ready to deploy $(date -u +%Y-%m-%d)"
            PR_TITLE_JSON=$(echo "$PR_TITLE" | jq -Rs .)

            RESPONSE=$(curl -s -X POST \
              -H "Authorization: token $GH_PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/pulls" \
              -d "{\"title\": $PR_TITLE_JSON, \"body\": $PR_BODY_JSON, \"head\": \"develop\", \"base\": \"main\"}")

            PR_URL=$(echo "$RESPONSE" | jq -r '.html_url')
            echo "Created new PR: $PR_URL"
          fi

      - name: Summary
        if: always()
        run: |
          echo "### ðŸ“‹ Deploy PR Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_pr.outputs.needs_pr }}" == "false" ]; then
            echo "â„¹ï¸ **No PR Needed**: develop is in sync with main" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.existing_pr.outputs.has_pr }}" == "true" ]; then
            echo "âœ… **PR Updated**: #${{ steps.existing_pr.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **PR Created**: develop â†’ main" >> $GITHUB_STEP_SUMMARY
          fi
