name: Release Notification

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      title:
        description: 'リリースタイトル（例: v1.1.0 - 配当利回り修正など）'
        required: true
        type: string
      changes:
        description: '変更内容（改行区切りで箇条書き）'
        required: true
        type: string
      post_template:
        description: 'X投稿テンプレート（省略可、自動生成されます）'
        required: false
        type: string

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare notification message
        id: prepare
        env:
          EVENT_NAME: ${{ github.event_name }}
          RELEASE_NAME: ${{ github.event.release.name }}
          RELEASE_BODY: ${{ github.event.release.body }}
          INPUT_TITLE: ${{ github.event.inputs.title }}
          INPUT_CHANGES: ${{ github.event.inputs.changes }}
          INPUT_POST_TEMPLATE: ${{ github.event.inputs.post_template }}
        run: |
          if [ "$EVENT_NAME" = "release" ]; then
            TITLE="$RELEASE_NAME"
            BODY="$RELEASE_BODY"
          else
            TITLE="$INPUT_TITLE"
            BODY="$INPUT_CHANGES"
          fi

          echo "TITLE=$TITLE" >> $GITHUB_ENV
          {
            echo "BODY<<EOF_BODY"
            echo "$BODY"
            echo "EOF_BODY"
          } >> $GITHUB_ENV

          if [ "$EVENT_NAME" != "release" ] && [ -n "$INPUT_POST_TEMPLATE" ]; then
            {
              echo "POST_TEMPLATE<<EOF_POST"
              echo "$INPUT_POST_TEMPLATE"
              echo "EOF_POST"
            } >> $GITHUB_ENV
          else
            {
              echo "POST_TEMPLATE<<EOF_POST"
              echo "【アップデート】${TITLE}"
              echo ""
              echo "$BODY"
              echo ""
              echo "https://stock-analyzer.jp/"
              echo ""
              echo "#AI株式分析 #投資ツール"
              echo "EOF_POST"
            } >> $GITHUB_ENV
          fi

      - name: Send to Slack
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_USERNAME: Release Bot
          SLACK_ICON_EMOJI: ':rocket:'
          SLACK_COLOR: good
          SLACK_TITLE: '📢 リリース通知'
          SLACK_MESSAGE: |
            <!here>

            *【タイトル】*
            ${{ env.TITLE }}

            *【変更内容】*
            ${{ env.BODY }}

            ━━━━━━━━━━━━━━━
            💡 *X投稿候補:*
            ```
            ${{ env.POST_TEMPLATE }}
            ```

            📝 このメッセージをコピーしてXに投稿してください
          SLACK_FOOTER: ''
