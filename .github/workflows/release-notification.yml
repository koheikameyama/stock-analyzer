name: Release Notification

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      title:
        description: 'ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¾‹: v1.1.0 - é…å½“åˆ©å›žã‚Šä¿®æ­£ãªã©ï¼‰'
        required: true
        type: string
      changes:
        description: 'å¤‰æ›´å†…å®¹ï¼ˆæ”¹è¡ŒåŒºåˆ‡ã‚Šã§ç®‡æ¡æ›¸ãï¼‰'
        required: true
        type: string
      post_template:
        description: 'XæŠ•ç¨¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆçœç•¥å¯ã€è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ï¼‰'
        required: false
        type: string

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare notification message
        id: prepare
        env:
          EVENT_NAME: ${{ github.event_name }}
          RELEASE_NAME: ${{ github.event.release.name }}
          RELEASE_BODY: ${{ github.event.release.body }}
          INPUT_TITLE: ${{ github.event.inputs.title }}
          INPUT_CHANGES: ${{ github.event.inputs.changes }}
          INPUT_POST_TEMPLATE: ${{ github.event.inputs.post_template }}
        run: |
          if [ "$EVENT_NAME" = "release" ]; then
            TITLE="$RELEASE_NAME"
            BODY="$RELEASE_BODY"
          else
            TITLE="$INPUT_TITLE"
            BODY="$INPUT_CHANGES"
          fi

          echo "TITLE=$TITLE" >> $GITHUB_ENV
          {
            echo "BODY<<EOF_BODY"
            echo "$BODY"
            echo "EOF_BODY"
          } >> $GITHUB_ENV

          if [ "$EVENT_NAME" != "release" ] && [ -n "$INPUT_POST_TEMPLATE" ]; then
            {
              echo "POST_TEMPLATE<<EOF_POST"
              echo "$INPUT_POST_TEMPLATE"
              echo "EOF_POST"
            } >> $GITHUB_ENV
          else
            {
              echo "POST_TEMPLATE<<EOF_POST"
              echo "ã€ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã€‘${TITLE}"
              echo ""
              echo "$BODY"
              echo ""
              echo "https://stock-analyzer.jp/"
              echo ""
              echo "#AIæ ªå¼åˆ†æž #æŠ•è³‡ãƒ„ãƒ¼ãƒ«"
              echo "EOF_POST"
            } >> $GITHUB_ENV
          fi

      - name: Send to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # JSONãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½œæˆ
          cat > /tmp/slack.json <<SLACK_JSON
          {
            "text": "ðŸ“¢ *ãƒªãƒªãƒ¼ã‚¹é€šçŸ¥*\\n\\n*ã€ã‚¿ã‚¤ãƒˆãƒ«ã€‘*\\n${TITLE}\\n\\n*ã€å¤‰æ›´å†…å®¹ã€‘*\\n${BODY}\\n\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\nðŸ’¡ *XæŠ•ç¨¿å€™è£œ:*\\n\\\`\\\`\\\`\\n${POST_TEMPLATE}\\n\\\`\\\`\\\`\\n\\nðŸ“ ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦Xã«æŠ•ç¨¿ã—ã¦ãã ã•ã„",
            "username": "Release Bot",
            "icon_emoji": ":rocket:"
          }
          SLACK_JSON

          # Slackã«é€ä¿¡
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d @/tmp/slack.json

          echo "âœ… Slackã¸ã®é€ä¿¡æˆåŠŸ"
