name: Release Notification

on:
  # GitHub Release作成時に自動実行
  release:
    types: [published]

  # 手動実行も可能
  workflow_dispatch:
    inputs:
      title:
        description: 'リリースタイトル（例: v1.1.0 - 配当利回り修正など）'
        required: true
        type: string
      changes:
        description: '変更内容（改行区切りで箇条書き）'
        required: true
        type: string
      post_template:
        description: 'X投稿テンプレート（省略可、自動生成されます）'
        required: false
        type: string

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare notification message
        id: prepare
        env:
          EVENT_NAME: ${{ github.event_name }}
          RELEASE_NAME: ${{ github.event.release.name }}
          RELEASE_BODY: ${{ github.event.release.body }}
          INPUT_TITLE: ${{ github.event.inputs.title }}
          INPUT_CHANGES: ${{ github.event.inputs.changes }}
          INPUT_POST_TEMPLATE: ${{ github.event.inputs.post_template }}
        run: |
          if [ "$EVENT_NAME" = "release" ]; then
            TITLE="$RELEASE_NAME"
            BODY="$RELEASE_BODY"
          else
            TITLE="$INPUT_TITLE"
            BODY="$INPUT_CHANGES"
          fi

          # 環境変数に保存
          echo "TITLE=$TITLE" >> $GITHUB_ENV
          {
            echo "BODY<<EOF_BODY"
            echo "$BODY"
            echo "EOF_BODY"
          } >> $GITHUB_ENV

          # X投稿テンプレートを生成
          if [ "$EVENT_NAME" != "release" ] && [ -n "$INPUT_POST_TEMPLATE" ]; then
            POST_TEMPLATE="$INPUT_POST_TEMPLATE"
          else
            {
              echo "POST_TEMPLATE<<EOF_POST"
              echo "【アップデート】${TITLE}"
              echo ""
              echo "$BODY"
              echo ""
              echo "https://stock-analyzer.jp/"
              echo ""
              echo "#AI株式分析 #投資ツール"
              echo "EOF_POST"
            } >> $GITHUB_ENV
          fi

      - name: Send to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # Slack通知用のJSONを作成
          cat > /tmp/slack_payload.json <<SLACK_EOF
{
  "text": "📢 *リリース通知*\n\n*【タイトル】*\n${TITLE}\n\n*【変更内容】*\n${BODY}\n\n━━━━━━━━━━━━━━━\n💡 *X投稿候補:*\n\`\`\`\n${POST_TEMPLATE}\n\`\`\`\n\n📝 このメッセージをコピーしてXに投稿してください",
  "username": "Release Bot",
  "icon_emoji": ":rocket:"
}
SLACK_EOF

          # Slackに送信
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d @/tmp/slack_payload.json

          echo "✅ Slackへの送信成功"
