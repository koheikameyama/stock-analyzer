name: Release Notification

on:
  # GitHub Releaseä½œæˆæ™‚ã«è‡ªå‹•å®Ÿè¡Œ
  release:
    types: [published]

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      title:
        description: 'ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¾‹: v1.1.0 - é…å½“åˆ©å›žã‚Šä¿®æ­£ãªã©ï¼‰'
        required: true
        type: string
      changes:
        description: 'å¤‰æ›´å†…å®¹ï¼ˆæ”¹è¡ŒåŒºåˆ‡ã‚Šã§ç®‡æ¡æ›¸ãï¼‰'
        required: true
        type: string
      post_template:
        description: 'XæŠ•ç¨¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆçœç•¥å¯ã€è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ï¼‰'
        required: false
        type: string

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare notification message
        id: prepare
        env:
          EVENT_NAME: ${{ github.event_name }}
          RELEASE_NAME: ${{ github.event.release.name }}
          RELEASE_BODY: ${{ github.event.release.body }}
          INPUT_TITLE: ${{ github.event.inputs.title }}
          INPUT_CHANGES: ${{ github.event.inputs.changes }}
          INPUT_POST_TEMPLATE: ${{ github.event.inputs.post_template }}
        run: |
          if [ "$EVENT_NAME" = "release" ]; then
            # GitHub Releaseã‹ã‚‰æƒ…å ±ã‚’å–å¾—
            TITLE="$RELEASE_NAME"
            BODY="$RELEASE_BODY"

            # XæŠ•ç¨¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç”Ÿæˆ
            POST_TEMPLATE="ã€ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã€‘${TITLE}

$BODY

https://stock-analyzer.jp/

#AIæ ªå¼åˆ†æž #æŠ•è³‡ãƒ„ãƒ¼ãƒ«"
          else
            # æ‰‹å‹•å®Ÿè¡Œã®å ´åˆã¯å…¥åŠ›å€¤ã‚’ä½¿ç”¨
            TITLE="$INPUT_TITLE"
            BODY="$INPUT_CHANGES"

            if [ -n "$INPUT_POST_TEMPLATE" ]; then
              POST_TEMPLATE="$INPUT_POST_TEMPLATE"
            else
              # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯è‡ªå‹•ç”Ÿæˆ
              POST_TEMPLATE="ã€ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã€‘${TITLE}

$BODY

https://stock-analyzer.jp/

#AIæ ªå¼åˆ†æž #æŠ•è³‡ãƒ„ãƒ¼ãƒ«"
            fi
          fi

          # ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜ï¼ˆæ”¹è¡Œã‚’å«ã‚€ã®ã§ãƒ•ã‚¡ã‚¤ãƒ«çµŒç”±ï¼‰
          echo "TITLE=$TITLE" >> $GITHUB_ENV
          echo "BODY<<EOF" >> $GITHUB_ENV
          echo "$BODY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "POST_TEMPLATE<<EOF" >> $GITHUB_ENV
          echo "$POST_TEMPLATE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Send to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # Slacké€šçŸ¥ç”¨ã®JSONã‚’ä½œæˆ
          cat > /tmp/slack_payload.json <<SLACK_EOF
{
  "text": "ðŸ“¢ *ãƒªãƒªãƒ¼ã‚¹é€šçŸ¥*\n\n*ã€ã‚¿ã‚¤ãƒˆãƒ«ã€‘*\n${TITLE}\n\n*ã€å¤‰æ›´å†…å®¹ã€‘*\n${BODY}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸ’¡ *XæŠ•ç¨¿å€™è£œ:*\n\`\`\`\n${POST_TEMPLATE}\n\`\`\`\n\nðŸ“ ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦Xã«æŠ•ç¨¿ã—ã¦ãã ã•ã„",
  "username": "Release Bot",
  "icon_emoji": ":rocket:"
}
SLACK_EOF

          # Slackã«é€ä¿¡
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d @/tmp/slack_payload.json

          echo "âœ… Slackã¸ã®é€ä¿¡æˆåŠŸ"
