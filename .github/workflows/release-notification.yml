name: Release Notification

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      title:
        description: '„É™„É™„Éº„Çπ„Çø„Ç§„Éà„É´Ôºà‰æã: v1.1.0 - ÈÖçÂΩìÂà©Âõû„Çä‰øÆÊ≠£„Å™„Å©Ôºâ'
        required: true
        type: string
      changes:
        description: 'Â§âÊõ¥ÂÜÖÂÆπÔºàÊîπË°åÂå∫Âàá„Çä„ÅßÁÆáÊù°Êõ∏„ÅçÔºâ'
        required: true
        type: string
      post_template:
        description: 'XÊäïÁ®ø„ÉÜ„É≥„Éó„É¨„Éº„ÉàÔºàÁúÅÁï•ÂèØ„ÄÅËá™ÂãïÁîüÊàê„Åï„Çå„Åæ„ÅôÔºâ'
        required: false
        type: string

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare notification message
        id: prepare
        env:
          EVENT_NAME: ${{ github.event_name }}
          RELEASE_NAME: ${{ github.event.release.name }}
          RELEASE_BODY: ${{ github.event.release.body }}
          INPUT_TITLE: ${{ github.event.inputs.title }}
          INPUT_CHANGES: ${{ github.event.inputs.changes }}
          INPUT_POST_TEMPLATE: ${{ github.event.inputs.post_template }}
        run: |
          if [ "$EVENT_NAME" = "release" ]; then
            TITLE="$RELEASE_NAME"
            BODY="$RELEASE_BODY"
          else
            TITLE="$INPUT_TITLE"
            BODY="$INPUT_CHANGES"
          fi

          echo "TITLE=$TITLE" >> $GITHUB_ENV
          {
            echo "BODY<<EOF_BODY"
            echo "$BODY"
            echo "EOF_BODY"
          } >> $GITHUB_ENV

          if [ "$EVENT_NAME" != "release" ] && [ -n "$INPUT_POST_TEMPLATE" ]; then
            {
              echo "POST_TEMPLATE<<EOF_POST"
              echo "$INPUT_POST_TEMPLATE"
              echo "EOF_POST"
            } >> $GITHUB_ENV
          else
            {
              echo "POST_TEMPLATE<<EOF_POST"
              echo "„Äê„Ç¢„ÉÉ„Éó„Éá„Éº„Éà„Äë${TITLE}"
              echo ""
              echo "$BODY"
              echo ""
              echo "https://stock-analyzer.jp/"
              echo ""
              echo "#AIÊ†™ÂºèÂàÜÊûê #ÊäïË≥á„ÉÑ„Éº„É´"
              echo "EOF_POST"
            } >> $GITHUB_ENV
          fi

      - name: Send to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # JSON„Ç®„É≥„Ç≥„Éº„ÉâÁî®„ÅÆÈñ¢Êï∞
          json_escape() {
            echo "$1" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))'
          }

          # „É°„ÉÉ„Çª„Éº„Ç∏„Çí‰ΩúÊàêÔºàheredoc„ÅßÔºâ
          MESSAGE=$(cat <<'SLACKMSG'
          <!here> üì¢ *„É™„É™„Éº„ÇπÈÄöÁü•*

          *„Äê„Çø„Ç§„Éà„É´„Äë*
          ${TITLE}

          *„ÄêÂ§âÊõ¥ÂÜÖÂÆπ„Äë*
          ${BODY}

          ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
          üí° *XÊäïÁ®øÂÄôË£ú:*
          ```
          ${POST_TEMPLATE}
          ```

          üìù „Åì„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„Çí„Ç≥„Éî„Éº„Åó„Å¶X„Å´ÊäïÁ®ø„Åó„Å¶„Åè„Å†„Åï„ÅÑ
          SLACKMSG
          )

          # Áí∞Â¢ÉÂ§âÊï∞„ÇíÂ±ïÈñã
          MESSAGE=$(eval "echo \"$MESSAGE\"")

          # JSON„Éö„Ç§„É≠„Éº„Éâ„Çí‰ΩúÊàê
          MESSAGE_ESCAPED=$(json_escape "$MESSAGE")

          cat > /tmp/slack.json <<JSONEOF
          {
            "text": ${MESSAGE_ESCAPED},
            "username": "Release Bot",
            "icon_emoji": ":rocket:"
          }
          JSONEOF

          # Slack„Å´ÈÄÅ‰ø°
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d @/tmp/slack.json

          echo "‚úÖ Slack„Å∏„ÅÆÈÄÅ‰ø°ÊàêÂäü"
