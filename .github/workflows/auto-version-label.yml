name: Auto Version Label

on:
  pull_request:
    types: [opened, synchronize, edited]
    branches:
      - develop

jobs:
  auto-label:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR information
        id: pr-info
        run: |
          # PRã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã‚’å–å¾—
          echo "title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT

          # æœ¬æ–‡ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦ä¿å­˜
          body=$(cat <<'EOF'
          ${{ github.event.pull_request.body }}
          EOF
          )
          echo "body<<EOFMARKER" >> $GITHUB_OUTPUT
          echo "$body" >> $GITHUB_OUTPUT
          echo "EOFMARKER" >> $GITHUB_OUTPUT

      - name: Get changed files
        id: files
        run: |
          # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’å–å¾—
          files=$(git diff --name-only origin/develop...HEAD | head -20)
          echo "files<<EOFMARKER" >> $GITHUB_OUTPUT
          echo "$files" >> $GITHUB_OUTPUT
          echo "EOFMARKER" >> $GITHUB_OUTPUT

      - name: Analyze with AI
        id: analyze
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          script: |
            const https = require('https');

            const title = `${{ steps.pr-info.outputs.title }}`;
            const body = `${{ steps.pr-info.outputs.body }}`;
            const files = `${{ steps.files.outputs.files }}`;

            const prompt = `ä»¥ä¸‹ã®PRã‚’åˆ†æã—ã€é©åˆ‡ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«ã‚’åˆ¤å®šã—ã¦ãã ã•ã„ã€‚

## PRæƒ…å ±
**ã‚¿ã‚¤ãƒˆãƒ«**: ${title}

**æœ¬æ–‡**:
${body}

**å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«**:
${files}

## åˆ¤å®šåŸºæº–

### version:major
- ç ´å£Šçš„å¤‰æ›´ï¼ˆAPIã®ä»•æ§˜å¤‰æ›´ã€äº’æ›æ€§ã®ãªã„å¤‰æ›´ï¼‰
- ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å¤§å¹…ãªå¤‰æ›´

### version:minor
- **æ–°æ©Ÿèƒ½è¿½åŠ **ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¾¡å€¤ãŒã‚ã‚‹ï¼‰
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«èª¬æ˜ã—ã¦ä¾¡å€¤ãŒä¼ã‚ã‚‹å¤‰æ›´**
- ä¾‹: æ–°ã—ã„UIæ©Ÿèƒ½ã€åˆ†ææ©Ÿèƒ½ã®è¿½åŠ ã€ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã®æ”¹å–„

### version:patch
- **batch/ã®ã¿ã®å¤‰æ›´ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¾¡å€¤ãŒã‚ã‚‹å ´åˆ**
- ä¾‹: AIåˆ†æç²¾åº¦ã®å‘ä¸Šã€ãƒ‡ãƒ¼ã‚¿å–å¾—ã®ä¿¡é ¼æ€§å‘ä¸Š
- æ³¨æ„: å†…éƒ¨ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚„æŠ€è¡“çš„ãƒã‚°ä¿®æ­£ã¯å¯¾è±¡å¤–

### none
- å†…éƒ¨ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
- æŠ€è¡“çš„ãƒã‚°ä¿®æ­£ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¦‹ãˆãªã„ï¼‰
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¿®æ­£ã®ã¿
- ã‚³ãƒ¼ãƒ‰ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

## é‡è¦ãªåˆ¤æ–­åŸºæº–
ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã«èª¬æ˜ã—ã¦ä¾¡å€¤ãŒä¼ã‚ã‚‹ã‹ï¼Ÿã€ã§åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚
- âœ… ä¼ã‚ã‚‹ â†’ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«å¿…è¦
- âŒ ä¼ã‚ã‚‰ãªã„ â†’ none

## å›ç­”å½¢å¼
JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„:
{
  "label": "version:minor" | "version:major" | "version:patch" | "none",
  "reason": "åˆ¤å®šç†ç”±ï¼ˆæ—¥æœ¬èªã§ç°¡æ½”ã«ï¼‰",
  "user_value": "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¨ã£ã¦ã®ä¾¡å€¤ï¼ˆlabelãŒnoneã®å ´åˆã¯ç©ºæ–‡å­—ï¼‰"
}`;

            // OpenAI APIã‚’å‘¼ã³å‡ºã—
            const requestBody = JSON.stringify({
              model: 'gpt-4o-mini',
              messages: [
                {
                  role: 'system',
                  content: 'ã‚ãªãŸã¯ GitHub PR ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«ã‚’åˆ¤å®šã™ã‚‹å°‚é–€å®¶ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¾¡å€¤ã‚’é‡è¦–ã—ã¦åˆ¤å®šã—ã¦ãã ã•ã„ã€‚'
                },
                {
                  role: 'user',
                  content: prompt
                }
              ],
              response_format: { type: 'json_object' },
              temperature: 0.3
            });

            const response = await new Promise((resolve, reject) => {
              const req = https.request(
                {
                  hostname: 'api.openai.com',
                  port: 443,
                  path: '/v1/chat/completions',
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
                    'Content-Length': Buffer.byteLength(requestBody)
                  }
                },
                (res) => {
                  let data = '';
                  res.on('data', (chunk) => { data += chunk; });
                  res.on('end', () => {
                    try {
                      resolve(JSON.parse(data));
                    } catch (e) {
                      reject(e);
                    }
                  });
                }
              );
              req.on('error', reject);
              req.write(requestBody);
              req.end();
            });

            if (response.error) {
              throw new Error(`OpenAI API Error: ${response.error.message}`);
            }

            const result = JSON.parse(response.choices[0].message.content);

            core.setOutput('label', result.label);
            core.setOutput('reason', result.reason);
            core.setOutput('user_value', result.user_value || '');

            console.log('AIåˆ¤å®šçµæœ:', result);

      - name: Add version label
        if: steps.analyze.outputs.label != 'none'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const label = '${{ steps.analyze.outputs.label }}';

            // æ—¢å­˜ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«ã‚’å‰Šé™¤
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number
            });

            const versionLabels = currentLabels.filter(l => l.name.startsWith('version:'));
            for (const vl of versionLabels) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                name: vl.name
              });
            }

            // æ–°ã—ã„ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: [label]
            });

      - name: Post comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const label = '${{ steps.analyze.outputs.label }}';
            const reason = '${{ steps.analyze.outputs.reason }}';
            const userValue = '${{ steps.analyze.outputs.user_value }}';

            let emoji = 'ğŸ·ï¸';
            if (label === 'version:major') emoji = 'ğŸš¨';
            if (label === 'version:minor') emoji = 'âœ¨';
            if (label === 'version:patch') emoji = 'ğŸ”§';
            if (label === 'none') emoji = 'ğŸ“';

            let message = `${emoji} **AIãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«åˆ¤å®š**\n\n`;
            message += `**åˆ¤å®šçµæœ**: \`${label}\`\n\n`;
            message += `**ç†ç”±**: ${reason}\n`;

            if (userValue) {
              message += `\n**ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¾¡å€¤**: ${userValue}\n`;
            }

            if (label !== 'none') {
              message += `\n---\n`;
              message += `âš ï¸ **é‡è¦**: ã“ã®PRã«ã¯ \`${label}\` ãƒ©ãƒ™ãƒ«ãŒä»˜ä¸ã•ã‚Œã¾ã—ãŸã€‚\n\n`;
              message += `PRæœ¬æ–‡ã«ä»¥ä¸‹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼š\n\n`;
              message += '```markdown\n';
              message += '### ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®å¤‰æ›´\n';
              message += '- **æ©Ÿèƒ½å**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¨ã£ã¦ã®ä¾¡å€¤ã‚’èª¬æ˜ï¼ˆæŠ€è¡“çš„ãªè©³ç´°ã§ã¯ãªãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒªãƒƒãƒˆã‚’è¨˜è¼‰ï¼‰\n';
              message += '```\n';
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: message
            });
