# OpenAI API コスト管理

## 現在の使用状況

### モデル
- **gpt-4o-mini**
  - 入力: $0.150/1M tokens
  - 出力: $0.600/1M tokens

### 月間コスト（開発中）

#### 日次分析（主要15銘柄）
- 15銘柄 × 30日 × 0.3円 = **135円/月**

#### 開発・テスト
- 月50回程度の動作確認 × 0.15円 = **約7.5円/月**

**現在の合計: 約150円/月 ≈ $1/月**

---

## 将来の月間コスト試算

### 前提条件
- **1銘柄分析のコスト**: 約0.3円
- **1質問のコスト**: 約0.15円

### シナリオ1: 保守的（70人）

| 項目 | 計算 | コスト |
|------|------|--------|
| 全銘柄分析 | 4,000社 × 30日 × 0.3円 | 36,000円 |
| スタンダードプラン | 50人 × 50回/月 × 0.15円 | 375円 |
| デイトレーダープラン | 20人 × 100回/月 × 0.15円 | 300円 |
| **合計** | | **36,675円/月** |

**月間収益**: 149,000円
**利益率**: 75%

---

### シナリオ2: 中間（150人）

| 項目 | 計算 | コスト |
|------|------|--------|
| 全銘柄分析 | 4,000社 × 30日 × 0.3円 | 36,000円 |
| スタンダードプラン | 100人 × 50回/月 × 0.15円 | 750円 |
| デイトレーダープラン | 50人 × 100回/月 × 0.15円 | 750円 |
| **合計** | | **37,500円/月** |

**月間収益**: 473,000円
**利益率**: 92%

---

### シナリオ3: 楽観的（300人）

| 項目 | 計算 | コスト |
|------|------|--------|
| 全銘柄分析 | 4,000社 × 30日 × 0.3円 | 36,000円 |
| スタンダードプラン | 200人 × 50回/月 × 0.15円 | 1,500円 |
| デイトレーダープラン | 100人 × 100回/月 × 0.15円 | 1,500円 |
| **合計** | | **39,000円/月** |

**月間収益**: 1,196,000円
**利益率**: 97%

---

## アラート設定の推奨値

### フェーズ別の推奨設定

| フェーズ | 有料ユーザー数 | 推奨アラート | 根拠 |
|----------|----------------|--------------|------|
| **現在（開発中）** | 0人 | **$10/月** | 現在の使用量（$1/月）の10倍 |
| **Phase 1完了後** | 10-20人 | **$50/月** | 小規模運用の安全マージン |
| **Phase 2** | 50-100人 | **$150/月** | 本格運用の手前 |
| **Phase 2完了後** | 100人以上 | **$300/月** | 本格運用、収益確立 |
| **Phase 3** | 300人以上 | **$500/月** | スケール段階 |

### 現在の推奨設定

**$10/月**

**理由:**
- 現在の使用量（$1/月）の10倍で安全マージン
- 予期しないバグで大量リクエストが発生した場合に検知可能
- 有料ユーザーが増えたら段階的に引き上げ

---

## コスト最適化戦略

### 1. バッチ処理の最適化
- [ ] 日次分析を1日1回に制限
- [ ] キャッシュの活用（同じ質問への回答）
- [ ] 不要な銘柄の分析を停止

### 2. モデルの使い分け
- **gpt-4o-mini**: 基本的な分析、AIチャット
- **gpt-4o**: デイトレプラン限定の高度な分析（オプション）

### 3. トークン数の削減
- [ ] プロンプトの最適化
- [ ] 不要な情報の削除
- [ ] 出力長の制限

### 4. ユーザー制限の適切な設定
- 無料プラン: 月3回
- スタンダードプラン: 月50回
- デイトレーダープラン: 無制限（実質200回程度を想定）

---

## モニタリング

### 確認すべき指標

1. **日次コスト**
   - OpenAI Dashboardで毎日確認
   - 急激な増加がないかチェック

2. **ユーザーあたりのコスト**
   - 平均質問回数
   - 異常なユーザーの検出

3. **分析実行回数**
   - 日次分析の実行状況
   - 失敗・リトライの回数

### アラート条件

- **日次コスト > $1**: 開発中の異常検知
- **日次コスト > $10**: 本格運用時の異常検知
- **特定ユーザーの質問数 > 500回/月**: 不正利用の可能性

---

## 緊急時の対応

### コストが急増した場合

1. **即座にOpenAI APIキーを無効化**
   - 環境変数を削除
   - Vercel環境変数を削除

2. **原因調査**
   - CloudWatch Logsでリクエストログを確認
   - どの機能が大量リクエストを送っているか特定

3. **修正・再開**
   - バグ修正
   - レート制限の実装
   - APIキーを再発行

### 予防策

- [ ] レート制限の実装（ユーザーごと、IP ごと）
- [ ] リクエストログの記録
- [ ] 異常検知システムの構築

---

## 参考資料

- [OpenAI Pricing](https://openai.com/api/pricing/)
- [Usage Dashboard](https://platform.openai.com/usage)
- `/docs/pricing_plan.md` - サービス全体の収益・コスト試算
