# バッチ処理

毎日の株式分析を自動実行するPythonスクリプトです。

## 機能

- Yahoo Financeから30銘柄（日本株15、米国株15）の株価データを取得
- OpenAI GPT-4o-miniで投資分析を実行
- PostgreSQLデータベースに分析結果を保存
- 同日の分析データが存在する場合は自動スキップ

## 実行方法

### ローカル実行

```bash
# 依存関係をインストール
pip install -r requirements.txt

# 環境変数を設定（.envファイル）
DATABASE_URL="postgresql://..."
OPENAI_API_KEY="sk-proj-..."

# バッチ実行
python batch_analysis.py
```

### GitHub Actions（本番）

- 自動実行: 毎日 UTC 0:00（日本時間 9:00）
- 手動実行: GitHubのActionsタブから実行可能

## パフォーマンス

- **初回実行**: 約37秒（全銘柄分析）
- **2回目以降**: 約2.5秒（スキップ）
- **API費用**: 約¥0.61/日（初回のみ）

## 出力ログ例

```
🚀 AI株式分析バッチジョブ開始 (Python + yfinance)
⏰ 開始時刻: 2026-01-09 01:14:18
🔄 並列処理: 5ワーカー

🔄 7203: 処理開始...
✅ 7203: Buy (85%) 完了

⏭️  AAPL: 本日分の分析済み（スキップ）

✅ バッチジョブ完了
⏱️  処理時間: 37.02秒
📊 結果サマリー:
   - 対象銘柄数: 30
   - 成功: 29
   - 失敗: 1

💰 OpenAI API使用量サマリー
🔢 総リクエスト数: 29
💰 総費用: $0.0041 (約¥0.61)
```

## 技術仕様

- **言語**: Python 3.11
- **並列処理**: ThreadPoolExecutor（5ワーカー）
- **リトライ**: OpenAI APIエラー時に最大3回試行
- **スレッドセーフ**: 全ての共有リソースにロック機構
