// Prismaスキーマ定義
// AI株式分析ツールのデータモデル (PostgreSQL版)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 銘柄データモデル
model Stock {
  // 主キー - UUID
  id     String @id @default(uuid())

  // ティッカーシンボル（ユニーク制約）
  ticker String @unique

  // 基本情報
  name   String
  market String // 'JP' または 'US'
  sector String?
  industry String? // 業種（セクターより詳細）

  // AI分析対象フラグ
  isAiAnalysisTarget Boolean @default(false) @map("is_ai_analysis_target")

  // 財務指標
  marketCap Decimal? @map("market_cap") // 時価総額

  // タイムスタンプ
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // リレーション
  analyses        Analysis[]
  priceHistory    PriceHistory[]
  analysisRequest AnalysisRequest?
  holdings        Holding[]
  actionProposals ActionProposal[]

  // インデックス
  @@index([market])
  @@index([sector])
  @@index([isAiAnalysisTarget])
  @@map("stocks")
}

// AI分析結果モデル
model Analysis {
  // 主キー
  id String @id @default(uuid())

  // 外部キー - Stock
  stockId String @map("stock_id")
  stock   Stock  @relation(fields: [stockId], references: [id], onDelete: Cascade)

  // 分析日時
  analysisDate DateTime @default(now()) @map("analysis_date")

  // AI推奨
  recommendation  String // 'Buy', 'Sell', 'Hold'
  confidenceScore Int @map("confidence_score") // 0-100

  // 推奨理由
  reason String // 推奨理由（300文字程度）

  // 分析時の株価・財務指標
  currentPrice  Float? @map("current_price")
  peRatio       Float? @map("pe_ratio")
  pbRatio       Float? @map("pb_ratio")
  roe           Float?
  dividendYield Float? @map("dividend_yield")

  // セクター比較データ（JSON形式）
  sectorComparison Json? @map("sector_comparison")

  // タイムスタンプ
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // インデックス
  @@index([stockId, analysisDate])
  @@index([analysisDate])
  @@index([recommendation])
  @@map("analyses")
}

// 株価履歴モデル
model PriceHistory {
  // 主キー
  id String @id @default(uuid())

  // 外部キー - Stock
  stockId String @map("stock_id")
  stock   Stock  @relation(fields: [stockId], references: [id], onDelete: Cascade)

  // 日付と株価データ
  date   DateTime
  open   Float
  high   Float
  low    Float
  close  Float
  volume Int

  // タイムスタンプ
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // ユニーク制約とインデックス
  @@unique([stockId, date])
  @@index([stockId, date])
  @@map("price_history")
}

// バッチジョブログモデル
model BatchJobLog {
  // 主キー
  id String @id @default(uuid())

  // ジョブ情報
  jobDate      DateTime @map("job_date")
  status       String // 'success', 'partial_success', 'failure'
  totalStocks  Int @map("total_stocks")
  successCount Int @map("success_count")
  failureCount Int @map("failure_count")
  errorMessage String? @map("error_message")
  duration     Int // ミリ秒

  // タイムスタンプ
  createdAt DateTime @default(now()) @map("created_at")

  // インデックス
  @@index([jobDate])
  @@map("batch_job_logs")
}

// プッシュ通知購読モデル
model PushSubscription {
  // 主キー
  id String @id @default(uuid())

  // プッシュ通知購読情報
  endpoint String @unique
  p256dh   String // 公開鍵（暗号化用）
  auth     String // 認証シークレット

  // タイムスタンプ
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // インデックス
  @@index([endpoint])
  @@map("push_subscriptions")
}

// 分析リクエストモデル
model AnalysisRequest {
  // 主キー
  id String @id @default(uuid())

  // 外部キー - Stock
  stockId String @map("stock_id")
  stock   Stock  @relation(fields: [stockId], references: [id], onDelete: Cascade)

  // リクエスト数
  requestCount Int @default(1) @map("request_count")

  // タイムスタンプ
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // ユニーク制約とインデックス
  @@unique([stockId])
  @@index([stockId])
  @@index([requestCount])
  @@map("analysis_requests")
}

// ユーザーモデル（NextAuth.js用）
model User {
  // 主キー
  id String @id @default(uuid())

  // 基本情報
  name          String?
  email         String?   @unique
  emailVerified DateTime? @map("email_verified")
  image         String?

  // プランタイプ
  plan String @default("free") // 'free' | 'premium'

  // タイムスタンプ
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // リレーション
  accounts        Account[]
  portfolio       Portfolio?
  actionProposals ActionProposal[]

  @@map("users")
}

// アカウントモデル（NextAuth.js用 - OAuth情報）
model Account {
  // 主キー
  id String @id @default(uuid())

  // 外部キー - User
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // OAuth情報
  type              String
  provider          String
  providerAccountId String @map("provider_account_id")
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  // タイムスタンプ
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // ユニーク制約とインデックス
  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

// ポートフォリオモデル
model Portfolio {
  // 主キー
  id String @id @default(uuid())

  // 外部キー - User
  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 投資予算（円）
  investmentBudget Int @map("investment_budget")

  // タイムスタンプ
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // リレーション
  holdings Holding[]

  @@index([userId])
  @@map("portfolios")
}

// 保有銘柄モデル
model Holding {
  // 主キー
  id String @id @default(uuid())

  // 外部キー - Portfolio
  portfolioId String @map("portfolio_id")
  portfolio   Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  // 外部キー - Stock
  stockId String @map("stock_id")
  stock   Stock  @relation(fields: [stockId], references: [id], onDelete: Cascade)

  // 保有情報
  shares        Int      // 保有株数
  purchasePrice Decimal  @map("purchase_price") // 購入単価
  purchaseDate  DateTime @map("purchase_date") // 購入日

  // 売却情報（nullなら保有中）
  soldDate  DateTime? @map("sold_date") // 売却日
  soldPrice Decimal?  @map("sold_price") // 売却単価

  // タイムスタンプ
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([portfolioId])
  @@index([stockId])
  @@index([purchaseDate])
  @@map("holdings")
}

// アクション提案モデル
model ActionProposal {
  // 主キー
  id String @id @default(uuid())

  // 外部キー - User
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 外部キー - Stock
  stockId String @map("stock_id")
  stock   Stock  @relation(fields: [stockId], references: [id], onDelete: Cascade)

  // アクション情報
  actionType String // 'SELL', 'BUY', 'HOLD_ALERT'
  reason     String // 提案理由
  confidence Int // 確信度 0-100

  // 既読フラグ
  isRead Boolean @default(false) @map("is_read")

  // タイムスタンプ
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([stockId])
  @@index([createdAt])
  @@index([isRead])
  @@map("action_proposals")
}
