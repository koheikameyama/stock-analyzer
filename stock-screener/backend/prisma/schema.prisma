// Prismaスキーマ定義
// AI株式分析ツールのデータモデル

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 銘柄データモデル
model Stock {
  // 主キー - UUID
  id     String @id @default(uuid()) @db.Uuid

  // ティッカーシンボル（ユニーク制約）
  ticker String @unique @db.VarChar(20)

  // 基本情報
  name   String @db.VarChar(200)
  market String @db.VarChar(2) // 'JP' または 'US'
  sector String? @db.VarChar(100)

  // タイムスタンプ
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // リレーション
  analyses     Analysis[]
  priceHistory PriceHistory[]

  // インデックス
  @@index([market])
  @@index([sector])
  @@map("stocks")
}

// AI分析結果モデル
model Analysis {
  // 主キー
  id String @id @default(uuid()) @db.Uuid

  // 外部キー - Stock
  stockId String @db.Uuid
  stock   Stock  @relation(fields: [stockId], references: [id], onDelete: Cascade)

  // 分析日時
  analysisDate DateTime @default(now())

  // AI推奨
  recommendation  String @db.VarChar(20) // 'Buy', 'Sell', 'Hold'
  confidenceScore Int // 0-100

  // 推奨理由
  reasonShort    String @db.Text // 短文（100-200文字）
  reasonDetailed String @db.Text // 詳細（500-1000文字）

  // 分析時の株価・財務指標
  currentPrice  Decimal? @db.Decimal(20, 4)
  peRatio       Decimal? @db.Decimal(10, 2)
  pbRatio       Decimal? @db.Decimal(10, 2)
  roe           Decimal? @db.Decimal(10, 2)
  dividendYield Decimal? @db.Decimal(10, 2)

  // タイムスタンプ
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // インデックス
  @@index([stockId, analysisDate])
  @@index([analysisDate])
  @@index([recommendation])
  @@map("analyses")
}

// 株価履歴モデル
model PriceHistory {
  // 主キー
  id String @id @default(uuid()) @db.Uuid

  // 外部キー - Stock
  stockId String @db.Uuid
  stock   Stock  @relation(fields: [stockId], references: [id], onDelete: Cascade)

  // 日付と株価データ
  date   DateTime
  open   Decimal  @db.Decimal(20, 4)
  high   Decimal  @db.Decimal(20, 4)
  low    Decimal  @db.Decimal(20, 4)
  close  Decimal  @db.Decimal(20, 4)
  volume BigInt

  // タイムスタンプ
  createdAt DateTime @default(now())

  // ユニーク制約とインデックス
  @@unique([stockId, date])
  @@index([stockId, date])
  @@map("price_history")
}

// バッチジョブログモデル
model BatchJobLog {
  // 主キー
  id String @id @default(uuid()) @db.Uuid

  // ジョブ情報
  jobDate      DateTime
  status       String  @db.VarChar(20) // 'success', 'partial_success', 'failure'
  totalStocks  Int
  successCount Int
  failureCount Int
  errorMessage String? @db.Text
  duration     Int // ミリ秒

  // タイムスタンプ
  createdAt DateTime @default(now())

  // インデックス
  @@index([jobDate])
  @@map("batch_job_logs")
}
