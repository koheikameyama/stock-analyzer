# 仕様書: AI株式分析ツール

## ゴール
OpenAI GPT-4o miniを活用し、日本株・米国株を毎朝自動分析して、買い/売り/ホールド推奨と詳細な理由を提供する、初心者投資家向けの株式分析ツールを構築する。

## ユーザーストーリー
- 投資初心者として、AIが分析したおすすめ銘柄を一目で確認し、どの銘柄を買うべきか判断材料を得たい
- 投資家として、過去の分析履歴を振り返り、AIの推奨がどのように変化したかを確認したい

## 具体的な要件

### 1. AI分析エンジン統合
- OpenAI GPT-4o mini APIを使用して株式銘柄を総合的に分析
- 財務指標（PER、PBR、ROE、配当利回り）、セクター情報、過去30日間の株価トレンドを入力データとして使用
- 推奨アクション（Buy/Sell/Hold）、信頼度スコア（0-100%）、短い理由（100-200文字）、詳細解説（500-1000文字）をJSON形式で出力
- プロンプト設計は株式アナリストの視点で一貫性のある分析を提供
- エラー時のリトライロジック（最大3回、指数バックオフ）を実装
- APIタイムアウトは30秒に設定
- レート制限を考慮した順次処理または制限付き並列処理（p-limitライブラリ使用）

### 2. バッチ処理システム
- node-cronを使用して毎朝7:00 AM（JST）に自動実行（月〜金のみ）
- 対象銘柄リストをデータベースから取得し、Yahoo Finance API経由で最新データを並列取得
- 各銘柄のAI分析を実行し、結果をデータベースに保存（トランザクション使用）
- バッチジョブのステータス（成功/失敗/部分成功）、処理時間、エラーメッセージをBatchJobLogテーブルに記録
- Yahoo Finance APIからのデータ取得はPromise.allで並列処理、OpenAI API呼び出しはレート制限を考慮
- バッチ処理の成功率95%以上を目標とする

### 3. フロントエンド表示機能
- メイン画面：日本株/米国株の市場選択タブ、最新分析結果のテーブル表示、推奨アクションでのフィルター機能
- データテーブル：ティッカー、銘柄名、現在株価、推奨、信頼度、理由（短文）、詳細表示ボタンの各カラムを表示
- 各カラムでのソート機能（昇順/降順）を実装
- 推奨アクション（Buy/Sell/Hold）でのフィルター機能
- 詳細モーダル：クリック時に詳細解説と過去30日の株価トレンドグラフを表示
- レスポンシブデザイン：デスクトップはフルテーブル、タブレットは一部カラム折りたたみ、モバイルはカード形式
- 最終更新日時をヘッダーに表示

### 4. 過去履歴閲覧機能
- カレンダーまたはドロップダウンで過去の日付（過去30日分）を選択可能
- 選択した日付の分析結果をメインテーブルと同じフォーマットで表示
- 日付選択時にAPIから該当日のデータを取得し、ローディング状態を表示
- 日付が選択されていない場合は最新データを表示

### 5. データモデル設計
- Stockテーブル：銘柄の基本情報（ticker、name、market、sector）を管理、UUIDを主キーとして使用
- Analysisテーブル：分析結果（推奨、信頼度、理由、財務指標、analysisDate）を保存、stockIdとanalysisDatでインデックス
- PriceHistoryテーブル：過去の株価データ（date、open、high、low、close、volume）を保存、stockIdとdateのユニーク制約
- BatchJobLogテーブル：バッチジョブの実行ログ（jobDate、status、成功/失敗数、エラーメッセージ、処理時間）を記録
- すべてのテーブルでcreatedAt、updatedAtのタイムスタンプを管理

### 6. API設計
- GET /api/analyses/latest：最新分析結果を取得（market、recommendationでフィルター可能）
- GET /api/analyses/history：指定日付の分析結果を取得（date必須、market任意）
- GET /api/analyses/:id：特定分析の詳細情報と株価履歴を取得
- GET /api/stocks：銘柄リスト取得（管理用）
- GET /api/batch-jobs/status：最新バッチジョブの実行状態を取得
- すべてのレスポンスは統一されたJSON形式（success、data、message）
- エラーハンドリングミドルウェアで一貫したエラーレスポンスを返す

### 7. UI/UXデザイン
- カラーパレット：プライマリ（ダークブルー #1E3A8A）、背景（ライトグレー #F3F4F6）、Buy（緑 #10B981）、Sell（赤 #EF4444）、Hold（グレー #6B7280）
- タイポグラフィ：システムフォント（Inter/Robotoフォールバック）、ヘッダー24-32px、本文14-16px
- スペーシング：コンポーネント間16-24px、セクション間32-48px
- UI要素：角丸4-8px、subtleシャドウ、ホバーエフェクト、ゼブラストライプテーブル
- アクセシビリティ：ARIA属性、キーボードナビゲーション、WCAG AAコントラスト比準拠
- ローディング状態とエラーメッセージの明確な表示

### 8. エラーハンドリング
- バッチ処理エラー：BatchJobLogテーブルに記録し、フロントエンドには「AI分析に失敗しました」とエラーメッセージ表示
- データ取得エラー：「データ取得に失敗しました。しばらくしてから再度お試しください」を表示
- API通信エラー：ネットワークエラー、タイムアウト、サーバーエラーを適切にハンドリング
- フロントエンドでのエラー表示は赤色の背景ボックスで目立つように表示

## ビジュアルデザイン
ビジュアルアセットは提供されていません。以下のデザインガイドラインに従ってモダンでクリーンなUIを実装してください：

- ミニマルで直感的なインターフェース
- データ密度の高い見やすいテーブルレイアウト
- 明確な視覚的階層（ヘッダー > タブ > テーブル > フッター）
- 推奨アクションに応じた色分け（Buy=緑、Sell=赤、Hold=グレー）
- 信頼度スコアの視覚化（プログレスバーまたはバッジ）
- カードベースのレイアウトで情報を整理
- ホバー時のインタラクティブなフィードバック

## 既存コードの活用

### React + TypeScript フロントエンド構造
- App.tsxの基本構造（状態管理、データフェッチング、エラーハンドリング）を参考にする
- TabSwitchコンポーネントを市場選択タブに再利用
- DataTableコンポーネントのソート機能とテーブルレイアウトを拡張して使用
- LoadingSpinnerコンポーネントをローディング状態の表示に再利用
- Paginationコンポーネントの構造を履歴閲覧機能に応用

### APIサービスパターン
- ApiServiceクラスの構造（axios設定、エラーハンドリング、型定義）を踏襲
- handleErrorメソッドのエラーハンドリングロジックを再利用
- 環境変数でのAPI URL管理パターンを継承

### バックエンドアーキテクチャ
- Express + TypeScriptの基本構造を維持
- Prisma ORMを使用したデータベース操作パターンを踏襲
- yahoo-finance2ライブラリを使用した株価データ取得ロジックを拡張
- express-rate-limitでのレート制限設定を適用

### データベーススキーマパターン
- 既存のStockモデルの構造（ticker主キー、market、sector、財務指標）を拡張
- インデックス設計パターン（market、sector、各財務指標）を継承
- タイムスタンプ管理（createdAt、updatedAt）を統一

### スタイリングとUI
- Tailwind CSSのユーティリティクラスパターンを継承
- 既存の色設計（blue-600、gray-50など）と統一感を持たせる
- レスポンシブデザインのブレークポイント（sm:、md:、lg:）を踏襲

## スコープ外
- ユーザー認証・ログイン機能（将来的に検討）
- ポートフォリオ管理機能（保有銘柄の追跡）
- リアルタイムアラート通知機能（メール、Slack、プッシュ通知）
- 個別銘柄の詳細ページ（財務諸表、企業情報の詳細表示）
- SNSシェア機能（Twitter、Facebookでの共有）
- ユーザーコメント・レビュー機能
- カスタムアラート設定（価格アラート、推奨変更通知）
- バックテスト機能（過去の推奨の検証）
- リアルタイム株価更新（バッチ処理のみで対応）
- 複数日付の比較表示機能（現時点では単一日付のみ閲覧可能）
